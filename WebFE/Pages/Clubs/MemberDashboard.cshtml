@page "{id:int}"
@model WebFE.Pages.Clubs.MemberDashboardModel
@{
    Layout = null;
    ViewData["Title"] = $"{Model.Club?.Name} - Member Dashboard";
    var section = Model.Section ?? "overview";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/eduxtend.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/admin-dashboard.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/WebFE.styles.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="~/lib/lucide/lucide.min.js"></script>
</head>
<body class="admin-body">
    <!-- Sidebar -->
    <div class="admin-sidebar" id="adminSidebar">
        <div class="sidebar-header">
            <div class="d-flex align-items-center gap-2">
                <div class="sidebar-logo" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                    E
                </div>
                <div class="sidebar-title">
                    <div class="sidebar-brand">EduXtend</div>
                    <div class="sidebar-subtitle">@(Model.Club?.Name ?? "Club")</div>
                </div>
            </div>
            <button class="sidebar-toggle d-lg-none" onclick="toggleSidebar()">
                <i data-lucide="x" style="width: 20px; height: 20px;"></i>
            </button>
        </div>
        
        <div class="sidebar-content">
            <nav class="sidebar-nav">
                <div class="sidebar-section">
                    <div class="sidebar-section-title">OVERVIEW</div>
                    <a class="sidebar-link @(section == "overview" ? "active" : "")" href="/Clubs/MemberDashboard/@Model.Id?section=overview">
                        <i data-lucide="layout-dashboard" style="width: 20px; height: 20px;"></i>
                        <span>Dashboard</span>
                    </a>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-section-title">CLUB INFO</div>
                    <a class="sidebar-link @(section == "members" ? "active" : "")" href="/Clubs/MemberDashboard/@Model.Id?section=members">
                        <i data-lucide="users" style="width: 20px; height: 20px;"></i>
                        <span>Members</span>
                        <span class="badge bg-primary ms-auto">@Model.Members.Count</span>
                    </a>
                    <a class="sidebar-link @(section == "departments" ? "active" : "")" href="/Clubs/MemberDashboard/@Model.Id?section=departments">
                        <i data-lucide="folder" style="width: 20px; height: 20px;"></i>
                        <span>Departments</span>
                        <span class="badge bg-primary ms-auto">@Model.Departments.Count</span>
                    </a>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-section-title">ACTIVITIES</div>
                    <a class="sidebar-link @(section == "activities" ? "active" : "")" href="/Clubs/MemberDashboard/@Model.Id?section=activities">
                        <i data-lucide="calendar" style="width: 20px; height: 20px;"></i>
                        <span>All Activities</span>
                        <span class="badge bg-success ms-auto">@Model.Activities.Count</span>
                    </a>
                    <a class="sidebar-link @(section == "awards" ? "active" : "")" href="/Clubs/MemberDashboard/@Model.Id?section=awards">
                        <i data-lucide="trophy" style="width: 20px; height: 20px;"></i>
                        <span>Awards</span>
                        <span class="badge bg-warning text-dark ms-auto">@Model.Awards.Count</span>
                    </a>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-section-title">MORE</div>
                    <a class="sidebar-link @(section == "finance" ? "active" : "")" href="/Clubs/MemberDashboard/@Model.Id?section=finance">
                        <i data-lucide="dollar-sign" style="width: 20px; height: 20px;"></i>
                        <span>Finance</span>
                    </a>
                    <a class="sidebar-link @(section == "score" ? "active" : "")" href="/Clubs/MemberDashboard/@Model.Id?section=score">
                        <i data-lucide="bar-chart-2" style="width: 20px; height: 20px;"></i>
                        <span>Club Score</span>
                    </a>
                    <a class="sidebar-link @(section == "proposals" ? "active" : "")" href="/Clubs/MemberDashboard/@Model.Id?section=proposals">
                        <i data-lucide="lightbulb" style="width: 20px; height: 20px;"></i>
                        <span>Proposals</span>
                        <span class="badge bg-primary ms-auto">@Model.Proposals.Count</span>
                    </a>
                </div>
            </nav>
        </div>
        
        <div class="sidebar-footer">
            <a class="sidebar-link" href="/">
                <i data-lucide="home" style="width: 20px; height: 20px;"></i>
                <span>Back to Home</span>
            </a>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="admin-main">
        <!-- Top Header -->
        <header class="admin-header">
            <div class="admin-header-left">
                <button class="sidebar-toggle-btn d-lg-none" onclick="toggleSidebar()">
                    <i data-lucide="menu" style="width: 24px; height: 24px;"></i>
                </button>
                <button class="sidebar-toggle-btn d-none d-lg-flex" onclick="toggleSidebarCollapse()">
                    <i data-lucide="panel-left" style="width: 20px; height: 20px;"></i>
                </button>
                <div class="admin-breadcrumb">
                    <span class="breadcrumb-item">@(Model.Club?.Name ?? "Club")</span>
                    @if (section != "overview")
                    {
                        <i data-lucide="chevron-right" style="width: 16px; height: 16px;"></i>
                        <span class="breadcrumb-item active">
                            @switch (section)
                            {
                                case "members": <text>Members</text>; break;
                                case "departments": <text>Departments</text>; break;
                                case "activities": <text>Activities</text>; break;
                                case "awards": <text>Awards</text>; break;
                                case "finance": <text>Finance</text>; break;
                                case "score": <text>Club Score</text>; break;
                                case "score-detail": <text>Score Details</text>; break;
                                case "proposals": <text>Proposals</text>; break;
                            }
                        </span>
                    }
                </div>
            </div>
            
            <div class="admin-header-right">
                <!-- Notification Bell -->
                <div class="header-icon-btn" onclick="toggleNotificationCenter()">
                    <i data-lucide="bell" style="width: 20px; height: 20px;"></i>
                    <div class="notification-badge"></div>
                </div>
                
                <!-- User Menu -->
                <div class="dropdown">
                    <button class="user-menu-btn" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <img id="memberDashboardUserAvatar" src="" alt="Avatar" class="user-avatar" />
                        <div class="user-info d-none d-md-block">
                            <div class="user-name" id="memberDashboardUserName">@User.Identity?.Name</div>
                            <div class="user-role">Member</div>
                        </div>
                        <i data-lucide="chevron-down" style="width: 16px; height: 16px;"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end admin-dropdown-menu" aria-labelledby="userDropdown">
                        <li>
                            <a class="dropdown-item" href="/Profile">
                                <i data-lucide="user" style="width: 16px; height: 16px;"></i>
                                <span>Profile</span>
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="/Settings">
                                <i data-lucide="settings" style="width: 16px; height: 16px;"></i>
                                <span>Settings</span>
                            </a>
                        </li>
                        <li><hr class="dropdown-divider" /></li>
                        <li>
                            <a class="dropdown-item text-danger" href="#" onclick="logout(); return false;">
                                <i data-lucide="log-out" style="width: 16px; height: 16px;"></i>
                                <span>Logout</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <div class="admin-content">
            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show">
                    <i class="bi bi-exclamation-triangle-fill"></i> @TempData["ErrorMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @switch (section)
            {
                case "overview":
                    <!-- Dashboard Overview -->
                    <div class="row g-4 mb-4">
                        <div class="col-md-3">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <p class="text-muted small mb-1">Members</p>
                                            <h3 class="mb-0">@Model.Club?.MemberCount</h3>
                                        </div>
                                        <div class="p-2 bg-primary bg-opacity-10 rounded">
                                            <i data-lucide="users" style="width: 24px; height: 24px; color: var(--bs-primary);"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <p class="text-muted small mb-1">Activities</p>
                                            <h3 class="mb-0">@Model.Club?.ActivityCount</h3>
                                        </div>
                                        <div class="p-2 bg-success bg-opacity-10 rounded">
                                            <i data-lucide="calendar" style="width: 24px; height: 24px; color: var(--bs-success);"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <p class="text-muted small mb-1">Departments</p>
                                            <h3 class="mb-0">@Model.Club?.DepartmentCount</h3>
                                        </div>
                                        <div class="p-2 bg-warning bg-opacity-10 rounded">
                                            <i data-lucide="folder" style="width: 24px; height: 24px; color: var(--bs-warning);"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <p class="text-muted small mb-1">Awards</p>
                                            <h3 class="mb-0">@Model.Club?.AwardCount</h3>
                                        </div>
                                        <div class="p-2 bg-info bg-opacity-10 rounded">
                                            <i data-lucide="trophy" style="width: 24px; height: 24px; color: var(--bs-info);"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Club Info Card -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <img src="@(Model.Club?.LogoUrl ?? "/img/club-placeholder.png")" 
                                         alt="@Model.Club?.Name" 
                                         class="img-fluid rounded shadow-sm"
                                         style="width: 100%; height: 200px; object-fit: cover;" />
                                </div>
                                <div class="col-md-9">
                                    <h4 class="fw-bold mb-2">@Model.Club?.Name</h4>
                                    <p class="text-muted mb-3">@Model.Club?.SubName</p>
                                    <p class="mb-3">@Model.Club?.Description</p>
                                    <div class="d-flex gap-3 flex-wrap">
                                        <span class="badge bg-primary px-3 py-2">@Model.Club?.CategoryName</span>
                                        <span class="badge @(Model.Club?.IsActive == true ? "bg-success" : "bg-secondary") px-3 py-2">
                                            @(Model.Club?.IsActive == true ? "Active" : "Inactive")
                                        </span>
                                        <span class="badge @(Model.Club?.IsRecruitmentOpen == true ? "bg-success" : "bg-secondary") px-3 py-2">
                                            @(Model.Club?.IsRecruitmentOpen == true ? "Recruiting" : "Recruitment Closed")
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Links -->
                    <div class="row g-3">
                        <div class="col-md-3">
                            <a href="/Clubs/MemberDashboard/@Model.Id?section=members" class="card border-0 shadow-sm text-decoration-none hover-lift">
                                <div class="card-body text-center">
                                    <i data-lucide="users" style="width: 48px; height: 48px; color: var(--bs-primary);"></i>
                                    <h6 class="mt-3 mb-0">Members</h6>
                                    <p class="text-muted small">@Model.Members.Count members</p>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="/Clubs/MemberDashboard/@Model.Id?section=activities" class="card border-0 shadow-sm text-decoration-none hover-lift">
                                <div class="card-body text-center">
                                    <i data-lucide="calendar" style="width: 48px; height: 48px; color: var(--bs-success);"></i>
                                    <h6 class="mt-3 mb-0">Activities</h6>
                                    <p class="text-muted small">@Model.Activities.Count activities</p>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="/Clubs/MemberDashboard/@Model.Id?section=departments" class="card border-0 shadow-sm text-decoration-none hover-lift">
                                <div class="card-body text-center">
                                    <i data-lucide="folder" style="width: 48px; height: 48px; color: var(--bs-info);"></i>
                                    <h6 class="mt-3 mb-0">Departments</h6>
                                    <p class="text-muted small">@Model.Departments.Count departments</p>
                                </div>
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="/Clubs/MemberDashboard/@Model.Id?section=awards" class="card border-0 shadow-sm text-decoration-none hover-lift">
                                <div class="card-body text-center">
                                    <i data-lucide="trophy" style="width: 48px; height: 48px; color: var(--bs-warning);"></i>
                                    <h6 class="mt-3 mb-0">Awards</h6>
                                    <p class="text-muted small">@Model.Awards.Count awards</p>
                                </div>
                            </a>
                        </div>
                    </div>
                    break;

                case "members":
                    <!-- Members List -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">
                                <i data-lucide="users" style="width: 20px; height: 20px;"></i>
                                Club Members (@Model.Members.Count)
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            @if (Model.Members.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Member</th>
                                                <th>Student Code</th>
                                                <th>Email</th>
                                                <th>Role</th>
                                                <th>Department</th>
                                                <th>Joined</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var member in Model.Members)
                                            {
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center gap-2">
                                                            <img src="@(string.IsNullOrEmpty(member.AvatarUrl) ? "/img/default-avatar.png" : member.AvatarUrl)" 
                                                                 alt="@member.StudentName" 
                                                                 style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;" />
                                                            <strong>@member.StudentName</strong>
                                                        </div>
                                                    </td>
                                                    <td>@member.StudentCode</td>
                                                    <td class="small">@member.Email</td>
                                                    <td>
                                                        <span class="badge bg-@(member.RoleInClub == "President" ? "danger" : member.RoleInClub == "VicePresident" ? "warning" : "secondary")">
                                                            @member.RoleInClub
                                                        </span>
                                                    </td>
                                                    <td>@(member.DepartmentName ?? "â€”")</td>
                                                    <td class="small">@member.JoinedAt.ToString("dd MMM yyyy")</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-5 text-muted">
                                    <i data-lucide="users" style="width: 48px; height: 48px; opacity: 0.3;"></i>
                                    <p class="mt-2">No members found</p>
                                </div>
                            }
                        </div>
                    </div>
                    break;

                case "departments":
                    <!-- Departments -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">
                                <i data-lucide="folder" style="width: 20px; height: 20px;"></i>
                                Departments (@Model.Departments.Count)
                            </h5>
                        </div>
                        <div class="card-body">
                            @if (Model.Departments.Any())
                            {
                                <div class="row g-3">
                                    @foreach (var dept in Model.Departments)
                                    {
                                        <div class="col-md-6 col-lg-4">
                                            <div class="card border h-100">
                                                <div class="card-body">
                                                    <h6 class="fw-bold">
                                                        <i data-lucide="folder" style="width: 18px; height: 18px;"></i>
                                                        @dept.Name
                                                    </h6>
                                                    @if (!string.IsNullOrWhiteSpace(dept.Description))
                                                    {
                                                        <p class="small text-muted mb-2">@dept.Description</p>
                                                    }
                                                    <span class="badge bg-primary">
                                                        <i data-lucide="users" style="width: 14px; height: 14px;"></i>
                                                        @dept.MemberCount members
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-4 text-muted">
                                    <i data-lucide="folder" style="width: 48px; height: 48px; opacity: 0.3;"></i>
                                    <p class="mt-2">No departments yet</p>
                                </div>
                            }
                        </div>
                    </div>
                    break;

                case "activities":
                    <!-- Activities -->
                    <div class="mb-3">
                        <h5 class="text-muted">
                            <i class="bi bi-calendar-event"></i> Found <strong>@Model.TotalActivities</strong> 
                            activit@(Model.TotalActivities != 1 ? "ies" : "y")
                            @if (Model.TotalPages > 1)
                            {
                                <span> - Page @Model.CurrentPage of @Model.TotalPages</span>
                            }
                        </h5>
                    </div>

                    <div class="row g-4">
                        @if (Model.Activities.Any())
                        {
                            foreach (var activity in Model.Activities)
                            {
                                var statusBadgeClass = activity.Status switch
                                {
                                    "Approved" => "bg-success",
                                    "PendingApproval" => "bg-warning text-dark",
                                    "Completed" => "bg-secondary",
                                    "Rejected" => "bg-danger",
                                    _ => "bg-secondary"
                                };

                                var now = DateTime.Now;
                                var isEnded = activity.EndTime < now;
                                var isOngoing = activity.StartTime <= now && now <= activity.EndTime;

                                <div class="col-12 col-md-6 col-lg-4">
                                    <div class="card h-100 shadow-sm border-0 @(isEnded ? "opacity-75" : "")">
                                        <!-- Activity Image -->
                                        @if (!string.IsNullOrWhiteSpace(activity.ImageUrl))
                                        {
                                            <img src="@activity.ImageUrl" 
                                                 class="card-img-top" 
                                                 style="height: 200px; object-fit: cover;"
                                                 alt="@activity.Title"
                                                 onerror="this.style.display='none'">
                                        }
                                        else
                                        {
                                            <div class="card-img-top bg-gradient-primary d-flex align-items-center justify-content-center" 
                                                 style="height: 200px;">
                                                <i class="bi bi-calendar-event text-white" style="font-size: 3rem;"></i>
                                            </div>
                                        }
                                        
                                        <!-- Activity Header -->
                                        <div class="card-header bg-white border-0 pt-3">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <span class="badge @statusBadgeClass">@activity.Status</span>
                                                <span class="badge bg-info">@activity.Type</span>
                                            </div>
                                            
                                            @if (!activity.IsPublic)
                                            {
                                                <div class="mb-2">
                                                    <span class="badge bg-warning text-dark">
                                                        <i class="bi bi-lock"></i> Members Only
                                                    </span>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="mb-2">
                                                    <span class="badge bg-primary">
                                                        <i class="bi bi-globe"></i> Public
                                                    </span>
                                                </div>
                                            }

                                            <h5 class="card-title fw-bold mb-2">@activity.Title</h5>
                                            
                                            @if (!string.IsNullOrWhiteSpace(activity.ClubName))
                                            {
                                                <p class="text-muted small mb-0">
                                                    <i class="bi bi-people"></i> @activity.ClubName
                                                </p>
                                            }
                                        </div>

                                        <!-- Activity Body -->
                                        <div class="card-body">
                                            @if (!string.IsNullOrWhiteSpace(activity.Description))
                                            {
                                                <p class="text-muted small mb-3" style="max-height: 60px; overflow: hidden; text-overflow: ellipsis;">
                                                    @(activity.Description.Length > 100 ? activity.Description.Substring(0, 100) + "..." : activity.Description)
                                                </p>
                                            }

                                            <div class="d-flex flex-column gap-2 small text-muted">
                                                <div>
                                                    <i class="bi bi-calendar3"></i>
                                                    @activity.StartTime.ToString("ddd, MMM dd, yyyy")
                                                </div>
                                                <div>
                                                    <i class="bi bi-clock"></i>
                                                    @activity.StartTime.ToString("HH:mm") - @activity.EndTime.ToString("HH:mm")
                                                </div>
                                                @if (!string.IsNullOrWhiteSpace(activity.Location))
                                                {
                                                    <div>
                                                        <i class="bi bi-geo-alt"></i>
                                                        @activity.Location
                                                    </div>
                                                }
                                                <div class="text-success fw-bold">
                                                    <i class="bi bi-award"></i>
                                                    +@activity.MovementPoint points
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Activity Footer -->
                                        <div class="card-footer bg-transparent border-0 pb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <small class="text-muted">
                                                    <i class="bi bi-person-check"></i> 
                                                    @activity.CurrentParticipants@(activity.MaxParticipants.HasValue ? $"/{activity.MaxParticipants}" : "") registered
                                                </small>
                                                @if (activity.IsFull)
                                                {
                                                    <span class="badge bg-danger">Full</span>
                                                }
                                            </div>

                                            <div class="d-grid">
                                                <a href="/Activities/Details/@activity.Id" class="btn btn-primary">
                                                    <i class="bi bi-info-circle"></i> View Details
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="col-12">
                                <div class="alert alert-info text-center" role="alert">
                                    <i class="bi bi-info-circle fs-3 d-block mb-2"></i>
                                    <h5>No activities found</h5>
                                    <p class="mb-0">Your club hasn't organized any activities yet.</p>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Pagination -->
                    @if (Model.TotalPages > 1)
                    {
                        <nav aria-label="Activity pagination" class="mt-4">
                            <ul class="pagination justify-content-center">
                                <!-- Previous Button -->
                                <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                                    <a class="page-link" 
                                       href="/Clubs/MemberDashboard/@Model.Id?section=activities&page=@(Model.CurrentPage - 1)"
                                       aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>

                                @{
                                    var startPage = Math.Max(1, Model.CurrentPage - 2);
                                    var endPage = Math.Min(Model.TotalPages, Model.CurrentPage + 2);
                                    
                                    if (startPage > 1)
                                    {
                                        <li class="page-item">
                                            <a class="page-link" href="/Clubs/MemberDashboard/@Model.Id?section=activities&page=1">1</a>
                                        </li>
                                        if (startPage > 2)
                                        {
                                            <li class="page-item disabled"><span class="page-link">...</span></li>
                                        }
                                    }
                                    
                                    for (int i = startPage; i <= endPage; i++)
                                    {
                                        <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                            <a class="page-link" href="/Clubs/MemberDashboard/@Model.Id?section=activities&page=@i">@i</a>
                                        </li>
                                    }
                                    
                                    if (endPage < Model.TotalPages)
                                    {
                                        if (endPage < Model.TotalPages - 1)
                                        {
                                            <li class="page-item disabled"><span class="page-link">...</span></li>
                                        }
                                        <li class="page-item">
                                            <a class="page-link" href="/Clubs/MemberDashboard/@Model.Id?section=activities&page=@Model.TotalPages">@Model.TotalPages</a>
                                        </li>
                                    }
                                }

                                <!-- Next Button -->
                                <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : "")">
                                    <a class="page-link" 
                                       href="/Clubs/MemberDashboard/@Model.Id?section=activities&page=@(Model.CurrentPage + 1)"
                                       aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    }
                    break;

                case "awards":
                    <!-- Awards -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">
                                <i data-lucide="trophy" style="width: 20px; height: 20px;"></i>
                                Club Awards (@Model.Awards.Count)
                            </h5>
                        </div>
                        <div class="card-body">
                            @if (Model.Awards.Any())
                            {
                                <div class="row g-3">
                                    @foreach (var award in Model.Awards)
                                    {
                                        <div class="col-md-6">
                                            <div class="card border h-100">
                                                <div class="card-body">
                                                    <div class="d-flex align-items-start gap-3">
                                                        <div class="flex-shrink-0">
                                                            <div class="bg-warning bg-opacity-25 p-3 rounded-circle">
                                                                <i data-lucide="award" style="width: 28px; height: 28px; color: var(--bs-warning);"></i>
                                                            </div>
                                                        </div>
                                                        <div class="flex-grow-1">
                                                            <h6 class="fw-bold mb-2">@award.Title</h6>
                                                            @if (!string.IsNullOrWhiteSpace(award.Description))
                                                            {
                                                                <p class="small text-muted mb-2">@award.Description</p>
                                                            }
                                                            <div class="d-flex gap-2 flex-wrap">
                                                                <span class="badge bg-light text-dark border small">
                                                                    <i data-lucide="calendar" style="width: 12px; height: 12px;"></i>
                                                                    @award.AwardedAt.ToString("dd MMM yyyy")
                                                                </span>
                                                                @if (!string.IsNullOrWhiteSpace(award.SemesterName))
                                                                {
                                                                    <span class="badge bg-primary small">@award.SemesterName</span>
                                                                }
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-5 text-muted">
                                    <i data-lucide="trophy" style="width: 64px; height: 64px; opacity: 0.3;"></i>
                                    <h5 class="mt-3">No Awards Yet</h5>
                                    <p>This club hasn't received any awards yet.</p>
                                </div>
                            }
                        </div>
                    </div>
                    break;

                case "finance":
                    <!-- Club Payments Section with Beautiful Design -->
                    <style>
                        /* Finance Tabs */
                        .finance-tabs {
                            display: flex;
                            gap: 1rem;
                            margin-bottom: 2rem;
                            border-bottom: 2px solid #e5e7eb;
                            padding-bottom: 0;
                        }
                        
                        .finance-tab {
                            padding: 1rem 2rem;
                            background: transparent;
                            border: none;
                            color: #6b7280;
                            font-weight: 600;
                            cursor: pointer;
                            position: relative;
                            transition: all 0.3s;
                            border-radius: 12px 12px 0 0;
                            display: flex;
                            align-items: center;
                            gap: 0.5rem;
                        }
                        
                        .finance-tab.active {
                            color: #667eea;
                            background: white;
                        }
                        
                        .finance-tab.active::after {
                            content: '';
                            position: absolute;
                            bottom: -2px;
                            left: 0;
                            right: 0;
                            height: 2px;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        }
                        
                        .finance-tab .badge {
                            background: #ef4444;
                            color: white;
                            padding: 0.25rem 0.5rem;
                            border-radius: 50px;
                            font-size: 0.75rem;
                        }
                        
                        /* Stats Cards */
                        .finance-stat-card {
                            background: white;
                            border-radius: 16px;
                            padding: 1.5rem;
                            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
                            transition: all 0.3s;
                            border-left: 4px solid;
                        }
                        
                        .finance-stat-card:hover {
                            transform: translateY(-5px);
                            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
                        }
                        
                        .finance-stat-card.pending { border-left-color: #ef4444; }
                        .finance-stat-card.paid { border-left-color: #10b981; }
                        .finance-stat-card.overdue { border-left-color: #f59e0b; }
                        .finance-stat-card.total { border-left-color: #667eea; }
                    </style>
                    
                    <!-- Tab Navigation -->
                    <div class="finance-tabs">
                        <button class="finance-tab active" onclick="switchFinanceTab('overview', this)">
                            <i data-lucide="layout-dashboard" style="width: 16px; height: 16px;"></i>
                            Payment Overview
                        </button>
                        <button class="finance-tab" onclick="switchFinanceTab('pending', this)">
                            <i data-lucide="clock" style="width: 16px; height: 16px;"></i>
                            Pending Payments
                            <span class="badge" id="pendingPaymentsBadge" style="display: none;">0</span>
                        </button>
                        <button class="finance-tab" onclick="switchFinanceTab('history', this)">
                            <i data-lucide="file-text" style="width: 16px; height: 16px;"></i>
                            Payment History
                        </button>
                    </div>
                    
                    <script>
                        function switchFinanceTab(tabName, element) {
                            // Hide all tabs
                            document.querySelectorAll('.finance-tab-content').forEach(tab => {
                                tab.style.display = 'none';
                            });
                            
                            // Remove active class from all tabs
                            document.querySelectorAll('.finance-tab').forEach(tab => {
                                tab.classList.remove('active');
                            });
                            
                            // Show selected tab
                            document.getElementById(tabName + '-content').style.display = 'block';
                            element.classList.add('active');
                            
                            // Load data if switching to pending or history tab
                            if ((tabName === 'pending' || tabName === 'history') && allPayments && allPayments.length > 0) {
                                if (tabName === 'pending') {
                                    // Only show pending and unconfirmed payments (case-insensitive)
                                    console.log('All payments:', allPayments);
                                    console.log('Payment statuses:', allPayments.map(p => p.status));
                                    const pendingPayments = allPayments.filter(p => 
                                        p.status === 'pending' || 
                                        p.status === 'unconfirmed'
                                    );
                                    console.log('Filtered pending payments:', pendingPayments);
                                    renderPendingPayments(pendingPayments);
                                } else if (tabName === 'history') {
                                    filterPaymentHistory();
                                }
                            } else {
                                console.log('Cannot load tab data:', { tabName, allPayments: allPayments ? allPayments.length : 'null' });
                            }
                            
                            // Reinitialize icons
                            if (typeof lucide !== 'undefined') {
                                lucide.createIcons();
                            }
                        }
                    </script>

                    <!-- Tab Contents -->
                    <div id="overview-content" class="finance-tab-content">
                        <!-- Statistics Cards with Gradients -->
                        <div class="row g-4 mb-4">
                            <div class="col-md-3">
                                <div class="finance-stat-card pending">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="text-muted mb-0 small">Pending Payment</h6>
                                        <i data-lucide="wallet" style="width: 24px; height: 24px; color: #ef4444;"></i>
                                    </div>
                                    <h2 class="mb-2 fw-bold" id="pendingPaymentAmount" style="color: #ef4444;">-</h2>
                                    <p class="text-muted small mb-0" id="pendingPaymentCount">Loading...</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="finance-stat-card paid">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="text-muted mb-0 small">Total Paid (2024)</h6>
                                        <i data-lucide="check-circle" style="width: 24px; height: 24px; color: #10b981;"></i>
                                    </div>
                                    <h2 class="mb-2 fw-bold" id="totalPaidAmount" style="color: #10b981;">-</h2>
                                    <p class="text-muted small mb-0" id="totalPaidCount">Loading...</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="finance-stat-card overdue">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="text-muted mb-0 small">Overdue Payments</h6>
                                        <i data-lucide="alert-circle" style="width: 24px; height: 24px; color: #f59e0b;"></i>
                                    </div>
                                    <h2 class="mb-2 fw-bold" id="overduePaymentCount" style="color: #f59e0b;">-</h2>
                                    <p class="text-muted small mb-0" id="overduePaymentText">Loading...</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="finance-stat-card total">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="text-muted mb-0 small">Total Contribution</h6>
                                        <i data-lucide="trending-up" style="width: 24px; height: 24px; color: #667eea;"></i>
                                    </div>
                                    <h2 class="mb-2 fw-bold" id="totalContributionAmount" style="color: #667eea;">-</h2>
                                    <p class="text-muted small mb-0">Lifetime contribution</p>
                                </div>
                            </div>
                        </div>

                            <!-- Upcoming Payments Preview -->
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-white border-0">
                                    <h5 class="mb-0">Upcoming Payments</h5>
                                    <p class="text-muted small mb-0">Payments that require your attention</p>
                                </div>
                                <div class="card-body" id="upcomingPaymentsContainer">
                                    <div class="text-center py-4">
                                        <i data-lucide="loader" class="spin" style="width: 32px; height: 32px;"></i>
                                        <p class="text-muted mt-2">Loading payments...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Transactions Preview -->
                            <div class="card border-0 shadow-sm mt-4">
                                <div class="card-header bg-white border-0">
                                    <h5 class="mb-0">Recent Transactions</h5>
                                    <p class="text-muted small mb-0">Your latest payment activities</p>
                                </div>
                                <div class="card-body" id="recentTransactionsContainer">
                                    <div class="text-center py-4">
                                        <i data-lucide="loader" class="spin" style="width: 32px; height: 32px;"></i>
                                        <p class="text-muted mt-2">Loading transactions...</p>
                                    </div>
                                </div>
                            </div>
                    </div>

                    <!-- Pending Payments Tab -->
                    <div id="pending-content" class="finance-tab-content" style="display: none;">
                        <div class="alert alert-danger d-flex align-items-center mb-4" role="alert" id="overdueAlert" style="display: none;">
                            <i data-lucide="alert-circle" style="width: 20px; height: 20px;" class="me-2"></i>
                            <div>You have <strong id="overdueAlertCount">0</strong> overdue payment(s)</div>
                        </div>

                        <h5 class="mb-3">Pending Payments</h5>
                        <p class="text-muted small mb-4">Complete these payments before the deadline</p>
                            
                        <div id="pendingPaymentsList">
                            <div class="text-center py-4">
                                <i data-lucide="loader" class="spin" style="width: 32px; height: 32px;"></i>
                                <p class="text-muted mt-2">Loading pending payments...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Payment History Tab -->
                    <div id="history-content" class="finance-tab-content" style="display: none;">
                            <!-- Header Section -->
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div>
                                    <h4 class="mb-1 fw-bold">Payment History</h4>
                                    <p class="text-muted mb-0">All your completed transactions</p>
                                </div>
                                <button class="btn btn-primary" onclick="exportPaymentHistory()">
                                    <i data-lucide="download" style="width: 18px; height: 18px;"></i>
                                    Export Report
                                </button>
                            </div>

                            <!-- Search and Filter Card -->
                            <div class="card border-0 shadow-sm mb-4">
                                <div class="card-body">
                                    <div class="row g-3 align-items-end">
                                        <div class="col-md-7">
                                            <label class="form-label fw-semibold mb-2">
                                                <i data-lucide="search" style="width: 16px; height: 16px;"></i>
                                                Search Payments
                                            </label>
                                            <div class="input-group input-group-lg">
                                                <input type="text" id="historySearchInput" class="form-control" placeholder="Search by fund name or transaction ID...">
                                                <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()" title="Clear search">
                                                    <i data-lucide="x" style="width: 18px; height: 18px;"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label fw-semibold mb-2">
                                                <i data-lucide="filter" style="width: 16px; height: 16px;"></i>
                                                Filter by Status
                                            </label>
                                            <select id="historyStatusFilter" class="form-select form-select-lg">
                                                <option value="">All Status</option>
                                                <option value="paid">Completed</option>
                                                <option value="pending">Pending</option>
                                                <option value="failed">Failed</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <button class="btn btn-primary btn-lg w-100" onclick="filterPaymentHistory()">
                                                <i data-lucide="search" style="width: 18px; height: 18px;"></i>
                                                Search
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Results Table -->
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-light border-0 py-3">
                                    <h6 class="mb-0 fw-semibold">
                                        <i data-lucide="list" style="width: 16px; height: 16px;"></i>
                                        Transaction Results
                                    </h6>
                                </div>
                                
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover align-middle mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th class="px-4 py-3 fw-semibold">Date</th>
                                                    <th class="py-3 fw-semibold">Purpose</th>
                                                    <th class="py-3 fw-semibold">Transaction ID</th>
                                                    <th class="py-3 fw-semibold">Method</th>
                                                    <th class="py-3 text-end fw-semibold">Amount</th>
                                                    <th class="py-3 fw-semibold">Status</th>
                                                    <th class="py-3 text-center fw-semibold">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="paymentHistoryTableBody">
                                                <tr>
                                                    <td colspan="7" class="text-center py-5">
                                                        <i data-lucide="loader" class="spin" style="width: 40px; height: 40px; color: #0d6efd;"></i>
                                                        <p class="text-muted mt-3 mb-0">Loading payment history...</p>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                    </div>
                    
                    break;

                case "score":
                    <!-- Club Movement Score Section -->
                    @if (Model.ScoreSummary != null)
                    {
                        <!-- Summary Cards -->
                        <div class="row g-3 mb-4">
                            <div class="col-xl-3 col-md-6">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body p-4 d-flex justify-content-between">
                                        <div>
                                            <p class="text-muted mb-2 fw-medium">Average Score</p>
                                            <h2 class="mb-0 fw-bold">@Model.ScoreSummary.AverageScore.ToString("F1")</h2>
                                        </div>
                                        <div class="rounded-3 p-3" style="background:#e3f2fd">
                                            <i data-lucide="trending-up" style="width: 24px; height: 24px; color: #1976d2;"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-3 col-md-6">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body p-4 d-flex justify-content-between">
                                        <div>
                                            <p class="text-muted mb-2 fw-medium">Highest Score</p>
                                            <h2 class="mb-0 fw-bold">@Model.ScoreSummary.HighestScore.ToString("F1")</h2>
                                        </div>
                                        <div class="rounded-3 p-3" style="background:#e8f5e9">
                                            <i data-lucide="arrow-up-circle" style="width: 24px; height: 24px; color: #388e3c;"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-3 col-md-6">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body p-4 d-flex justify-content-between">
                                        <div>
                                            <p class="text-muted mb-2 fw-medium">Lowest Score</p>
                                            <h2 class="mb-0 fw-bold">@Model.ScoreSummary.LowestScore.ToString("F1")</h2>
                                        </div>
                                        <div class="rounded-3 p-3" style="background:#fff3e0">
                                            <i data-lucide="arrow-down-circle" style="width: 24px; height: 24px; color: #f57c00;"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-3 col-md-6">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body p-4 d-flex justify-content-between">
                                        <div>
                                            <p class="text-muted mb-2 fw-medium">Total Records</p>
                                            <h2 class="mb-0 fw-bold">@Model.ScoreSummary.TotalRecords</h2>
                                        </div>
                                        <div class="rounded-3 p-3" style="background:#f3e5f5">
                                            <i data-lucide="calendar" style="width: 24px; height: 24px; color: #7b1fa2;"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Semester Info -->
                        <div class="d-flex flex-wrap align-items-center justify-content-between mb-3 gap-2">
                            <h5 class="text-muted mb-0">
                                <i data-lucide="bar-chart" style="width: 20px; height: 20px;"></i>
                                <strong>@Model.SemesterSummaries.Count</strong> recorded semesters
                            </h5>
                            @if (Model.CurrentSemesterId.HasValue)
                            {
                                var currentSemester = Model.SemesterSummaries.FirstOrDefault(s => s.SemesterId == Model.CurrentSemesterId);
                                if (currentSemester != null)
                                {
                                    <div class="badge bg-warning text-dark px-3 py-2">
                                        <i data-lucide="star" style="width: 14px; height: 14px;"></i>
                                        Current Semester: <strong>@currentSemester.SemesterName</strong>
                                    </div>
                                }
                            }
                        </div>

                        <!-- Semester Table -->
                        <div class="card shadow-sm border-0 mb-4">
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-striped align-middle mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Semester</th>
                                                <th>Total Score</th>
                                                <th>Months</th>
                                                <th>Criteria Achieved</th>
                                                <th>Evaluation</th>
                                                <th>Last Updated</th>
                                                <th class="text-end" style="width:160px;">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        @if (!Model.SemesterSummaries.Any())
                                        {
                                            <tr>
                                                <td colspan="7" class="text-center text-muted py-5">
                                                    <i data-lucide="inbox" style="width: 48px; height: 48px; opacity: 0.3;"></i>
                                                    <div class="mt-3">No activity score data available</div>
                                                </td>
                                            </tr>
                                        }
                                        else
                                        {
                                            @foreach (var semester in Model.SemesterSummaries)
                                            {
                                                var percent = (semester.TotalScore / 100.0) * 100.0;
                                                var cls = percent >= 80 ? "success" : percent >= 60 ? "warning" : "danger";
                                                var eval = percent >= 80 ? "Excellent" : percent >= 60 ? "Good" : "Needs Improvement";
                                                var isCurrent = Model.CurrentSemesterId.HasValue && semester.SemesterId == Model.CurrentSemesterId.Value;
                                                <tr class="@(isCurrent ? "table-warning" : string.Empty)">
                                                    <td class="fw-semibold">@semester.SemesterName</td>
                                                    <td>
                                                        <div class="d-flex flex-column">
                                                            <span class="fw-bold text-@cls">@semester.TotalScore.ToString("F1")</span>
                                                            <small class="text-muted">/ 100</small>
                                                        </div>
                                                    </td>
                                                    <td><span class="badge bg-secondary">@semester.MonthCount months</span></td>
                                                    <td><span class="badge bg-info">@semester.TotalCriteria criteria</span></td>
                                                    <td><span class="badge bg-@cls">@eval</span></td>
                                                    <td>@(semester.LastUpdated?.ToString("dd/MM/yyyy") ?? semester.CreatedAt.ToString("dd/MM/yyyy"))</td>
                                                    <td class="text-end">
                                                        <a href="/Clubs/MemberDashboard/@Model.Id?section=score-detail&semesterId=@semester.SemesterId" class="btn btn-sm btn-primary rounded-pill @(isCurrent ? "btn-warning text-dark border-0" : string.Empty)">
                                                            <i data-lucide="eye" style="width: 14px; height: 14px;"></i> View Details
                                                        </a>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Progress by Semester -->
                        <h6 class="mb-3 text-muted">Progress by Semester</h6>
                        <div class="row">
                            @foreach (var semester in Model.SemesterSummaries.OrderBy(s => s.SemesterId))
                            {
                                var percent = (semester.TotalScore / 100.0) * 100.0;
                                var progressClass = percent >= 80 ? "success" : percent >= 60 ? "warning" : "danger";
                                var isCurrent = Model.CurrentSemesterId.HasValue && semester.SemesterId == Model.CurrentSemesterId.Value;
                                <div class="col-md-4 mb-3">
                                    <div class="card border-0 shadow-sm h-100 @(isCurrent ? "border border-warning" : string.Empty)">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between mb-2 align-items-center">
                                                <h6 class="mb-0">@semester.SemesterName</h6>
                                                @if (isCurrent)
                                                {
                                                    <span class="badge bg-warning text-dark">Current</span>
                                                }
                                                <span class="small text-muted">@percent.ToString("F1")%</span>
                                            </div>
                                            <div class="progress" style="height: 16px;">
                                                <div class="progress-bar bg-@progressClass" style="width:@percent%" role="progressbar"></div>
                                            </div>
                                            <small class="text-muted d-block mt-2">Total Score: @semester.TotalScore.ToString("F1") / 100</small>
                                            <small class="text-muted d-block">@semester.MonthCount months recorded</small>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info shadow-sm">
                            <div class="d-flex align-items-center">
                                <i data-lucide="info" style="width: 32px; height: 32px;" class="me-3"></i>
                                <div>
                                    <h5 class="alert-heading mb-1">No activity scores yet</h5>
                                    <p class="mb-0">Club activity scores will appear here once activities are completed and scored.</p>
                                </div>
                            </div>
                        </div>
                    }
                    break;

                case "score-detail":
                    <!-- Club Score Detail Section -->
                    @if (Model.ScoreDetailRecords.Any())
                    {
                        <!-- Header with Back Button -->
                        <div class="d-flex align-items-center justify-content-between mb-4">
                            <div>
                                <h4 class="mb-1">@Model.DetailSemesterName - Detailed Scores</h4>
                                <p class="text-muted mb-0">Club: @Model.Club?.Name</p>
                            </div>
                            <a href="/Clubs/MemberDashboard/@Model.Id?section=score" class="btn btn-outline-secondary">
                                <i data-lucide="arrow-left" style="width: 16px; height: 16px;"></i> Back to Overview
                            </a>
                        </div>

                        <!-- Summary Cards -->
                        <div class="row g-3 mb-4">
                            <div class="col-xl-3 col-md-6">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body p-3 text-center">
                                        <div class="rounded-3 p-2 mb-2" style="background:#e3f2fd; display: inline-block;">
                                            <i data-lucide="trophy" style="width: 20px; height: 20px; color: #1976d2;"></i>
                                        </div>
                                        <h5 class="mb-1 fw-bold text-primary">@Model.DetailTotalScore.ToString("F1")</h5>
                                        <small class="text-muted">Total Score</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-3 col-md-6">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body p-3 text-center">
                                        <div class="rounded-3 p-2 mb-2" style="background:#e8f5e9; display: inline-block;">
                                            <i data-lucide="calendar" style="width: 20px; height: 20px; color: #388e3c;"></i>
                                        </div>
                                        <h5 class="mb-1 fw-bold text-success">@Model.ScoreDetailRecords.Count</h5>
                                        <small class="text-muted">Months Recorded</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-3 col-md-6">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body p-3 text-center">
                                        <div class="rounded-3 p-2 mb-2" style="background:#fff3e0; display: inline-block;">
                                            <i data-lucide="clipboard-list" style="width: 20px; height: 20px; color: #f57c00;"></i>
                                        </div>
                                        <h5 class="mb-1 fw-bold text-warning">@Model.DetailTotalCriteria</h5>
                                        <small class="text-muted">Total Criteria</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-3 col-md-6">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body p-3 text-center">
                                        <div class="rounded-3 p-2 mb-2" style="background:#f3e5f5; display: inline-block;">
                                            <i data-lucide="user" style="width: 20px; height: 20px; color: #7b1fa2;"></i>
                                        </div>
                                        <h6 class="mb-1 fw-bold">@Model.DetailPresidentName</h6>
                                        <small class="text-muted">@Model.DetailPresidentCode</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Monthly Records Table -->
                        <div class="card shadow-sm border-0 mb-4">
                            <div class="card-header bg-light border-0 py-3">
                                <h6 class="mb-0 fw-bold">
                                    <i data-lucide="calendar-days" style="width: 18px; height: 18px;"></i>
                                    Monthly Score Records
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-striped align-middle mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width: 60px;">#</th>
                                                <th>Month</th>
                                                <th>Total Score</th>
                                                <th>Criteria Count</th>
                                                <th>Evaluation</th>
                                                <th>Last Updated</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        @{
                                            int recordIndex = 1;
                                        }
                                        @foreach (var record in Model.ScoreDetailRecords)
                                        {
                                            var percent = (record.TotalScore / 100.0) * 100.0;
                                            var cls = percent >= 80 ? "success" : percent >= 60 ? "warning" : "danger";
                                            var eval = percent >= 80 ? "Excellent" : percent >= 60 ? "Good" : "Needs Improvement";
                                            <tr>
                                                <td class="text-muted">@recordIndex</td>
                                                <td class="fw-semibold">Month @record.Month</td>
                                                <td>
                                                    <span class="fw-bold text-@cls">@record.TotalScore.ToString("F1")</span>
                                                    <small class="text-muted">/ 100</small>
                                                </td>
                                                <td><span class="badge bg-info">@record.Details.Count criteria</span></td>
                                                <td><span class="badge bg-@cls">@eval</span></td>
                                                <td>@(record.LastUpdated?.ToString("dd/MM/yyyy HH:mm") ?? record.CreatedAt.ToString("dd/MM/yyyy HH:mm"))</td>
                                            </tr>
                                            recordIndex++;
                                        }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Detailed Breakdown by Category -->
                        @foreach (var record in Model.ScoreDetailRecords)
                        {
                            <div class="card shadow-sm border-0 mb-4">
                                <div class="card-header bg-light border-0 py-3">
                                    <h6 class="mb-0 fw-bold">
                                        <i data-lucide="list" style="width: 18px; height: 18px;"></i>
                                        Month @record.Month - Detailed Breakdown
                                    </h6>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-striped align-middle mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width: 40px;">#</th>
                                                    <th>Category</th>
                                                    <th>Criteria</th>
                                                    <th class="text-center">Max Score</th>
                                                    <th class="text-center">Score</th>
                                                    <th>Date Awarded</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                            @if (record.Details != null && record.Details.Any())
                                            {
                                                int detailIndex = 1;
                                                @foreach (var detail in record.Details.OrderBy(d => d.GroupName).ThenBy(d => d.CriterionTitle))
                                                {
                                                    <tr>
                                                        <td class="text-muted">@detailIndex</td>
                                                        <td>
                                                            <span class="badge bg-secondary">@detail.GroupName</span>
                                                        </td>
                                                        <td class="fw-medium">@detail.CriterionTitle</td>
                                                        <td class="text-center text-muted">@detail.CriterionMaxScore</td>
                                                        <td class="text-center">
                                                            <span class="fw-bold">@detail.Score.ToString("F1")</span>
                                                        </td>
                                                        <td>@detail.AwardedAt.ToString("dd/MM/yyyy")</td>
                                                    </tr>
                                                    detailIndex++;
                                                }
                                            }
                                            else
                                            {
                                                <tr>
                                                    <td colspan="6" class="text-center text-muted py-4">
                                                        <i data-lucide="inbox" style="width: 32px; height: 32px; opacity: 0.3;"></i>
                                                        <div class="mt-2">No detailed score data available</div>
                                                    </td>
                                                </tr>
                                            }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        }

                        <!-- Performance Summary -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card border-0 bg-light">
                                    <div class="card-body p-3">
                                        <h6 class="mb-2">Semester Information</h6>
                                        <p class="mb-1"><strong>Semester:</strong> @Model.DetailSemesterName</p>
                                        <p class="mb-1"><strong>President:</strong> @Model.DetailPresidentName (@Model.DetailPresidentCode)</p>
                                        <p class="mb-0"><strong>Status:</strong> 
                                            @if (Model.IsDetailCurrentSemester)
                                            {
                                                <span class="badge bg-warning text-dark">Current Semester</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">Past Semester</span>
                                            }
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-0 bg-light">
                                    <div class="card-body p-3">
                                        <h6 class="mb-2">Performance Summary</h6>
                                        @{
                                            var totalPercentage = Model.DetailTotalScore;
                                            var performanceLevel = totalPercentage >= 80 ? "Excellent" : totalPercentage >= 60 ? "Good" : "Needs Improvement";
                                            var performanceClass = totalPercentage >= 80 ? "success" : totalPercentage >= 60 ? "warning" : "danger";
                                        }
                                        <p class="mb-1"><strong>Overall Rating:</strong> <span class="badge bg-@performanceClass">@performanceLevel</span></p>
                                        <p class="mb-1"><strong>Total Criteria:</strong> @Model.DetailTotalCriteria</p>
                                        <p class="mb-0"><strong>Average per Month:</strong> @((Model.ScoreDetailRecords.Count > 0 ? Model.DetailTotalScore / Model.ScoreDetailRecords.Count : 0).ToString("F1"))</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning shadow-sm">
                            <div class="d-flex align-items-center">
                                <i data-lucide="alert-triangle" style="width: 32px; height: 32px;" class="me-3"></i>
                                <div>
                                    <h5 class="alert-heading mb-1">Score details not found</h5>
                                    <p class="mb-0">The requested semester score details could not be loaded.</p>
                                    <a href="/Clubs/MemberDashboard/@Model.Id?section=score" class="btn btn-sm btn-outline-warning mt-2">
                                        <i data-lucide="arrow-left" style="width: 14px; height: 14px;"></i> Back to Score Overview
                                    </a>
                                </div>
                            </div>
                        </div>
                    }
                    break;

                case "proposals":
                    <!-- Proposals Section -->
                    <div class="mb-3 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i data-lucide="lightbulb" style="width: 20px; height: 20px;"></i>
                            Proposals (@Model.Proposals.Count)
                        </h5>
                        <a href="/Clubs/Proposals/Create?clubId=@Model.Id" class="btn btn-primary">
                            <i data-lucide="plus" style="width: 16px; height: 16px;"></i> Create Proposal
                        </a>
                    </div>

                    @if (Model.Proposals.Any())
                    {
                        <div class="row g-3">
                            @foreach (var proposal in Model.Proposals)
                            {
                                var statusClass = proposal.Status switch
                                {
                                    "PendingVote" => "bg-warning text-dark",
                                    "ApprovedByClub" => "bg-success",
                                    "Rejected" => "bg-danger",
                                    _ => "bg-secondary"
                                };

                                <div class="col-12">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <h6 class="fw-bold mb-0">@proposal.Title</h6>
                                                <span class="badge @statusClass">@proposal.Status</span>
                                            </div>
                                            
                                            @if (!string.IsNullOrWhiteSpace(proposal.Description))
                                            {
                                                <p class="text-muted small mb-3">
                                                    @(proposal.Description.Length > 150 ? proposal.Description.Substring(0, 150) + "..." : proposal.Description)
                                                </p>
                                            }
                                            
                                            <div class="d-flex gap-3 align-items-center mb-3">
                                                <div class="d-flex align-items-center gap-2">
                                                    <i data-lucide="user" style="width: 16px; height: 16px;"></i>
                                                    <span class="small text-muted">@proposal.CreatedByName</span>
                                                </div>
                                                <div class="d-flex align-items-center gap-2">
                                                    <i data-lucide="calendar" style="width: 16px; height: 16px;"></i>
                                                    <span class="small text-muted">@proposal.CreatedAt.ToString("dd MMM yyyy")</span>
                                                </div>
                                            </div>

                                            <div class="d-flex gap-3 align-items-center">
                                                <div class="badge bg-success bg-opacity-10 text-success px-3 py-2">
                                                    <i data-lucide="thumbs-up" style="width: 14px; height: 14px;"></i>
                                                    @proposal.AgreeCount Agree
                                                </div>
                                                <div class="badge bg-danger bg-opacity-10 text-danger px-3 py-2">
                                                    <i data-lucide="thumbs-down" style="width: 14px; height: 14px;"></i>
                                                    @proposal.DisagreeCount Disagree
                                                </div>
                                                @if (proposal.CurrentUserVote != null)
                                                {
                                                    <span class="badge bg-info ms-auto">
                                                        You voted: @(proposal.CurrentUserVote == true ? "Agree" : "Disagree")
                                                    </span>
                                                }
                                            </div>

                                            <div class="mt-3">
                                                <a href="/Clubs/Proposals/Detail/@proposal.Id" class="btn btn-sm btn-outline-primary">
                                                    <i data-lucide="eye" style="width: 14px; height: 14px;"></i> View Details
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="card border-0 shadow-sm">
                            <div class="card-body text-center py-5">
                                <i data-lucide="lightbulb" style="width: 64px; height: 64px; color: #ccc;"></i>
                                <h5 class="mt-3 mb-2">No Proposals Yet</h5>
                                <p class="text-muted mb-4">Be the first to create a proposal for your club!</p>
                                <a href="/Clubs/Proposals/Create?clubId=@Model.Id" class="btn btn-primary">
                                    <i data-lucide="plus" style="width: 16px; height: 16px;"></i> Create First Proposal
                                </a>
                            </div>
                        </div>
                    }
                    break;
            }
        </div>
    </div>
    
    <!-- Overlay for mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Pay Now Modal -->
    <div class="modal fade" id="payNowModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Complete Payment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="payNowForm">
                    <input type="hidden" id="paymentIdToPay">
                    <input type="hidden" id="paymentMethodAvailable">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Request</label>
                            <input type="text" class="form-control" id="paymentRequestTitle" readonly>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Amount to Pay</label>
                            <input type="text" class="form-control" id="paymentAmountToPay" readonly>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Due Date</label>
                            <input type="text" class="form-control" id="paymentDueDate" readonly>
                        </div>

                        <div class="mb-3" id="paymentMethodSelection">
                            <label for="selectedPaymentMethod" class="form-label">Payment Method <span class="text-danger">*</span></label>
                            <select class="form-select" id="selectedPaymentMethod" required>
                                <option value="">Select method...</option>
                                <option value="Cash">Cash</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="VNPAY">VNPAY</option>
                            </select>
                            <div class="form-text">
                                <strong>Cash:</strong> Submit request, manager will confirm after you pay<br>
                                <strong>Bank Transfer:</strong> Upload receipt for verification<br>
                                <strong>VNPAY:</strong> Pay online instantly via VNPAY gateway
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="paymentNotesMember" class="form-label">Notes (Optional)</label>
                            <textarea class="form-control" id="paymentNotesMember" rows="2" maxlength="500" placeholder="Add any notes..."></textarea>
                        </div>

                        <div class="alert alert-info small mb-0">
                            <i data-lucide="info" style="width: 14px; height: 14px;"></i>
                            <span id="paymentInfoText">Your payment will be recorded and pending confirmation.</span>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i data-lucide="check-circle" style="width: 16px; height: 16px;"></i>
                            Submit Payment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Payment Details Modal -->
    <div class="modal fade" id="paymentDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Payment Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="text-muted small">Fund Collection</label>
                            <p class="fw-bold mb-0" id="detailTitle"></p>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small">Amount</label>
                            <p class="fw-bold text-primary mb-0" id="detailAmount"></p>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small">Payment Date</label>
                            <p class="mb-0" id="detailPaidAt"></p>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small">Payment Method</label>
                            <p class="mb-0" id="detailPaymentMethod"></p>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small">Status</label>
                            <p class="mb-0" id="detailStatus"></p>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small">Transaction ID</label>
                            <p class="mb-0"><code id="detailTransactionId"></code></p>
                        </div>
                        <div class="col-12" id="vnpayDetailsSection" style="display: none;">
                            <hr>
                            <h6 class="fw-bold mb-3">
                                <i data-lucide="smartphone" style="width: 18px; height: 18px;"></i>
                                VNPAY Transaction Details
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="text-muted small">VNPAY Transaction ID</label>
                                    <p class="mb-0"><code id="detailVnpayTxnId"></code></p>
                                </div>
                                <div class="col-md-4">
                                    <label class="text-muted small">Bank Code</label>
                                    <p class="mb-0" id="detailVnpayBank"></p>
                                </div>
                                <div class="col-md-4">
                                    <label class="text-muted small">Transaction Status</label>
                                    <p class="mb-0" id="detailVnpayStatus"></p>
                                </div>
                                <div class="col-12">
                                    <label class="text-muted small">Transaction Date</label>
                                    <p class="mb-0" id="detailVnpayDate"></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-12" id="notesSection" style="display: none;">
                            <hr>
                            <label class="text-muted small">Notes</label>
                            <p class="mb-0" id="detailNotes"></p>
                        </div>
                        <div class="col-12">
                            <hr>
                            <label class="text-muted small">Description</label>
                            <p class="mb-0" id="detailDescription"></p>
                        </div>
                        <div class="col-12" id="confirmedBySection" style="display: none;">
                            <label class="text-muted small">Confirmed By</label>
                            <p class="mb-0" id="detailConfirmedBy"></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/auth.js" asp-append-version="true"></script>
    <script>
        async function updateMemberDashboardAuthUI() {
            const user = await getUser();
            if (user && user.avatar) {
                document.getElementById('memberDashboardUserAvatar').src = user.avatar;
            }
            if (user && user.name) {
                document.getElementById('memberDashboardUserName').textContent = user.name;
            }
        }

        function toggleSidebar() {
            document.getElementById('adminSidebar').classList.toggle('show');
            document.getElementById('sidebarOverlay').classList.toggle('show');
        }

        function toggleSidebarCollapse() {
            document.body.classList.toggle('sidebar-collapsed');
            localStorage.setItem('sidebarCollapsed', document.body.classList.contains('sidebar-collapsed'));
        }

        // Restore sidebar state
        if (localStorage.getItem('sidebarCollapsed') === 'true') {
            document.body.classList.add('sidebar-collapsed');
        }

        function toggleNotificationCenter() {
            // TODO: Implement notification center
            console.log('Notification center clicked');
        }

        // Logout function tá»« auth.js sáº½ Ä‘Æ°á»£c dÃ¹ng

        // Finance - Payment Data
        const CLUB_ID = @Model.Id;
        const API_BASE = 'https://localhost:5001/api';

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { 
                style: 'currency', 
                currency: 'VND' 
            }).format(amount).replace('â‚«', 'â‚«');
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('vi-VN');
        }

        function getDaysOverdue(dueDate) {
            const now = new Date();
            const due = new Date(dueDate);
            const diff = Math.floor((now - due) / (1000 * 60 * 60 * 24));
            return diff > 0 ? diff : 0;
        }

        function getStatusBadge(status, dueDate) {
            const daysOverdue = getDaysOverdue(dueDate);
            if (status === 'paid' || status === 'confirmed') {
                return '<span class="badge bg-success">Paid</span>';
            } else if (status === 'unconfirmed') {
                return '<span class="badge bg-danger">Unconfirmed (Cash)</span>';
            } else if (status === 'pending') {
                if (daysOverdue > 0) {
                    return '<span class="badge bg-danger">Overdue</span>';
                } else {
                    return '<span class="badge bg-warning text-dark">Pending</span>';
                }
            } else {
                return `<span class="badge bg-secondary">${status}</span>`;
            }
        }

        async function loadMyPayments() {
            try {
                const response = await fetch(`${API_BASE}/FundCollection/club/${CLUB_ID}/my-payments`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to load payments');
                }

                const payments = await response.json();
                console.log('Loaded payments:', payments);
                
                // Store payments globally for modal access
                allPayments = payments;

                // Calculate statistics - separate pending and unconfirmed
                const pendingPayments = payments.filter(p => p.status === 'pending' || p.status === 'unconfirmed');
                const unconfirmedPayments = payments.filter(p => p.status === 'unconfirmed');
                const paidPayments = payments.filter(p => p.status === 'paid' || p.status === 'confirmed');
                const overduePayments = pendingPayments.filter(p => getDaysOverdue(p.fundCollectionRequest.dueDate) > 0);

                const pendingAmount = pendingPayments.reduce((sum, p) => sum + p.amount, 0);
                const paidAmount = paidPayments.reduce((sum, p) => sum + p.amount, 0);
                const totalAmount = payments.reduce((sum, p) => sum + p.amount, 0);

                // Update statistics cards
                document.getElementById('pendingPaymentAmount').textContent = formatCurrency(pendingAmount);
                const pendingText = unconfirmedPayments.length > 0 
                    ? `${pendingPayments.length} payment(s) (${unconfirmedPayments.length} unconfirmed)`
                    : `${pendingPayments.length} payment(s) pending`;
                document.getElementById('pendingPaymentCount').textContent = pendingText;

                const currentYear = new Date().getFullYear();
                const paidThisYear = paidPayments.filter(p => new Date(p.paidAt).getFullYear() === currentYear);
                const paidThisYearAmount = paidThisYear.reduce((sum, p) => sum + p.amount, 0);
                document.getElementById('totalPaidAmount').textContent = formatCurrency(paidThisYearAmount);
                document.getElementById('totalPaidCount').textContent = `${paidThisYear.length} completed`;

                document.getElementById('overduePaymentCount').textContent = overduePayments.length;
                document.getElementById('overduePaymentText').textContent = overduePayments.length > 0 ? 'Require immediate action' : 'No overdue payments';

                document.getElementById('totalContributionAmount').textContent = formatCurrency(paidAmount);

                // Update badge
                if (pendingPayments.length > 0) {
                    document.getElementById('pendingPaymentsBadge').textContent = pendingPayments.length;
                    document.getElementById('pendingPaymentsBadge').style.display = '';
                }

                // Update overdue alert
                if (overduePayments.length > 0) {
                    document.getElementById('overdueAlertCount').textContent = overduePayments.length;
                    document.getElementById('overdueAlert').style.display = '';
                }

                // Render upcoming payments (top 3 pending)
                renderUpcomingPayments(pendingPayments.slice(0, 3));

                // Render recent transactions (top 5 paid)
                renderRecentTransactions(paidPayments.slice(0, 5));

                // Render all pending payments
                renderPendingPayments(pendingPayments);

                // Populate year filter for payment history
                populateYearFilter();

                // Check if we're on the history tab and render if so
                const historyTab = document.getElementById('history');
                if (historyTab && historyTab.classList.contains('active')) {
                    renderPaymentHistory(payments);
                }

                // Re-init Lucide icons
                setTimeout(() => initLucide(), 100);
            } catch (error) {
                console.error('Error loading payments:', error);
                document.getElementById('upcomingPaymentsContainer').innerHTML = `
                    <div class="alert alert-danger">
                        <i data-lucide="alert-circle"></i>
                        Failed to load payments. Please refresh the page.
                    </div>
                `;
                
                // Also show error in payment history table if it exists
                const historyTableBody = document.getElementById('paymentHistoryTableBody');
                if (historyTableBody) {
                    historyTableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                <i data-lucide="alert-circle" style="width: 48px; height: 48px; color: #dc3545;"></i>
                                <p class="text-danger mt-2">Failed to load payment history</p>
                                <button class="btn btn-sm btn-primary" onclick="loadMyPayments()">
                                    <i data-lucide="refresh-cw" style="width: 14px; height: 14px;"></i> Retry
                                </button>
                            </td>
                        </tr>
                    `;
                }
            }
        }

        function renderUpcomingPayments(payments) {
            const container = document.getElementById('upcomingPaymentsContainer');
            
            if (payments.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i data-lucide="check-circle" style="width: 48px; height: 48px; color: #28a745;"></i>
                        <p class="text-muted mt-3 mb-0">No pending payments</p>
                    </div>
                `;
                return;
            }

            const html = `
                <div class="row g-3">
                    ${payments.map(payment => {
                        const daysOverdue = getDaysOverdue(payment.fundCollectionRequest.dueDate);
                        const isOverdue = daysOverdue > 0;
                        return `
                            <div class="col-12">
                                <div class="card border${isOverdue ? ' border-danger' : ''}">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <h6 class="fw-bold mb-1">${payment.fundCollectionRequest.title}</h6>
                                                ${getStatusBadge(payment.status, payment.fundCollectionRequest.dueDate)}
                                            </div>
                                            <h5 class="mb-0 text-primary">${formatCurrency(payment.amount)}</h5>
                                        </div>
                                        <p class="text-muted small mb-2">${payment.fundCollectionRequest.description || ''}</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="${isOverdue ? 'text-danger' : 'text-muted'}">
                                                <i data-lucide="calendar" style="width: 14px; height: 14px;"></i>
                                                Due: ${formatDate(payment.fundCollectionRequest.dueDate)}${isOverdue ? ` â€¢ <strong>${daysOverdue} days overdue</strong>` : ''}
                                            </small>
                                            ${payment.status === 'unconfirmed' ? `
                                                <span class="badge bg-warning text-dark">
                                                    <i data-lucide="clock" style="width: 14px; height: 14px;"></i>
                                                    Awaiting Confirmation
                                                </span>
                                            ` : `
                                                <button class="btn btn-${isOverdue ? 'danger' : 'primary'} btn-sm" onclick="payNow(${payment.id})">
                                                    <i data-lucide="credit-card" style="width: 14px; height: 14px;"></i>
                                                    Pay Now
                                                </button>
                                            `}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            container.innerHTML = html;
        }

        function renderRecentTransactions(payments) {
            const container = document.getElementById('recentTransactionsContainer');
            
            if (payments.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i data-lucide="inbox" style="width: 48px; height: 48px; color: #6c757d;"></i>
                        <p class="text-muted mt-3 mb-0">No transactions yet</p>
                    </div>
                `;
                return;
            }

            const html = `
                <div class="list-group list-group-flush">
                    ${payments.map(payment => `
                        <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                            <div class="d-flex align-items-center gap-3">
                                <div class="bg-success bg-opacity-10 p-2 rounded">
                                    <i data-lucide="check-circle" style="width: 20px; height: 20px; color: #28a745;"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">${payment.fundCollectionRequest.title}</h6>
                                    <small class="text-muted">${formatDate(payment.paidAt)} â€¢ ${payment.paymentMethod || 'N/A'}</small>
                                </div>
                            </div>
                            <div class="text-end">
                                <h6 class="mb-0">${formatCurrency(payment.amount)}</h6>
                                ${getStatusBadge(payment.status, payment.fundCollectionRequest.dueDate)}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            container.innerHTML = html;
        }

        function renderPendingPayments(payments) {
            const container = document.getElementById('pendingPaymentsList');
            
            if (payments.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i data-lucide="check-circle" style="width: 64px; height: 64px; color: #28a745;"></i>
                        <h5 class="mt-3">All caught up!</h5>
                        <p class="text-muted">You have no pending payments</p>
                    </div>
                `;
                return;
            }

            const html = payments.map(payment => {
                const daysOverdue = getDaysOverdue(payment.fundCollectionRequest.dueDate);
                const isOverdue = daysOverdue > 0;
                const progress = isOverdue ? 100 : 50;
                const progressColor = isOverdue ? 'danger' : 'primary';

                return `
                    <div class="card border-0 shadow-sm mb-3${isOverdue ? ' border-danger' : ''}"${isOverdue ? ' style="background-color: #fff5f5;"' : ''}>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h5 class="fw-bold mb-2">${payment.fundCollectionRequest.title}</h5>
                                    ${getStatusBadge(payment.status, payment.fundCollectionRequest.dueDate)}
                                </div>
                                <h4 class="mb-0 text-primary">${formatCurrency(payment.amount)}</h4>
                            </div>
                            
                            <p class="text-muted mb-3">${payment.fundCollectionRequest.description || 'No description'}</p>
                            
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted">
                                        <i data-lucide="calendar" style="width: 14px; height: 14px;"></i>
                                        Deadline: ${formatDate(payment.fundCollectionRequest.dueDate)}
                                    </small>
                                    ${isOverdue ? `<small class="text-danger fw-bold">${daysOverdue} days overdue</small>` : '<small class="text-muted">Upcoming</small>'}
                                </div>
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar bg-${progressColor}" role="progressbar" style="width: ${progress}%"></div>
                                </div>
                            </div>
                            
                            <div class="row g-3 mb-3">
                                <div class="col-6">
                                    <small class="text-muted d-block">Amount</small>
                                    <strong>${formatCurrency(payment.amount)}</strong>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted d-block">Created</small>
                                    <strong>${formatDate(payment.createdAt)}</strong>
                                </div>
                            </div>
                            
                            ${payment.status === 'unconfirmed' ? `
                                <div class="alert alert-warning mb-0">
                                    <i data-lucide="clock" style="width: 16px; height: 16px;"></i>
                                    Awaiting club confirmation for cash payment
                                </div>
                            ` : `
                                <button class="btn btn-${isOverdue ? 'danger' : 'primary'} w-100" onclick="payNow(${payment.id})">
                                    <i data-lucide="credit-card" style="width: 16px; height: 16px;"></i>
                                    Pay Now
                                </button>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        // Store all payments for modal access
        let allPayments = [];

        function payNow(paymentId) {
            const payment = allPayments.find(p => p.id === paymentId);
            if (!payment) {
                alert('Payment not found');
                return;
            }

            // Set modal values
            document.getElementById('paymentIdToPay').value = paymentId;
            document.getElementById('paymentRequestTitle').value = payment.fundCollectionRequest.title;
            document.getElementById('paymentAmountToPay').value = formatCurrency(payment.amount);
            document.getElementById('paymentDueDate').value = formatDate(payment.fundCollectionRequest.dueDate);
            
            const availableMethods = payment.fundCollectionRequest.paymentMethods || 'All';
            document.getElementById('paymentMethodAvailable').value = availableMethods;

            const methodSelection = document.getElementById('paymentMethodSelection');
            const selectedMethodDropdown = document.getElementById('selectedPaymentMethod');

            if (availableMethods === 'All') {
                // Show dropdown for method selection
                methodSelection.style.display = 'block';
                selectedMethodDropdown.value = '';
                selectedMethodDropdown.required = true;
                document.getElementById('paymentInfoText').textContent = 'Choose your preferred payment method.';
            } else {
                // Hide dropdown, use fixed method
                methodSelection.style.display = 'none';
                selectedMethodDropdown.value = availableMethods;
                selectedMethodDropdown.required = false;
                
                if (availableMethods === 'Cash') {
                    document.getElementById('paymentInfoText').textContent = 'Payment method: Cash. Submit this request and pay to your club manager. They will confirm after receiving payment.';
                } else if (availableMethods === 'Bank Transfer') {
                    document.getElementById('paymentInfoText').textContent = 'Payment method: Bank Transfer. Transfer money and submit this request. Upload receipt for faster verification.';
                } else if (availableMethods === 'VNPAY') {
                    document.getElementById('paymentInfoText').textContent = 'Payment method: VNPAY. You will be redirected to VNPAY gateway to complete your payment online.';
                }
            }

            // Open modal
            new bootstrap.Modal(document.getElementById('payNowModal')).show();
        }

        // Handle Pay Now Form Submission
        document.getElementById('payNowForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const form = e.target;
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }

            const paymentId = document.getElementById('paymentIdToPay').value;
            const availableMethods = document.getElementById('paymentMethodAvailable').value;
            const selectedMethod = availableMethods === 'All' 
                ? document.getElementById('selectedPaymentMethod').value 
                : availableMethods;
            const notes = document.getElementById('paymentNotesMember').value;

            // Handle VNPAY payment separately
            if (selectedMethod === 'VNPAY') {
                try {
                    const response = await fetch(`${API_BASE}/Vnpay/create-payment-url`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            paymentId: parseInt(paymentId)
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        // Close modal and redirect to VNPAY
                        bootstrap.Modal.getInstance(document.getElementById('payNowModal')).hide();
                        window.location.href = result.paymentUrl;
                    } else {
                        const error = await response.json();
                        alert(`âŒ Error: ${error.message || 'Failed to create VNPAY payment URL'}`);
                    }
                } catch (error) {
                    console.error('Error creating VNPAY payment:', error);
                    alert('âŒ An error occurred. Please try again.');
                }
                return;
            }

            // Handle Cash and Bank Transfer payments
            // Determine transaction status based on payment method
            const status = selectedMethod === 'Cash' ? 'unconfirmed' : 'pending';

            const dto = {
                paymentId: parseInt(paymentId),
                paymentMethod: selectedMethod,
                notes: notes,
                status: status
            };

            try {
                const response = await fetch(`${API_BASE}/FundCollection/payment/${paymentId}/member-pay`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(dto)
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('payNowModal')).hide();
                    
                    if (selectedMethod === 'Cash') {
                        alert('âœ… Payment request submitted! Please pay to your club manager. They will confirm after receiving payment.');
                    } else {
                        alert('âœ… Payment submitted! Please complete the bank transfer. Your payment is pending verification.');
                    }
                    
                    // Reload payments
                    await loadMyPayments();
                } else {
                    const error = await response.json();
                    alert(`âŒ Error: ${error.message || error.title || 'Failed to submit payment'}`);
                }
            } catch (error) {
                console.error('Error submitting payment:', error);
                alert('âŒ An error occurred. Please try again.');
            }
        });

        // ============================================
        // Payment History Functions
        // ============================================

        // Render Payment History Table
        function renderPaymentHistory(payments) {
            const tbody = document.getElementById('paymentHistoryTableBody');
            
            if (!tbody) {
                console.error('Payment history table body not found');
                return;
            }

            console.log('Rendering payment history with', payments.length, 'payments');

            // Sort by payment date descending (most recent first)
            const sortedPayments = [...payments].sort((a, b) => {
                const dateA = a.paidAt ? new Date(a.paidAt) : new Date(0);
                const dateB = b.paidAt ? new Date(b.paidAt) : new Date(0);
                return dateB - dateA;
            });

            // Handle empty state
            if (sortedPayments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <div class="py-4">
                                <i data-lucide="inbox" style="width: 64px; height: 64px; color: #adb5bd;"></i>
                                <h6 class="mt-3 text-muted">No payment history found</h6>
                                <p class="text-muted small mb-0">Try adjusting your search or filters</p>
                            </div>
                        </td>
                    </tr>
                `;
                setTimeout(() => initLucide(), 100);
                return;
            }

            // Generate table rows
            tbody.innerHTML = sortedPayments.map(payment => {
                const transactionId = getTransactionId(payment);
                const paymentMethod = payment.paymentMethod || 'N/A';
                const paymentMethodIcon = getPaymentMethodIcon(paymentMethod);
                
                return `
                    <tr style="border-bottom: 1px solid #e9ecef;">
                        <td class="px-4 py-3">
                            <div class="fw-semibold">${formatDate(payment.paidAt)}</div>
                        </td>
                        <td class="py-3">
                            <div class="fw-semibold text-dark">${escapeHtml(payment.fundCollectionRequest.title)}</div>
                            <small class="text-muted">${escapeHtml('@Model.Club?.Name' || 'Club')}</small>
                        </td>
                        <td class="py-3">
                            <code class="bg-light px-2 py-1 rounded">${escapeHtml(transactionId)}</code>
                        </td>
                        <td class="py-3">
                            <i data-lucide="${paymentMethodIcon}" style="width: 16px; height: 16px;" class="me-1"></i>
                            <span>${escapeHtml(paymentMethod)}</span>
                        </td>
                        <td class="py-3 text-end">
                            <span class="fw-bold text-primary">${formatCurrency(payment.amount)}</span>
                        </td>
                        <td class="py-3">
                            <span class="badge bg-success px-3 py-2">
                                <i data-lucide="check-circle" style="width: 14px; height: 14px;"></i>
                                Completed
                            </span>
                        </td>
                        <td class="py-3 text-center">
                            <button class="btn btn-sm btn-primary" onclick="showPaymentDetails(${payment.id})" title="View Details">
                                <i data-lucide="eye" style="width: 16px; height: 16px;"></i>
                                View
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            // Re-initialize Lucide icons
            setTimeout(() => initLucide(), 100);
        }

        // Get Available Years from Payments
        function getAvailableYears(payments) {
            const years = new Set();
            
            payments.forEach(payment => {
                if (payment.paidAt) {
                    const year = new Date(payment.paidAt).getFullYear();
                    years.add(year);
                }
            });
            
            // Convert to array and sort descending
            return Array.from(years).sort((a, b) => b - a);
        }

        // Populate Year Filter Dropdown
        function populateYearFilter() {
            const yearFilter = document.getElementById('historyYearFilter');
            
            if (!yearFilter || !allPayments) {
                return;
            }

            const years = getAvailableYears(allPayments);
            
            // Clear existing options except "All Years"
            yearFilter.innerHTML = '<option value="">All Years</option>';
            
            // Add year options
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });
            
            // Set current year as default if available
            const currentYear = new Date().getFullYear();
            if (years.includes(currentYear)) {
                yearFilter.value = currentYear;
            }
        }

        // Helper: Get Transaction ID
        function getTransactionId(payment) {
            if (payment.vnpayTransactionId) {
                return `VNPAY-${payment.vnpayTransactionId}`;
            } else if (payment.paymentTransactionId) {
                return `TXN-${payment.paymentTransactionId}`;
            } else {
                return `PAY-${payment.id}`;
            }
        }

        // Helper: Get Payment Method Icon
        function getPaymentMethodIcon(method) {
            const methodLower = method.toLowerCase();
            if (methodLower.includes('vnpay')) return 'smartphone';
            if (methodLower.includes('bank')) return 'building';
            if (methodLower.includes('cash')) return 'dollar-sign';
            return 'credit-card';
        }

        // Helper: Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Helper: Debounce function
        function debounce(func, delay) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // Clear Search
        function clearSearch() {
            const searchInput = document.getElementById('historySearchInput');
            if (searchInput) {
                searchInput.value = '';
            }
            filterPaymentHistory();
        }

        // Filter Payment History
        function filterPaymentHistory() {
            if (!allPayments || allPayments.length === 0) {
                console.log('No payments data available for filtering');
                return;
            }

            const searchInput = document.getElementById('historySearchInput');
            const statusSelect = document.getElementById('historyStatusFilter');

            const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
            const statusFilter = statusSelect ? statusSelect.value : '';

            console.log('Filtering with:', { searchTerm, statusFilter, totalPayments: allPayments.length });

            let filtered = allPayments.filter(payment => {
                // Only show paid/confirmed payments in history
                const isPaidOrConfirmed = payment.status === 'paid' || payment.status === 'confirmed';
                if (!isPaidOrConfirmed) return false;

                // Search filter - match against title or transaction ID
                let matchesSearch = true;
                if (searchTerm) {
                    const title = (payment.fundCollectionRequest?.title || '').toLowerCase();
                    const txnId = getTransactionId(payment).toLowerCase();
                    matchesSearch = title.includes(searchTerm) || txnId.includes(searchTerm);
                }

                // Status filter
                let matchesStatus = true;
                if (statusFilter) {
                    matchesStatus = payment.status === statusFilter;
                }

                return matchesSearch && matchesStatus;
            });

            console.log('Filtered results:', filtered.length);
            renderPaymentHistory(filtered);
        }

        // Get Filtered Payments (for export)
        function getFilteredPayments() {
            if (!allPayments) return [];

            const searchTerm = document.getElementById('historySearchInput')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('historyStatusFilter')?.value || '';

            return allPayments.filter(payment => {
                const isPaidOrConfirmed = payment.status === 'paid' || payment.status === 'confirmed';
                if (!isPaidOrConfirmed) return false;

                let matchesSearch = true;
                if (searchTerm) {
                    const title = payment.fundCollectionRequest?.title?.toLowerCase() || '';
                    const txnId = getTransactionId(payment).toLowerCase();
                    matchesSearch = title.includes(searchTerm) || txnId.includes(searchTerm);
                }

                let matchesStatus = true;
                if (statusFilter) {
                    matchesStatus = payment.status === statusFilter;
                }

                return matchesSearch && matchesStatus;
            });
        }

        // ============================================
        // Payment Details Modal Functions
        // ============================================

        // Show Payment Details Modal
        function showPaymentDetails(paymentId) {
            const payment = allPayments.find(p => p.id === paymentId);
            
            if (!payment) {
                showToast('Payment not found', 'danger');
                console.error('Payment not found:', paymentId);
                return;
            }

            populatePaymentDetails(payment);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('paymentDetailsModal'));
            modal.show();
        }

        // Populate Payment Details Modal
        function populatePaymentDetails(payment) {
            // Basic payment information
            document.getElementById('detailTitle').textContent = payment.fundCollectionRequest?.title || 'N/A';
            document.getElementById('detailAmount').textContent = formatCurrency(payment.amount);
            document.getElementById('detailPaidAt').textContent = payment.paidAt ? formatDate(payment.paidAt) : 'N/A';
            document.getElementById('detailPaymentMethod').textContent = payment.paymentMethod || 'N/A';
            
            // Status badge
            const statusElement = document.getElementById('detailStatus');
            if (payment.status === 'paid' || payment.status === 'confirmed') {
                statusElement.innerHTML = '<span class="badge bg-success"><i data-lucide="check-circle" style="width: 12px; height: 12px;"></i> Completed</span>';
            } else if (payment.status === 'pending') {
                statusElement.innerHTML = '<span class="badge bg-warning text-dark"><i data-lucide="clock" style="width: 12px; height: 12px;"></i> Pending</span>';
            } else if (payment.status === 'unconfirmed') {
                statusElement.innerHTML = '<span class="badge bg-danger"><i data-lucide="alert-circle" style="width: 12px; height: 12px;"></i> Unconfirmed</span>';
            } else {
                statusElement.innerHTML = `<span class="badge bg-secondary">${payment.status}</span>`;
            }
            
            // Transaction ID
            document.getElementById('detailTransactionId').textContent = getTransactionId(payment);
            
            // VNPAY details (if applicable)
            const vnpaySection = document.getElementById('vnpayDetailsSection');
            if (payment.paymentMethod === 'VNPAY' && payment.vnpayTransactionId) {
                vnpaySection.style.display = 'block';
                document.getElementById('detailVnpayTxnId').textContent = payment.vnpayTransactionId || 'N/A';
                document.getElementById('detailVnpayBank').textContent = payment.vnpayBankCode || 'N/A';
                document.getElementById('detailVnpayStatus').textContent = payment.vnpayTransactionStatus || 'N/A';
                document.getElementById('detailVnpayDate').textContent = payment.vnpayTransactionDate ? formatDate(payment.vnpayTransactionDate) : 'N/A';
            } else {
                vnpaySection.style.display = 'none';
            }
            
            // Notes (if applicable)
            const notesSection = document.getElementById('notesSection');
            if (payment.notes) {
                notesSection.style.display = 'block';
                document.getElementById('detailNotes').textContent = payment.notes;
            } else {
                notesSection.style.display = 'none';
            }
            
            // Description
            document.getElementById('detailDescription').textContent = payment.fundCollectionRequest?.description || 'No description provided';
            
            // Confirmed by (if applicable)
            const confirmedBySection = document.getElementById('confirmedBySection');
            if (payment.confirmedByName) {
                confirmedBySection.style.display = 'block';
                document.getElementById('detailConfirmedBy').textContent = payment.confirmedByName;
            } else {
                confirmedBySection.style.display = 'none';
            }
            
            // Re-initialize Lucide icons
            setTimeout(() => initLucide(), 100);
        }

        // Show Toast Notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
            toast.style.zIndex = '9999';
            toast.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        // ============================================
        // Export Functionality
        // ============================================

        // Export Payment History to CSV
        function exportPaymentHistory() {
            try {
                // Get currently filtered payments
                const filtered = getFilteredPayments();
                
                if (filtered.length === 0) {
                    showToast('No payments to export', 'warning');
                    return;
                }
                
                // CSV headers
                const headers = ['Date', 'Purpose', 'Transaction ID', 'Method', 'Amount (VND)', 'Status'];
                
                // CSV rows
                const rows = filtered.map(payment => {
                    const date = payment.paidAt ? formatDate(payment.paidAt) : 'N/A';
                    const purpose = payment.fundCollectionRequest?.title || 'N/A';
                    const txnId = getTransactionId(payment);
                    const method = payment.paymentMethod || 'N/A';
                    const amount = payment.amount;
                    const status = payment.status === 'paid' || payment.status === 'confirmed' ? 'Completed' : payment.status;
                    
                    return [date, purpose, txnId, method, amount, status];
                });
                
                // Generate CSV content
                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => {
                        // Escape quotes and wrap in quotes if contains comma
                        const cellStr = String(cell).replace(/"/g, '""');
                        return cellStr.includes(',') ? `"${cellStr}"` : cellStr;
                    }).join(','))
                ].join('\n');
                
                // Create blob and download
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                // Generate filename
                const clubName = '@Model.Club?.Name'.replace(/[^a-z0-9]/gi, '-').toLowerCase() || 'club';
                const date = new Date().toISOString().split('T')[0];
                const filename = `payment-history-${clubName}-${date}.csv`;
                
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showToast('Payment history exported successfully', 'success');
            } catch (error) {
                console.error('Error exporting payment history:', error);
                showToast('Failed to export payment history', 'danger');
            }
        }

        // Initialize Lucide icons
        function initLucide() {
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                try {
                    lucide.createIcons();
                    console.log('Lucide icons created successfully');
                } catch (e) {
                    console.error('Error creating Lucide icons:', e);
                }
            } else {
                console.log('Lucide not ready, retrying...');
                setTimeout(initLucide, 50);
            }
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', async () => {
            await updateMemberDashboardAuthUI();
            
            // Load finance data if on finance section
            const urlParams = new URLSearchParams(window.location.search);
            const section = urlParams.get('section');
            if (section === 'finance') {
                await loadMyPayments();
            }
            
            // Add event listeners for payment history filters
            const historySearchInput = document.getElementById('historySearchInput');
            const historyStatusFilter = document.getElementById('historyStatusFilter');
            
            if (historySearchInput) {
                // Debounce search input to avoid excessive filtering
                const debouncedFilter = debounce(filterPaymentHistory, 300);
                historySearchInput.addEventListener('input', debouncedFilter);
            }
            
            if (historyStatusFilter) {
                historyStatusFilter.addEventListener('change', filterPaymentHistory);
            }

            // Add event listener for history tab to render when shown
            const historyTab = document.getElementById('history-tab');
            if (historyTab) {
                historyTab.addEventListener('shown.bs.tab', function() {
                    if (allPayments && allPayments.length > 0) {
                        filterPaymentHistory();
                    }
                });
            }
            
            initLucide();
            setTimeout(initLucide, 300);
            setTimeout(initLucide, 1000);
        });
        
        // Initialize icons immediately
        initLucide();
    </script>

    <style>
        .bg-gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</body>
</html>

