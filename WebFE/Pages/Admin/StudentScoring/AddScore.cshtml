@page
@model WebFE.Pages.Admin.StudentScoring.AddScoreModel
@{
    ViewData["Title"] = "Add Activity Score";
    ViewData["Breadcrumb"] = "Add Score";
    Layout = "~/Pages/Shared/_AdminLayout.cshtml";
}

<!-- Page Header -->
<div class="page-header mb-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div>
            <h1 class="page-title">
                <i data-lucide="plus-circle" style="width: 28px; height: 28px; display: inline-block; vertical-align: middle; margin-right: 0.5rem;"></i>
                Add Activity Score
            </h1>
            <p class="page-description">Add activity points for a student</p>
        </div>
        <div>
            <a href="/Admin/StudentScoring" class="btn btn-outline-secondary">
                <i data-lucide="arrow-left" style="width: 16px; height: 16px;"></i>
                Back
            </a>
        </div>
    </div>
</div>

<!-- Alert Messages -->
@if (!string.IsNullOrEmpty(Model.SuccessMessage))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i data-lucide="check-circle" style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 0.5rem;"></i>
        @Model.SuccessMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i data-lucide="alert-circle" style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 0.5rem;"></i>
        @Model.ErrorMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Add Score Form Card -->
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0 fw-semibold">
                    <i data-lucide="edit-3" style="width: 20px; height: 20px;"></i>
                    Score information
                </h5>
            </div>
            <div class="card-body p-4">
                <form method="post">

                    <!-- Student Selection -->
                    <div class="mb-4">
                        <label for="StudentId" class="form-label fw-semibold">
                            <i data-lucide="users" style="width: 16px; height: 16px; margin-right: 6px;"></i>
                            Student <span class="text-danger">*</span>
                        </label>
                        <select asp-for="StudentId" class="form-select form-select-lg" id="StudentId" required onchange="updateStudentDisplay()">
                            <option value="">-- Select a student --</option>
                            @foreach (var student in Model.Students)
                            {
                                var displayName = string.IsNullOrEmpty(student.FullName) ? "Unknown name" : student.FullName;
                                var displayCode = student.StudentCode ?? "N/A";
                                <option value="@student.Id" selected="@(Model.PreSelectedStudentId == student.Id)">
                                    @displayName (@displayCode)
                                </option>
                            }
                        </select>
                        <small class="text-muted d-block mt-2">
                            <i data-lucide="info" style="width: 14px; height: 14px;"></i>
                            Select the student to add points for
                        </small>
                    </div>

                    <!-- Selected Student Info Display -->
                    <div id="studentInfoBox" class="alert alert-light border border-info @(Model.PreSelectedStudentId.HasValue ? "" : "d-none") mb-4">
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle bg-info bg-opacity-10 p-2 me-3">
                                <i data-lucide="user-check" style="width: 24px; height: 24px; color: #0d6efd;"></i>
                            </div>
                            <div>
                                <h6 class="mb-1 fw-semibold" id="studentNameDisplay">
                                    @(Model.PreSelectedStudentName ?? "No student selected")
                                </h6>
                                <small class="text-muted" id="studentCodeDisplay">
                                    Student code: @(Model.PreSelectedStudentCode ?? "---")
                                </small>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- Group Selection -->
                    <div class="mb-4">
                        <label for="GroupId" class="form-label fw-semibold">
                            <i data-lucide="folder" style="width: 16px; height: 16px; margin-right: 6px;"></i>
                            Category <span class="text-danger">*</span>
                        </label>
                        <select asp-for="GroupId" class="form-select form-select-lg" id="GroupId" required onchange="updateCriteriaDropdown()">
                            <option value="">-- Select a category --</option>
                            @foreach (var group in Model.Groups)
                            {
                                <option value="@group.Id" data-max="@group.MaxScore">
                                    @group.Name (Max: @group.MaxScore points)
                                </option>
                            }
                        </select>
                        <small class="text-muted d-block mt-2">
                            <i data-lucide="info" style="width: 14px; height: 14px;"></i>
                            Choose a category first, then select a specific criterion
                        </small>
                    </div>

                    <!-- Criterion Selection (dependent on Group) -->
                    <div class="mb-4">
                        <label for="CriterionId" class="form-label fw-semibold">
                            <i data-lucide="list" style="width: 16px; height: 16px; margin-right: 6px;"></i>
                            Criterion <span class="text-danger">*</span>
                        </label>
                        <select asp-for="CriterionId" class="form-select form-select-lg" id="CriterionId" required disabled onchange="updateScoreHint()">
                            <option value="">-- Select category first --</option>
                        </select>
                        <small class="text-muted d-block mt-2" id="criterionHint">
                            <i data-lucide="info" style="width: 14px; height: 14px;"></i>
                            Criteria will be shown after selecting a category
                        </small>
                    </div>

                    <!-- Score Input -->
                    <div class="mb-4">
                        <label for="Score" class="form-label fw-semibold">
                            <i data-lucide="award" style="width: 16px; height: 16px; margin-right: 6px;"></i>
                            Score <span class="text-danger">*</span>
                        </label>
                        <input asp-for="Score" type="number" class="form-control" id="Score" min="0" max="100" step="0.5" placeholder="Enter score (e.g.: 5, 10, 15)" required>
                        <small class="text-muted d-block mt-2" id="scoreHint">
                            <i data-lucide="info" style="width: 14px; height: 14px;"></i>
                            Criterion limits will be displayed after selecting a criterion
                        </small>
                    </div>

                    <!-- Comments (Note) -->
                    <div class="mb-4">
                        <label for="Comments" class="form-label fw-semibold">
                            <i data-lucide="sticky-note" style="width: 16px; height: 16px; margin-right: 6px;"></i>
                            Comments <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="Comments" name="Comments" rows="3" minlength="10" placeholder="Describe reason for scoring, evidence, form reference..."></textarea>
                        <small class="text-muted d-block mt-2">
                            Required minimum 10 characters. Will be stored in the score details (Note).
                        </small>
                    </div>

                    <!-- Advanced: Optional ActivityId for traceability -->
                    <div class="mb-4">
                        <a class="text-decoration-none" data-bs-toggle="collapse" href="#advancedBox" role="button" aria-expanded="false" aria-controls="advancedBox">
                            <i data-lucide="chevron-down"></i> Advanced options
                        </a>
                        <div class="collapse mt-2" id="advancedBox">
                            <label for="ActivityId" class="form-label fw-semibold">ActivityId (optional)</label>
                            <input type="number" class="form-control" id="ActivityId" name="ActivityId" placeholder="Enter ActivityId if available (for dedupe/trace)">
                            <small class="text-muted d-block mt-2">If related to a specific activity, enter ActivityId to record the source.</small>
                        </div>
                    </div>

                    <!-- Info Box -->
                    <div class="alert alert-info bg-info bg-opacity-10 border-0">
                        <div class="d-flex">
                            <i data-lucide="alert-circle" style="width: 18px; height: 18px; margin-right: 10px; color: #0d6efd; flex-shrink: 0; margin-top: 2px;"></i>
                            <div>
                                <strong>Important notes:</strong>
                                <ul class="mb-0 mt-2 ms-2">
                                    <li>üìÖ <strong>Award date:</strong> Defaults to today</li>
                                    <li>üîÑ <strong>Accumulation:</strong> Multiple additions for the same criterion are allowed</li>
                                    <li>‚öñÔ∏è <strong>Limits:</strong> According to criterion and group max</li>
                                    <li>üìù <strong>Comments:</strong> Required for audit (visible in details)</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- Form Actions -->
                    <div class="d-flex justify-content-between align-items-center">
                        <a href="/Admin/StudentScoring" class="btn btn-outline-secondary">
                            <i data-lucide="x" style="width: 16px; height: 16px;"></i>
                            Cancel
                        </a>
                        <button type="submit" class="btn btn-warning btn-lg fw-bold">
                            <i data-lucide="check-circle" style="width: 18px; height: 18px;"></i>
                            Confirm Add Score
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // All criteria data from server
        const allCriteria = @Html.Raw(Json.Serialize(Model.AllCriteria));

        function safeCreateLucide(){ if(window.lucide && typeof lucide.createIcons==='function'){ try{ lucide.createIcons(lucide.icons||{});}catch{}} }
        document.addEventListener('DOMContentLoaded', safeCreateLucide);
        window.addEventListener('load', safeCreateLucide);

        function updateStudentDisplay() {
            const studentSelect = document.getElementById('StudentId');
            const selectedOption = studentSelect.options[studentSelect.selectedIndex];
            const studentInfoBox = document.getElementById('studentInfoBox');

            if (studentSelect.value) {
                const fullText = selectedOption.textContent;
                const match = fullText.match(/\(([^)]+)\)/);
                const code = match ? match[1] : 'N/A';
                const name = fullText.replace(/\s*\([^)]*\)/, '').trim();

                document.getElementById('studentNameDisplay').textContent = name;
                document.getElementById('studentCodeDisplay').textContent = 'Student code: ' + code;
                studentInfoBox.classList.remove('d-none');
            } else {
                studentInfoBox.classList.add('d-none');
            }

            safeCreateLucide();
        }

        function updateCriteriaDropdown() {
            const groupSelect = document.getElementById('GroupId');
            const criterionSelect = document.getElementById('CriterionId');
            const criterionHint = document.getElementById('criterionHint');
            const scoreHint = document.getElementById('scoreHint');
            const selectedGroupId = parseInt(groupSelect.value);

            // Clear current options
            criterionSelect.innerHTML = '<option value="">-- Select a criterion --</option>';

            if (selectedGroupId) {
                // Filter criteria by selected group
                const filteredCriteria = allCriteria.filter(c => c.groupId === selectedGroupId);

                if (filteredCriteria.length > 0) {
                    // Add filtered criteria to dropdown
                    filteredCriteria.forEach(criterion => {
                        const option = document.createElement('option');
                        option.value = criterion.id;
                        option.setAttribute('data-max', criterion.maxScore);
                        if (criterion.minScore !== null && criterion.minScore !== undefined) {
                            option.setAttribute('data-min', criterion.minScore);
                            option.textContent = `${criterion.title} (Min: ${criterion.minScore} - Max: ${criterion.maxScore})`;
                        } else {
                            option.textContent = `${criterion.title} (Max: ${criterion.maxScore} points)`;
                        }
                        criterionSelect.appendChild(option);
                    });

                    criterionSelect.disabled = false;
                    criterionHint.innerHTML = '<i data-lucide="info" style="width: 14px; height: 14px;"></i> Loaded ' + filteredCriteria.length + ' criteria for this category';
                } else {
                    criterionSelect.disabled = true;
                    criterionHint.innerHTML = '<i data-lucide="alert-circle" style="width: 14px; height: 14px;"></i> This category has no criteria yet';
                }

                // Update criterion max score hint (will be updated when selecting a criterion)
                scoreHint.innerHTML = '<i data-lucide="info" style="width: 14px; height: 14px;"></i> Select a criterion to see specific limits';

                // Reset score hint and validate current score
                updateScoreHint();
                validateScore();
            } else {
                criterionSelect.disabled = true;
                criterionSelect.innerHTML = '<option value="">-- Select a category first --</option>';
                criterionHint.innerHTML = '<i data-lucide="info" style="width: 14px; height: 14px;"></i> Criteria will be displayed after selecting a category';
                scoreHint.innerHTML = '<i data-lucide="info" style="width: 14px; height: 14px;"></i> Range: 0 - 100 (will error if exceeding criterion or group limits)';
            }

            safeCreateLucide();
        }

        function updateScoreHint() {
            const criterionSelect = document.getElementById('CriterionId');
            const scoreHint = document.getElementById('scoreHint');
            const selectedOption = criterionSelect.options[criterionSelect.selectedIndex];

            if (criterionSelect.value) {
                const criterionMaxScore = selectedOption.getAttribute('data-max');
                const criterionMinScore = selectedOption.getAttribute('data-min');
                if (criterionMinScore) {
                    scoreHint.innerHTML = `<i data-lucide="info" style="width: 14px; height: 14px;"></i> Score range: ${criterionMinScore} - ${criterionMaxScore} points / time`;
                    document.getElementById('Score').setAttribute('min', criterionMinScore);
                    document.getElementById('Score').setAttribute('max', criterionMaxScore);
                } else {
                    scoreHint.innerHTML = `<i data-lucide="info" style="width: 14px; height: 14px;"></i> Criterion limit: maximum ${criterionMaxScore} points / time`;
                    document.getElementById('Score').setAttribute('min', '0');
                    document.getElementById('Score').setAttribute('max', criterionMaxScore);
                }
            } else {
                scoreHint.innerHTML = '<i data-lucide="info" style="width: 14px; height: 14px;"></i> Select a criterion to see specific limits';
            }
        }

        // Validation on frontend
        function validateScore() {
            const criterionSelect = document.getElementById('CriterionId');
            const scoreInput = document.getElementById('Score');
            const scoreHint = document.getElementById('scoreHint');

            if (criterionSelect.value && scoreInput.value) {
                const selectedOption = criterionSelect.options[criterionSelect.selectedIndex];
                const criterionMaxScore = parseFloat(selectedOption.getAttribute('data-max'));
                const criterionMinScore = parseFloat(selectedOption.getAttribute('data-min'));
                const inputScore = parseFloat(scoreInput.value);

                if (!isNaN(criterionMinScore) && inputScore < criterionMinScore) {
                    scoreHint.innerHTML = `<i data-lucide="alert-circle" style="width: 14px; height: 14px; color: red;"></i> <span style="color: red;">Error: entered score (${inputScore}) is less than the minimum (${criterionMinScore})</span>`;
                    scoreInput.classList.add('is-invalid');
                    return false;
                } else if (inputScore > criterionMaxScore) {
                    scoreHint.innerHTML = `<i data-lucide="alert-circle" style="width: 14px; height: 14px; color: red;"></i> <span style="color: red;">Error: entered score (${inputScore}) exceeds criterion limit (${criterionMaxScore} points)</span>`;
                    scoreInput.classList.add('is-invalid');
                    return false;
                } else {
                    scoreHint.innerHTML = `<i data-lucide="check-circle" style="width: 14px; height: 14px; color: green;"></i> <span style="color: green;">Score is valid</span>`;
                    scoreInput.classList.remove('is-invalid');
                    return true;
                }
            }
            return true;
        }

        document.addEventListener('DOMContentLoaded', function() {
            const scoreInput = document.getElementById('Score');
            if (scoreInput) {
                scoreInput.addEventListener('input', validateScore);
                scoreInput.addEventListener('blur', validateScore);
            }
        });
    </script>
}

<style>
    .page-header {
        padding-bottom: 1rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .card {
        transition: all 0.3s ease;
    }

    .is-invalid {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    }

    .validation-error {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    .validation-success {
        color: #28a745;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    .form-label {
        margin-bottom: 0.5rem;
    }

    .alert ul {
        padding-left: 1rem;
    }

    .alert li {
        margin-bottom: 0.5rem;
    }
</style>
