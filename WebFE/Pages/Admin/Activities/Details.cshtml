@page "{id:int}"
@model WebFE.Pages.Admin.Activities.DetailsModel
@{
    ViewData["Title"] = "Activity Details";
    Layout = "~/Pages/Shared/_AdminLayout.cshtml";
    var activity = Model.Activity!;
}

<div class="container-fluid px-4 py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1 fw-bold">Activity Details</h2>
            <p class="text-muted mb-0">Detailed information about this activity</p>
        </div>
        <div>
            <a class="btn btn-outline-secondary me-2" href="/Admin/Activities">
                <i class="bi bi-arrow-left me-2"></i>Back to List
            </a>
            <a class="btn btn-primary" href="/Admin/Activities/Edit/@activity.Id">
                <i class="bi bi-pencil-square me-2"></i>Edit
            </a>
        </div>
    </div>

    <div class="row g-4">
        <!-- Main Information Card -->
        <div class="col-lg-8">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body p-4">
                    <h3 class="fw-bold mb-3">@activity.Title</h3>
                    
                    @if (!string.IsNullOrWhiteSpace(activity.ImageUrl))
                    {
                        <img src="@activity.ImageUrl" class="img-fluid rounded mb-4" style="max-height: 300px; width: 100%; object-fit: cover;" alt="@activity.Title" />
                    }
                    
                    <div class="mb-4">
                        <h5 class="fw-semibold mb-3">Description</h5>
                        <p class="text-muted" style="white-space: pre-wrap;">@(activity.Description ?? "No description provided")</p>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="p-3 bg-light rounded">
                                <small class="text-muted d-block mb-1">Type</small>
                                <span class="badge bg-info">@activity.Type</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3 bg-light rounded">
                                <small class="text-muted d-block mb-1">Status</small>
                                @{
                                    var statusClass = activity.Status switch
                                    {
                                        "Approved" => "success",
                                        "PendingApproval" => "warning",
                                        "Rejected" => "danger",
                                        "Completed" => "secondary",
                                        _ => "secondary"
                                    };
                                }
                                <span class="badge bg-@statusClass">@activity.Status</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3 bg-light rounded">
                                <small class="text-muted d-block mb-1">Visibility</small>
                                @if (activity.IsPublic)
                                {
                                    <span class="badge bg-success">Public</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Private</span>
                                }
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3 bg-light rounded">
                                <small class="text-muted d-block mb-1">Movement Points</small>
                                <strong class="text-success">+@activity.MovementPoint points</strong>
                            </div>
                        </div>
                    </div>

                    @* Display rejection reason if activity is rejected *@
                    @if (activity.Status == "Rejected" && !string.IsNullOrWhiteSpace(activity.RejectionReason))
                    {
                        <div class="alert alert-danger mt-4 mb-0" role="alert">
                            <div class="d-flex">
                                <i class="bi bi-exclamation-circle-fill me-3 fs-5" style="flex-shrink: 0;"></i>
                                <div>
                                    <h6 class="alert-heading mb-2 fw-bold">Rejection Reason</h6>
                                    <p class="mb-0" style="white-space: pre-wrap;">@activity.RejectionReason</p>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Location & Schedule Card -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body p-4">
                    <h5 class="fw-semibold mb-3">Schedule & Location</h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-calendar-event text-primary me-3 fs-5"></i>
                                <div>
                                    <small class="text-muted d-block">Start Time</small>
                                    <strong>@activity.StartTime.ToString("dddd, dd MMMM yyyy")</strong>
                                    <div class="text-muted">@activity.StartTime.ToString("HH:mm")</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-start">
                                <i class="bi bi-calendar-check text-success me-3 fs-5"></i>
                                <div>
                                    <small class="text-muted d-block">End Time</small>
                                    <strong>@activity.EndTime.ToString("dddd, dd MMMM yyyy")</strong>
                                    <div class="text-muted">@activity.EndTime.ToString("HH:mm")</div>
                                </div>
                            </div>
                        </div>
                        @if (!string.IsNullOrWhiteSpace(activity.Location))
                        {
                            <div class="col-12">
                                <div class="d-flex align-items-start">
                                    <i class="bi bi-geo-alt text-danger me-3 fs-5"></i>
                                    <div>
                                        <small class="text-muted d-block">Location</small>
                                        <strong>@activity.Location</strong>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Creator & Approval Information -->
            <div class="card shadow-sm border-0">
                <div class="card-body p-4">
                    <h5 class="fw-semibold mb-3">System Information</h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <small class="text-muted d-block mb-1">Created By</small>
                            <strong>@activity.CreatedByName</strong>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted d-block mb-1">Created At</small>
                            <strong>@activity.CreatedAt.ToString("dd/MM/yyyy HH:mm")</strong>
                        </div>
                        @if (activity.ApprovedById.HasValue)
                        {
                            <div class="col-md-6">
                                <small class="text-muted d-block mb-1">Approved By</small>
                                <strong>@activity.ApprovedByName</strong>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted d-block mb-1">Approved At</small>
                                <strong>@activity.ApprovedAt?.ToString("dd/MM/yyyy HH:mm")</strong>
                            </div>
                        }
                        <div class="col-md-6">
                            <small class="text-muted d-block mb-1">Requires Approval</small>
                            <strong>@(activity.RequiresApproval ? "Yes" : "No")</strong>
                        </div>
                        @if (activity.ClubId.HasValue)
                        {
                            <div class="col-md-6">
                                <small class="text-muted d-block mb-1">Club</small>
                                <strong>@activity.ClubName</strong>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar Statistics -->
        <div class="col-lg-4">
            <!-- Attendance Code Card -->
            @if (!string.IsNullOrWhiteSpace(activity.AttendanceCode))
            {
                <div class="card shadow-sm border-0 mb-4 bg-warning bg-opacity-10">
                    <div class="card-body p-4">
                        <h5 class="fw-semibold mb-3">
                            <i class="bi bi-qr-code-scan me-2"></i>Attendance Code
                        </h5>
                        <div class="text-center">
                            <div class="bg-white rounded p-3 mb-3">
                                <code class="fs-3 fw-bold" style="letter-spacing: 0.3em; color: #333;">@activity.AttendanceCode</code>
                            </div>
                            <button class="btn btn-warning w-100" onclick="copyAttendanceCode(event, '@Html.Raw(activity.AttendanceCode)')">
                                <i class="bi bi-clipboard me-2"></i>Copy Code
                            </button>
                            <small class="text-muted d-block mt-2">Share this code with students for self check-in</small>
                        </div>
                    </div>
                </div>
            }
            
            <!-- Participation Stats -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body p-4">
                    <h5 class="fw-semibold mb-3">Participation Statistics</h5>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">Capacity</span>
                            <strong>@activity.CurrentParticipants @(activity.MaxParticipants.HasValue ? $"/ {activity.MaxParticipants}" : "")</strong>
                        </div>
                        @if (activity.MaxParticipants.HasValue)
                        {
                            var percentage = (activity.CurrentParticipants * 100.0 / activity.MaxParticipants.Value);
                            var progressClass = percentage >= 90 ? "bg-danger" : percentage >= 70 ? "bg-warning" : "bg-success";
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar @progressClass" role="progressbar" style="width: @percentage%"></div>
                            </div>
                        }
                    </div>

                    <div class="row g-3 text-center">
                        <div class="col-4">
                            <div class="p-3 bg-light rounded">
                                <h4 class="mb-1 text-primary">@activity.RegisteredCount</h4>
                                <small class="text-muted">Registered</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-3 bg-light rounded">
                                <h4 class="mb-1 text-success">@activity.AttendedCount</h4>
                                <small class="text-muted">Attended</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-3 bg-light rounded">
                                <h4 class="mb-1 text-info">@activity.FeedbackCount</h4>
                                <small class="text-muted">Feedback</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card shadow-sm border-0">
                <div class="card-body p-4">
                    <h5 class="fw-semibold mb-3">Quick Actions</h5>
                    <div class="d-grid gap-2">
                        <a href="/Admin/Activities/Edit/@activity.Id" class="btn btn-outline-primary">
                            <i class="bi bi-pencil-square me-2"></i>Edit Activity
                        </a>
                        @if (!activity.ClubId.HasValue)
                        {
                            <a href="/Admin/Activities/Attendances/@activity.Id" class="btn btn-outline-success">
                                <i class="bi bi-clipboard-check me-2"></i>Attendances
                            </a>
                        }
                        <a href="/Admin/Activities/Feedbacks/@activity.Id" class="btn btn-outline-info">
                            <i class="bi bi-chat-dots me-2"></i>View Feedback
                        </a>
                        <button class="btn btn-outline-danger" onclick="confirmDelete(@activity.Id, '@activity.Title')">
                            <i class="bi bi-trash3 me-2"></i>Delete Activity
                        </button>
                        <a href="/Admin/Activities" class="btn btn-outline-secondary">
                            <i class="bi bi-list me-2"></i>Back to List
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold" id="deleteModalLabel">
                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>Confirm Delete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2">Are you sure you want to delete this activity?</p>
                <p class="fw-semibold text-primary mb-0" id="activityTitle"></p>
                <p class="text-muted small mt-2">This action cannot be undone.</p>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="bi bi-trash me-2"></i>Delete
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let deleteId = null;
    
    function confirmDelete(id, title) {
        deleteId = id;
        document.getElementById('activityTitle').textContent = title;
        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        modal.show();
    }
    
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        if (deleteId) {
            window.location.href = '/Admin/Activities/Delete/' + deleteId;
        }
    });
    
    function copyAttendanceCode(evt, code) {
        navigator.clipboard.writeText(code).then(function() {
            // Show success feedback
            const btn = evt.target.closest('button');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check2 me-2"></i>Copied!';
            btn.classList.remove('btn-warning');
            btn.classList.add('btn-success');
            
            // Show success message
            showToast('Success', 'success');
            
            setTimeout(function() {
                btn.innerHTML = originalHtml;
                btn.classList.remove('btn-success');
                btn.classList.add('btn-warning');
            }, 2000);
        }).catch(function(err) {
            showToast('Không thể copy mã', 'danger');
        });
    }
    
    function showToast(message, type) {
        // Validate parameters
        if (!message) message = 'Thao tác thành công';
        if (!type) type = 'success';
        
        // Create toast container if not exists
        let toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toastContainer';
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '9999';
            document.body.appendChild(toastContainer);
        }
        
        // Choose icon based on type
        const icon = type === 'success' ? 'bi-check-circle-fill' : 'bi-exclamation-circle-fill';
        
        // Create toast element
        const toastId = 'toast-' + Date.now();
        const toastDiv = document.createElement('div');
        toastDiv.id = toastId;
        toastDiv.className = `toast align-items-center text-white bg-${type} border-0`;
        toastDiv.setAttribute('role', 'alert');
        toastDiv.setAttribute('aria-live', 'assertive');
        toastDiv.setAttribute('aria-atomic', 'true');
        
        toastDiv.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi ${icon} me-2"></i>${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        toastContainer.appendChild(toastDiv);
        const toast = new bootstrap.Toast(toastDiv, { delay: 3000 });
        toast.show();
        
        // Remove toast element after it's hidden
        toastDiv.addEventListener('hidden.bs.toast', function() {
            toastDiv.remove();
        });
    }
</script>

