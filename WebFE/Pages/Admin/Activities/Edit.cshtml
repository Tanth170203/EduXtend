@page "{id:int}"
@model WebFE.Pages.Admin.Activities.EditModel
@{
    ViewData["Title"] = "Edit Activity";
    Layout = "~/Pages/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid px-4 py-4">
    <div class="mb-4">
        <h2 class="mb-1 fw-bold">Edit Activity</h2>
        <p class="text-muted mb-0">Update activity information</p>
    </div>

    <form method="post">
        <input type="hidden" asp-for="Input.Id" />
        <div class="card shadow-sm border-0">
            <div class="card-body p-4">
                <div class="row g-4">
                    <div class="col-md-8">
                        <label asp-for="Input.Title" class="form-label fw-semibold">Title <span class="text-danger">*</span></label>
                        <input asp-for="Input.Title" class="form-control form-control-lg" placeholder="Enter activity title" />
                        <span asp-validation-for="Input.Title" class="text-danger small"></span>
                    </div>
                    <div class="col-md-4">
                        <label asp-for="Input.Type" class="form-label fw-semibold">Type <span class="text-danger">*</span></label>
                        <select asp-for="Input.Type" class="form-select form-select-lg" id="activityTypeSelect">
                            <optgroup label="Events">
                                <option value="3">Large Event (100-200 people) - 20 points</option>
                                <option value="4">Medium Event (50-100 people) - 15 points</option>
                                <option value="5">Small Event (&lt;50 people) - 5 points</option>
                            </optgroup>
                            <optgroup label="Competitions">
                                <option value="6">School Competition (5-10 points)</option>
                                <option value="7">Provincial Competition - 20 points</option>
                                <option value="8">National Competition - 30 points</option>
                            </optgroup>
                            <optgroup label="Collaboration">
                                <option value="10">Club Collaboration (1-10 points)</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <div class="col-12">
                        <label asp-for="Input.Description" class="form-label fw-semibold">Description</label>
                        <textarea asp-for="Input.Description" class="form-control" rows="5" placeholder="Describe the activity..."></textarea>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="Input.Location" class="form-label fw-semibold">Location</label>
                        <input asp-for="Input.Location" class="form-control" placeholder="Room 101, Building A" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Activity Image</label>
                        <input type="file" class="form-control" id="imageFile" accept="image/*" />
                        <input type="hidden" asp-for="Input.ImageUrl" />
                        
                        @if (!string.IsNullOrEmpty(Model.Input.ImageUrl))
                        {
                            <div id="imagePreview" class="mt-2">
                                <img id="previewImg" src="@Model.Input.ImageUrl" class="rounded" style="max-width: 100%; max-height: 200px;" />
                                <button type="button" class="btn btn-sm btn-outline-danger mt-2" id="removeImageBtn">Remove</button>
                            </div>
                        }
                        else
                        {
                            <div id="imagePreview" class="mt-2" style="display:none;">
                                <img id="previewImg" src="#" class="rounded" style="max-width: 100%; max-height: 200px;" />
                                <button type="button" class="btn btn-sm btn-outline-danger mt-2" id="removeImageBtn">Remove</button>
                            </div>
                        }
                        <div class="form-text">Upload an image from your device</div>
                        <div id="imageUploadStatus" class="small text-muted mt-1"></div>
                    </div>
                    
                    <div class="col-md-6">
                        <label asp-for="Input.StartTime" class="form-label fw-semibold">Start Time <span class="text-danger">*</span></label>
                        <input asp-for="Input.StartTime" asp-format="{0:yyyy-MM-ddTHH:mm}" type="datetime-local" class="form-control" step="60" />
                    </div>
                    <div class="col-md-6">
                        <label asp-for="Input.EndTime" class="form-label fw-semibold">End Time <span class="text-danger">*</span></label>
                        <input asp-for="Input.EndTime" asp-format="{0:yyyy-MM-ddTHH:mm}" type="datetime-local" class="form-control" step="60" />
                    </div>
                    
                    <div class="col-md-4">
                        <label asp-for="Input.MaxParticipants" class="form-label fw-semibold">Max Participants <span class="text-danger">*</span></label>
                        <input asp-for="Input.MaxParticipants" type="number" class="form-control" id="MaxParticipantsInput" min="1" required />
                        <span asp-validation-for="Input.MaxParticipants" class="text-danger"></span>
                        <div class="form-text">Maximum number of participants</div>
                        <span class="text-danger small" id="MaxParticipantsError"></span>
                    </div>
                    <div class="col-md-6" id="clubCollaborationSection" style="display: none;">
                        <label class="form-label fw-semibold">Collaborating Club</label>
                        <input type="hidden" asp-for="Input.ClubCollaborationId" id="ClubCollaborationIdInput" />
                        <input type="hidden" asp-for="Input.CollaboratingClubName" id="CollaboratingClubNameHidden" />
                        <div class="input-group">
                            <input type="text" class="form-control" id="selectedClubName" placeholder="No club selected" readonly />
                            <button type="button" class="btn btn-outline-primary" id="selectClubBtn">
                                <i class="bi bi-search me-1"></i>Select Club
                            </button>
                        </div>
                        <div class="form-text">Select a club to collaborate with</div>
                        <span class="text-danger small" id="ClubCollaborationError"></span>
                    </div>
                    
                    <div class="col-md-3" id="collaborationPointSection" style="display: none;">
                        <label asp-for="Input.CollaborationPoint" class="form-label fw-semibold">Collaboration Points</label>
                        <input asp-for="Input.CollaborationPoint" type="number" class="form-control" id="CollaborationPointInput" placeholder="1-3" min="1" max="3" />
                        <div class="form-text">Points for collaborating club (1-3)</div>
                        <span asp-validation-for="Input.CollaborationPoint" class="text-danger small"></span>
                        <span class="text-danger small" id="CollaborationPointError"></span>
                    </div>
                    
                    <div class="col-md-3" id="movementPointSection">
                        <label asp-for="Input.MovementPoint" class="form-label fw-semibold">Movement Points <span class="text-danger">*</span></label>
                        <input asp-for="Input.MovementPoint" type="number" step="0.5" class="form-control" id="MovementPointInput" placeholder="0" min="0" required />
                        <div class="form-text" id="MovementPointHint">Points will be auto-filled based on activity type</div>
                        <span class="text-danger small" id="MovementPointError"></span>
                    </div>
                    
                    <div class="col-md-4 d-flex align-items-center">
                        <div class="form-check form-switch">
                            <input asp-for="Input.IsPublic" class="form-check-input" role="switch" style="width: 3em; height: 1.5em;" />
                            <label asp-for="Input.IsPublic" class="form-check-label fw-semibold ms-2">Public Activity</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Schedule & Task Assignments -->
            <div id="scheduleManagementSection" style="display: none;">
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-light border-0 p-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 fw-semibold">Activity Schedule & Task Assignments</h5>
                            <button type="button" id="addScheduleBtn" class="btn btn-sm btn-primary">
                                <i class="bi bi-plus-circle me-1"></i>
                                Add Schedule Item
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <div id="scheduleList">
                            <!-- Schedule items will be dynamically added here -->
                        </div>
                        <div id="noSchedulesMessage" class="text-muted text-center py-4">
                            <i class="bi bi-calendar3" style="font-size: 2rem;"></i>
                            <p class="mt-2 mb-0">No schedule items yet. Click "Add Schedule Item" to create a timeline for this activity.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-footer bg-light border-0 p-4 d-flex justify-content-between">
                    <a class="btn btn-lg btn-outline-secondary px-4" href="/Admin/Activities">
                        <i class="bi bi-x-circle me-2"></i>Cancel
                    </a>
                    <button class="btn btn-lg btn-primary px-4" type="submit">
                        <i class="bi bi-save me-2"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<partial name="_ClubSelectionModal" />

<script>
    // ===== Collaboration Fields Management =====
    const clubCollaborationSection = document.getElementById('clubCollaborationSection');
    const collaborationPointSection = document.getElementById('collaborationPointSection');
    const movementPointSection = document.getElementById('movementPointSection');
    const clubCollaborationIdInput = document.getElementById('ClubCollaborationIdInput');
    const collaborationPointInput = document.getElementById('CollaborationPointInput');
    const selectedClubNameInput = document.getElementById('selectedClubName');
    const selectClubBtn = document.getElementById('selectClubBtn');
    const clubCollaborationError = document.getElementById('ClubCollaborationError');
    const collaborationPointError = document.getElementById('CollaborationPointError');
    const collaboratingClubNameHidden = document.getElementById('CollaboratingClubNameHidden');
    
    // ===== Auto-fill Movement Points based on Activity Type =====
    const activityTypeSelect = document.getElementById('activityTypeSelect');
    const movementPointInput = document.getElementById('MovementPointInput');
    const movementPointHint = document.getElementById('MovementPointHint');
    const movementPointError = document.getElementById('MovementPointError');

    // Points mapping based on activity type (Admin - no Club Activities)
    const activityPoints = {
        // Events
        '3': { fixed: 20, hint: 'Large Event (100-200 people): 20 points' },
        '4': { fixed: 15, hint: 'Medium Event (50-100 people): 15 points' },
        '5': { fixed: 5, hint: 'Small Event (<50 people): 5 points' },
        
        // Competitions
        '6': { min: 5, max: 10, hint: 'School Competition: 5-10 points (depending on scale and nature)' },
        '7': { fixed: 20, hint: 'Provincial Competition: 20 points' },
        '8': { fixed: 30, hint: 'National Competition: 30 points' },
        
        // Collaboration
        '10': { min: 1, max: 10, hint: 'Club Collaboration - Organizer role: 1-10 points (based on 5-10 organizing members)' }
    };

    function updateCollaborationFieldsVisibility() {
        const selectedType = activityTypeSelect.value;
        const isClubCollaboration = selectedType === '10';
        const isCollaborationType = isClubCollaboration;
        
        // Show/hide collaboration fields for Admin
        if (isCollaborationType) {
            clubCollaborationSection.style.display = 'block';
            collaborationPointSection.style.display = 'block';
            movementPointSection.style.display = 'none';
            
            // Clear movement point for collaboration activities (Admin doesn't set it)
            movementPointInput.value = '';
            movementPointInput.removeAttribute('required');
            
            // Load existing club name if available
            if (collaboratingClubNameHidden.value) {
                selectedClubNameInput.value = collaboratingClubNameHidden.value;
            }
        } else {
            clubCollaborationSection.style.display = 'none';
            collaborationPointSection.style.display = 'none';
            movementPointSection.style.display = 'block';
            
            // Clear collaboration fields when switching away from collaboration type
            clubCollaborationIdInput.value = '';
            collaborationPointInput.value = '';
            selectedClubNameInput.value = '';
            clubCollaborationError.textContent = '';
            collaborationPointError.textContent = '';
            
            // Restore movement point requirement
            movementPointInput.setAttribute('required', 'required');
        }
    }
    
    function updateMovementPoints() {
        const selectedType = activityTypeSelect.value;
        const pointsConfig = activityPoints[selectedType];
        
        if (!pointsConfig) return;
        
        // Clear error
        movementPointError.textContent = '';
        
        // Don't override existing value on page load, only on type change
        if (pointsConfig.fixed !== undefined) {
            // For fixed points, update hint but keep manual override if exists
            movementPointInput.readOnly = false; // Allow manual override in edit mode
            movementPointInput.min = 0;
            movementPointInput.max = 1000;
        } else if (pointsConfig.min !== undefined && pointsConfig.max !== undefined) {
            // Range points
            movementPointInput.readOnly = false;
            movementPointInput.min = pointsConfig.min;
            movementPointInput.max = pointsConfig.max;
        }
        
        movementPointHint.textContent = pointsConfig.hint;
    }

    // Validate movement points on change
    function validateMovementPoints() {
        const selectedType = activityTypeSelect.value;
        const pointsConfig = activityPoints[selectedType];
        const value = parseFloat(movementPointInput.value);
        
        if (!pointsConfig) return true;
        
        if (pointsConfig.min !== undefined && pointsConfig.max !== undefined) {
            if (value < pointsConfig.min || value > pointsConfig.max) {
                movementPointError.textContent = `Points must be between ${pointsConfig.min} and ${pointsConfig.max}`;
                return false;
            }
        }
        
        movementPointError.textContent = '';
        return true;
    }

    // Max Participants validation
    const maxParticipantsInput = document.getElementById('MaxParticipantsInput');
    const maxParticipantsError = document.getElementById('MaxParticipantsError');

    function validateMaxParticipants(showRequiredError = false) {
        const selectedType = activityTypeSelect?.value;
        const value = parseInt(maxParticipantsInput?.value);
        
        // If empty, only show error if explicitly requested (on submit)
        if (!maxParticipantsInput?.value || maxParticipantsInput.value.trim() === '') {
            if (showRequiredError) {
                maxParticipantsError.textContent = 'Max Participants là bắt buộc';
                return false;
            }
            maxParticipantsError.textContent = '';
            return false;
        }
        
        // If invalid number
        if (isNaN(value) || value < 1) {
            maxParticipantsError.textContent = 'Vui lòng nhập số hợp lệ (>= 1)';
            return false;
        }

        // Large Event (100-200 people)
        if (selectedType === '3') {
            if (value < 100 || value > 200) {
                maxParticipantsError.textContent = 'Large Event phải có số người tham gia từ 100-200 người';
                return false;
            }
        }
        // Medium Event (50-100 people)
        else if (selectedType === '4') {
            if (value < 50 || value > 100) {
                maxParticipantsError.textContent = 'Medium Event phải có số người tham gia từ 50-100 người';
                return false;
            }
        }
        // Small Event (<50 people)
        else if (selectedType === '5') {
            if (value >= 50) {
                maxParticipantsError.textContent = 'Small Event phải có số người tham gia dưới 50 người';
                return false;
            }
        }

        maxParticipantsError.textContent = '';
        return true;
    }

    activityTypeSelect?.addEventListener('change', function() {
        updateCollaborationFieldsVisibility();
        updateMovementPoints();
        validateMaxParticipants();
        // Auto-fill on type change in edit mode
        const pointsConfig = activityPoints[this.value];
        if (pointsConfig) {
            if (pointsConfig.fixed !== undefined) {
                movementPointInput.value = pointsConfig.fixed;
            } else if (pointsConfig.min !== undefined) {
                movementPointInput.value = pointsConfig.min;
            }
        }
    });
    movementPointInput?.addEventListener('change', validateMovementPoints);
    movementPointInput?.addEventListener('input', validateMovementPoints);
    maxParticipantsInput?.addEventListener('change', validateMaxParticipants);
    maxParticipantsInput?.addEventListener('input', validateMaxParticipants);

    // Initial update (don't change value, just update hints)
    validateMaxParticipants();
    updateCollaborationFieldsVisibility();
    updateMovementPoints();
    
    // ===== Club Selection Modal Integration =====
    selectClubBtn?.addEventListener('click', function() {
        if (window.ClubSelectionModal) {
            window.ClubSelectionModal.show('@Model.ApiBaseUrl', 0, function(selectedClub) {
                clubCollaborationIdInput.value = selectedClub.id;
                selectedClubNameInput.value = selectedClub.name;
                clubCollaborationError.textContent = '';
            });
        }
    });
    
    // ===== Collaboration Point Validation =====
    collaborationPointInput?.addEventListener('input', function() {
        const value = parseInt(this.value);
        if (this.value && (value < 1 || value > 3)) {
            collaborationPointError.textContent = 'Collaboration points must be between 1 and 3';
        } else {
            collaborationPointError.textContent = '';
        }
    });

    // ===== Schedule Management =====
    const scheduleManagementSection = document.getElementById('scheduleManagementSection');
    const scheduleList = document.getElementById('scheduleList');
    const noSchedulesMessage = document.getElementById('noSchedulesMessage');
    const addScheduleBtn = document.getElementById('addScheduleBtn');
    let scheduleIndex = 0;

    // Check if activity type is Club Activity
    function isClubActivity(type) {
        // Admin doesn't have Club Activities, so always return false
        return false;
    }

    // Check if activity type is Complex Activity (requires schedules)
    function isComplexActivity(type) {
        // For Admin: all activity types are complex (Events, Competitions, Collaborations)
        return true;
    }

    // Show/hide schedule management section based on activity type
    function updateScheduleManagementVisibility() {
        const selectedType = activityTypeSelect.value;
        console.log('Update schedule visibility - Type:', selectedType, 'Is complex:', isComplexActivity(selectedType));
        
        if (selectedType && isComplexActivity(selectedType)) {
            console.log('Showing schedule section');
            scheduleManagementSection.style.display = 'block';
        } else {
            console.log('Hiding schedule section');
            scheduleManagementSection.style.display = 'none';
        }
    }

    // Update no schedules message visibility
    function updateNoSchedulesMessage() {
        const hasSchedules = scheduleList.children.length > 0;
        noSchedulesMessage.style.display = hasSchedules ? 'none' : 'block';
    }

    // Add schedule item
    function addScheduleItem(existingSchedule = null) {
        scheduleIndex++;
        const scheduleItem = document.createElement('div');
        scheduleItem.className = 'schedule-item card mb-3';
        scheduleItem.setAttribute('data-schedule-index', scheduleIndex);
        if (existingSchedule && existingSchedule.id) {
            scheduleItem.setAttribute('data-schedule-id', existingSchedule.id);
        }
        
        scheduleItem.innerHTML = `
            <div class="card-header bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="bi bi-calendar-event me-2"></i>
                        Schedule Item #${scheduleIndex}
                    </h6>
                    <button type="button" class="btn btn-sm btn-outline-danger remove-schedule-btn">
                        <i class="bi bi-trash me-1"></i>
                        Remove
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Time inputs -->
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Start Time <span class="text-danger">*</span></label>
                        <input type="time" class="form-control schedule-start-time" value="${existingSchedule?.startTime || ''}" required />
                        <div class="schedule-start-time-error text-danger small"></div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">End Time <span class="text-danger">*</span></label>
                        <input type="time" class="form-control schedule-end-time" value="${existingSchedule?.endTime || ''}" required />
                        <div class="schedule-end-time-error text-danger small"></div>
                    </div>
                </div>
                
                <!-- Title -->
                <div class="mb-3">
                    <label class="form-label">Title <span class="text-danger">*</span></label>
                    <input type="text" class="form-control schedule-title" maxlength="500" value="${existingSchedule?.title || ''}" required />
                    <div class="schedule-title-error text-danger small"></div>
                </div>
                
                <!-- Description -->
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea class="form-control schedule-description" rows="2" maxlength="1000">${existingSchedule?.description || ''}</textarea>
                </div>
                
                <!-- Notes -->
                <div class="mb-3">
                    <label class="form-label">Notes</label>
                    <textarea class="form-control schedule-notes" rows="2" maxlength="1000">${existingSchedule?.notes || ''}</textarea>
                </div>
                
                <!-- Task Assignments -->
                <div class="assignments-section">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label mb-0">Task Assignments</label>
                        <button type="button" class="btn btn-sm btn-outline-primary add-assignment-btn">
                            <i class="bi bi-person-plus me-1"></i>
                            Add Assignment
                        </button>
                    </div>
                    <div class="assignment-list">
                        <!-- Assignment items will be added here -->
                    </div>
                    <div class="no-assignments-message text-muted small">
                        No assignments yet. Click "Add Assignment" to assign tasks.
                    </div>
                </div>
            </div>
        `;
        
        scheduleList.appendChild(scheduleItem);
        
        // Add event listeners
        const removeBtn = scheduleItem.querySelector('.remove-schedule-btn');
        removeBtn.addEventListener('click', () => removeScheduleItem(scheduleItem));
        
        const addAssignmentBtn = scheduleItem.querySelector('.add-assignment-btn');
        addAssignmentBtn.addEventListener('click', () => addAssignment(scheduleItem));
        
        // Add validation listeners
        const startTimeInput = scheduleItem.querySelector('.schedule-start-time');
        const endTimeInput = scheduleItem.querySelector('.schedule-end-time');
        startTimeInput.addEventListener('change', () => validateScheduleTime(scheduleItem));
        endTimeInput.addEventListener('change', () => validateScheduleTime(scheduleItem));
        
        // Load existing assignments if any
        if (existingSchedule && existingSchedule.assignments) {
            existingSchedule.assignments.forEach(assignment => {
                addAssignment(scheduleItem, assignment);
            });
        }
        
        updateNoSchedulesMessage();
    }

    // Remove schedule item
    function removeScheduleItem(scheduleItem) {
        scheduleItem.remove();
        updateNoSchedulesMessage();
        renumberScheduleItems();
    }

    // Renumber schedule items after removal
    function renumberScheduleItems() {
        const scheduleItems = scheduleList.querySelectorAll('.schedule-item');
        scheduleItems.forEach((item, index) => {
            const header = item.querySelector('.card-header h6');
            header.innerHTML = `
                <i class="bi bi-calendar-event me-2"></i>
                Schedule Item #${index + 1}
            `;
        });
    }

    // Validate schedule time
    function validateScheduleTime(scheduleItem) {
        const startTimeInput = scheduleItem.querySelector('.schedule-start-time');
        const endTimeInput = scheduleItem.querySelector('.schedule-end-time');
        const startTimeError = scheduleItem.querySelector('.schedule-start-time-error');
        const endTimeError = scheduleItem.querySelector('.schedule-end-time-error');
        
        startTimeError.textContent = '';
        endTimeError.textContent = '';
        
        if (!startTimeInput.value || !endTimeInput.value) {
            return true;
        }
        
        const startTime = startTimeInput.value;
        const endTime = endTimeInput.value;
        
        if (endTime <= startTime) {
            endTimeError.textContent = 'End time must be after start time';
            return false;
        }
        
        return true;
    }

    // Add assignment to schedule
    function addAssignment(scheduleItem, existingAssignment = null) {
        const assignmentList = scheduleItem.querySelector('.assignment-list');
        const noAssignmentsMessage = scheduleItem.querySelector('.no-assignments-message');
        
        const assignmentItem = document.createElement('div');
        assignmentItem.className = 'assignment-item border rounded p-2 mb-2';
        if (existingAssignment && existingAssignment.id) {
            assignmentItem.setAttribute('data-assignment-id', existingAssignment.id);
        }
        
        assignmentItem.innerHTML = `
            <div class="row g-2">
                <div class="col-md-5">
                    <label class="form-label small">Responsible Person</label>
                    <input type="text" class="form-control form-control-sm assignment-name" 
                           placeholder="Name or select user" maxlength="200" value="${existingAssignment?.responsibleName || ''}" />
                    <div class="assignment-name-error text-danger small"></div>
                </div>
                <div class="col-md-5">
                    <label class="form-label small">Role</label>
                    <input type="text" class="form-control form-control-sm assignment-role" 
                           placeholder="e.g., MC, Speaker" maxlength="100" value="${existingAssignment?.role || ''}" />
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-sm btn-outline-danger remove-assignment-btn w-100">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            </div>
        `;
        
        assignmentList.appendChild(assignmentItem);
        
        // Add event listener for remove button
        const removeBtn = assignmentItem.querySelector('.remove-assignment-btn');
        removeBtn.addEventListener('click', () => removeAssignment(scheduleItem, assignmentItem));
        
        // Update no assignments message
        updateNoAssignmentsMessage(scheduleItem);
    }

    // Remove assignment
    function removeAssignment(scheduleItem, assignmentItem) {
        assignmentItem.remove();
        updateNoAssignmentsMessage(scheduleItem);
    }

    // Update no assignments message visibility
    function updateNoAssignmentsMessage(scheduleItem) {
        const assignmentList = scheduleItem.querySelector('.assignment-list');
        const noAssignmentsMessage = scheduleItem.querySelector('.no-assignments-message');
        const hasAssignments = assignmentList.children.length > 0;
        noAssignmentsMessage.style.display = hasAssignments ? 'none' : 'block';
    }

    // Validate all schedules
    function validateAllSchedules() {
        const scheduleItems = scheduleList.querySelectorAll('.schedule-item');
        let isValid = true;
        
        scheduleItems.forEach(scheduleItem => {
            // Validate required fields
            const startTime = scheduleItem.querySelector('.schedule-start-time');
            const endTime = scheduleItem.querySelector('.schedule-end-time');
            const title = scheduleItem.querySelector('.schedule-title');
            const titleError = scheduleItem.querySelector('.schedule-title-error');
            
            if (!startTime.value) {
                scheduleItem.querySelector('.schedule-start-time-error').textContent = 'Start time is required';
                isValid = false;
            }
            
            if (!endTime.value) {
                scheduleItem.querySelector('.schedule-end-time-error').textContent = 'End time is required';
                isValid = false;
            }
            
            if (!title.value) {
                titleError.textContent = 'Title is required';
                isValid = false;
            } else {
                titleError.textContent = '';
            }
            
            // Validate time
            if (!validateScheduleTime(scheduleItem)) {
                isValid = false;
            }
            
            // Validate assignments
            const assignments = scheduleItem.querySelectorAll('.assignment-item');
            assignments.forEach(assignment => {
                const nameInput = assignment.querySelector('.assignment-name');
                const nameError = assignment.querySelector('.assignment-name-error');
                
                if (!nameInput.value.trim()) {
                    nameError.textContent = 'Responsible person is required';
                    isValid = false;
                } else {
                    nameError.textContent = '';
                }
            });
        });
        
        return isValid;
    }

    // Collect schedule data from form
    function collectScheduleData() {
        const schedules = [];
        const scheduleItems = scheduleList.querySelectorAll('.schedule-item');
        
        scheduleItems.forEach(scheduleItem => {
            const scheduleId = scheduleItem.getAttribute('data-schedule-id');
            const startTime = scheduleItem.querySelector('.schedule-start-time').value;
            const endTime = scheduleItem.querySelector('.schedule-end-time').value;
            const title = scheduleItem.querySelector('.schedule-title').value;
            const description = scheduleItem.querySelector('.schedule-description').value;
            const notes = scheduleItem.querySelector('.schedule-notes').value;
            
            // Collect assignments
            const assignments = [];
            const assignmentItems = scheduleItem.querySelectorAll('.assignment-item');
            assignmentItems.forEach(assignmentItem => {
                const assignmentId = assignmentItem.getAttribute('data-assignment-id');
                const name = assignmentItem.querySelector('.assignment-name').value.trim();
                const role = assignmentItem.querySelector('.assignment-role').value.trim();
                
                if (name) {
                    assignments.push({
                        Id: assignmentId ? parseInt(assignmentId) : null,
                        ResponsibleName: name,
                        Role: role || null
                    });
                }
            });
            
            schedules.push({
                Id: scheduleId ? parseInt(scheduleId) : null,
                StartTime: startTime,
                EndTime: endTime,
                Title: title,
                Description: description || null,
                Notes: notes || null,
                Assignments: assignments
            });
        });
        
        return schedules;
    }

    // Load existing schedules
    async function loadExistingSchedules() {
        const activityId = @Model.Input.Id;
        const selectedType = activityTypeSelect.value;
        
        console.log('Loading schedules for activity:', activityId, 'Type:', selectedType);
        console.log('Is complex activity:', isComplexActivity(selectedType));
        
        if (!isComplexActivity(selectedType)) {
            console.log('Not a complex activity, skipping schedule load');
            return;
        }
        
        try {
            const response = await fetch(`@Model.ApiBaseUrl/api/activity/${activityId}`, {
                credentials: 'include'
            });
            
            console.log('Schedule load response status:', response.status);
            
            if (response.ok) {
                const activity = await response.json();
                console.log('Activity data:', activity);
                console.log('Schedules:', activity.schedules || activity.Schedules);
                
                const schedules = activity.schedules || activity.Schedules || [];
                console.log('Found schedules count:', schedules.length);
                
                if (schedules.length > 0) {
                    schedules.forEach(schedule => {
                        console.log('Adding schedule:', schedule);
                        addScheduleItem(schedule);
                    });
                } else {
                    console.log('No schedules found for this activity');
                }
            } else {
                console.error('Failed to load activity:', response.status, response.statusText);
            }
        } catch (error) {
            console.error('Error loading schedules:', error);
        }
    }

    // Event listener for add schedule button
    addScheduleBtn?.addEventListener('click', () => addScheduleItem());

    // Update visibility on type change
    activityTypeSelect?.addEventListener('change', function() {
        updateScheduleManagementVisibility();
    });

    // Initial setup
    console.log('=== ADMIN EDIT INITIAL SETUP ===');
    updateScheduleManagementVisibility();
    console.log('Calling loadExistingSchedules...');
    loadExistingSchedules();

    // ===== Image upload to Cloudinary =====
    const fileInput = document.getElementById('imageFile');
    const statusEl = document.getElementById('imageUploadStatus');
    const preview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    const removeBtn = document.getElementById('removeImageBtn');

    fileInput?.addEventListener('change', async (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        
        statusEl.textContent = 'Uploading...';
        statusEl.classList.remove('text-danger', 'text-success');
        statusEl.classList.add('text-primary');

        try {
            const form = new FormData();
            form.append('file', file);
            
            console.log('Uploading file:', file.name);
            
            const res = await fetch('@Model.ApiBaseUrl/api/activity/upload-image', {
                method: 'POST',
                body: form,
                credentials: 'include'
            });
            
            console.log('Upload response status:', res.status);
            
            if (!res.ok) {
                const errorText = await res.text();
                console.error('Upload error:', errorText);
                throw new Error(`Upload failed: ${res.status}`);
            }
            
            const data = await res.json();
            console.log('Upload response data:', data);
            
            if (!data.url) {
                throw new Error('No URL returned from server');
            }

            // Set hidden field and preview
            document.getElementById('Input_ImageUrl').value = data.url;
            previewImg.src = data.url;
            preview.style.display = 'block';
            statusEl.textContent = '✓ Uploaded successfully';
            statusEl.classList.remove('text-primary', 'text-danger');
            statusEl.classList.add('text-success');
        } catch (err) {
            console.error('Upload error:', err);
            statusEl.textContent = '✗ ' + (err.message || 'Upload failed');
            statusEl.classList.remove('text-primary', 'text-success');
            statusEl.classList.add('text-danger');
            fileInput.value = '';
        }
    });

    removeBtn?.addEventListener('click', () => {
        document.getElementById('Input_ImageUrl').value = '';
        previewImg.src = '#';
        preview.style.display = 'none';
        fileInput.value = '';
        statusEl.textContent = '';
    });
    
    // ===== Date/Time Validation =====
    const startTimeInput = document.getElementById('Input_StartTime');
    const endTimeInput = document.getElementById('Input_EndTime');
    const startTimeError = document.createElement('div');
    const endTimeError = document.createElement('div');
    
    startTimeError.className = 'text-danger small mt-1';
    endTimeError.className = 'text-danger small mt-1';
    
    startTimeInput?.parentElement.appendChild(startTimeError);
    endTimeInput?.parentElement.appendChild(endTimeError);
    
    function clearErrors() {
        startTimeError.textContent = '';
        endTimeError.textContent = '';
    }
    
    function setError(element, message) {
        element.textContent = message;
    }
    
    // Validate dates on change
    startTimeInput?.addEventListener('change', function() {
        clearErrors();
        const startDate = new Date(this.value);
        const currentDate = new Date();
        
        if (this.value && startDate < currentDate) {
            setError(startTimeError, 'Start time cannot be in the past');
            this.value = '';
            return;
        }
        
        // Update end time minimum to start time
        if (this.value) endTimeInput.setAttribute('min', this.value);
        
        // Check if end time is before or equal to start time
        if (endTimeInput.value && new Date(endTimeInput.value) <= startDate) {
            setError(endTimeError, 'End time must be after start time');
            endTimeInput.value = '';
        }
    });
    
    endTimeInput?.addEventListener('change', function() {
        clearErrors();
        const endDate = new Date(this.value);
        const currentDate = new Date();
        
        if (this.value && endDate < currentDate) {
            setError(endTimeError, 'End time cannot be in the past');
            this.value = '';
            return;
        }
        
        if (startTimeInput.value && endDate <= new Date(startTimeInput.value)) {
            setError(endTimeError, 'End time must be after start time');
            this.value = '';
        }
    });
    
    // Validate before form submit
    document.querySelector('form')?.addEventListener('submit', async function(e) {
        e.preventDefault(); // Always prevent default to handle with AJAX
        
        clearErrors();
        const startDate = startTimeInput.value ? new Date(startTimeInput.value) : null;
        const endDate = endTimeInput.value ? new Date(endTimeInput.value) : null;
        const currentDate = new Date();
        let hasError = false;
        
        if (startDate && startDate < currentDate) {
            setError(startTimeError, 'Start time cannot be in the past');
            hasError = true;
        }
        
        if (endDate && endDate < currentDate) {
            setError(endTimeError, 'End time cannot be in the past');
            hasError = true;
        }
        
        if (startDate && endDate && endDate <= startDate) {
            setError(endTimeError, 'End time must be after start time');
            hasError = true;
        }
        
        // Validate movement points
        if (!validateMovementPoints()) {
            hasError = true;
        }
        
        // Validate collaboration fields
        const selectedType = activityTypeSelect.value;
        const isCollaborationType = selectedType === '10' || selectedType === '11';
        
        if (isCollaborationType) {
            // Validate club selection
            if (!clubCollaborationIdInput.value) {
                clubCollaborationError.textContent = 'Please select a collaborating club';
                hasError = true;
            }
            
            // Validate collaboration point
            const collabPoint = parseInt(collaborationPointInput.value);
            if (!collaborationPointInput.value || collabPoint < 1 || collabPoint > 3) {
                collaborationPointError.textContent = 'Collaboration points must be between 1 and 3';
                hasError = true;
            }
        }

        // Validate schedules for complex activities
        if (isComplexActivity(selectedType)) {
            if (!validateAllSchedules()) {
                hasError = true;
            }
        }
        
        if (hasError) {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            return false;
        }

        // Submit form with schedules
        try {
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';

            const activityId = @Model.Input.Id;

            // Build payload with schedules
            const payload = {
                Activity: {
                    Id: activityId,
                    Title: document.getElementById('Input_Title').value,
                    Description: document.getElementById('Input_Description').value || null,
                    Location: document.getElementById('Input_Location').value || null,
                    ImageUrl: document.getElementById('Input_ImageUrl').value || null,
                    StartTime: startTimeInput.value,
                    EndTime: endTimeInput.value,
                    Type: parseInt(selectedType),
                    IsPublic: document.getElementById('Input_IsPublic').checked,
                    MaxParticipants: document.getElementById('Input_MaxParticipants').value ? parseInt(document.getElementById('Input_MaxParticipants').value) : null,
                    MovementPoint: parseFloat(movementPointInput.value),
                    ClubCollaborationId: clubCollaborationIdInput.value ? parseInt(clubCollaborationIdInput.value) : null,
                    CollaborationPoint: collaborationPointInput.value ? parseInt(collaborationPointInput.value) : null
                },
                Schedules: isComplexActivity(selectedType) ? collectScheduleData() : []
            };

            console.log('Submitting payload:', payload);

            // Submit to API with schedules
            const response = await fetch(`@Model.ApiBaseUrl/api/admin/activities/${activityId}/with-schedules`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                // Success - redirect to index
                window.location.href = '/Admin/Activities?success=Activity updated successfully';
            } else {
                const errorText = await response.text();
                console.error('API error:', errorText);
                
                // Show error message at top of page
                showErrorMessage(errorText);
                
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-save me-2"></i>Save Changes';
                
                // Scroll to top to see error
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        } catch (error) {
            console.error('Error submitting form:', error);
            
            // Show error message at top of page
            showErrorMessage('An error occurred while updating the activity: ' + error.message);
            
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="bi bi-save me-2"></i>Save Changes';
            
            // Scroll to top to see error
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    });
    
    // Helper function to show error message
    function showErrorMessage(message) {
        // Remove any existing error alerts
        const existingAlerts = document.querySelectorAll('.alert-danger.api-error');
        existingAlerts.forEach(alert => alert.remove());
        
        // Create new error alert
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show api-error';
        alertDiv.setAttribute('role', 'alert');
        alertDiv.innerHTML = `
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>Error:</strong> ${escapeHtml(message)}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Insert at top of form
        const form = document.querySelector('form');
        form.insertBefore(alertDiv, form.firstChild);
    }
    
    // Helper to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>


