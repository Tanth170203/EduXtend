@page
@model WebFE.Pages.Admin.Activities.IndexModel
@{
    ViewData["Title"] = "Activities";
    Layout = "~/Pages/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid px-4 py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1 fw-bold">Activities</h2>
            <p class="text-muted mb-0">Manage all system activities</p>
        </div>
        <div>
            <a class="btn btn-warning me-2" href="/Admin/Activities/PendingApprovals">
                <i class="bi bi-hourglass-split me-2"></i>Request Activities
                @if (Model.PendingActivities > 0)
                {
                    <span class="badge bg-white text-warning ms-2">@Model.PendingActivities</span>
                }
            </a>
            <a class="btn btn-primary" href="/Admin/Activities/Create">
                <i class="bi bi-plus-circle me-2"></i>New Activity
            </a>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-3 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-muted mb-2 fw-medium">Total Activities</p>
                            <h2 class="mb-0 fw-bold">@Model.TotalActivities</h2>
                        </div>
                        <div class="rounded-3 p-3" style="background-color: #e3f2fd;">
                            <i class="bi bi-calendar-event" style="font-size: 1.5rem; color: #1976d2;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-muted mb-2 fw-medium">Approved</p>
                            <h2 class="mb-0 fw-bold">@Model.ApprovedActivities</h2>
                        </div>
                        <div class="rounded-3 p-3" style="background-color: #e8f5e9;">
                            <i class="bi bi-check-circle" style="font-size: 1.5rem; color: #388e3c;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-muted mb-2 fw-medium">Pending Approval</p>
                            <h2 class="mb-0 fw-bold">@Model.PendingActivities</h2>
                        </div>
                        <div class="rounded-3 p-3" style="background-color: #fff3e0;">
                            <i class="bi bi-hourglass-split" style="font-size: 1.5rem; color: #f57c00;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-muted mb-2 fw-medium">Upcoming</p>
                            <h2 class="mb-0 fw-bold">@Model.UpcomingActivities</h2>
                        </div>
                        <div class="rounded-3 p-3" style="background-color: #f3e5f5;">
                            <i class="bi bi-calendar-plus" style="font-size: 1.5rem; color: #7b1fa2;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <input asp-for="SearchTerm" class="form-control" placeholder="Search title/location..." />
                </div>
                <div class="col-md-2">
                    <select asp-for="Type" class="form-select">
                        <option value="">All types</option>
                        <optgroup label="Club Activities">
                            <option>ClubMeeting</option>
                            <option>ClubTraining</option>
                            <option>ClubWorkshop</option>
                        </optgroup>
                        <optgroup label="Events">
                            <option>LargeEvent</option>
                            <option>MediumEvent</option>
                            <option>SmallEvent</option>
                        </optgroup>
                        <optgroup label="Competitions">
                            <option>SchoolCompetition</option>
                            <option>ProvincialCompetition</option>
                            <option>NationalCompetition</option>
                        </optgroup>
                        <optgroup label="Collaboration">
                            <option>ClubCollaboration</option>
                            <option>SchoolCollaboration</option>
                        </optgroup>
                    </select>
                </div>
                <div class="col-md-2">
                    <select asp-for="Status" class="form-select">
                        <option value="">All statuses</option>
                        <option>Approved</option>
                        <option>PendingApproval</option>
                        <option>Rejected</option>
                        <option>Completed</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select asp-for="IsPublic" class="form-select">
                        <option value="">All visibility</option>
                        <option value="true">Public</option>
                        <option value="false">Private</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-primary w-100" type="submit">
                        <i class="bi bi-search me-2"></i>Filter
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead style="background-color: #f8f9fa;">
                        <tr>
                            <th class="px-4 py-3 fw-semibold text-muted">Title</th>
                            <th class="px-3 py-3 fw-semibold text-muted">Type</th>
                            <th class="px-3 py-3 fw-semibold text-muted">Start</th>
                            <th class="px-3 py-3 fw-semibold text-muted">End</th>
                            <th class="px-3 py-3 fw-semibold text-muted">Public</th>
                            <th class="px-3 py-3 fw-semibold text-muted">Participants</th>
                            @* <th class="px-3 py-3 fw-semibold text-muted">Code</th> - TEMPORARILY HIDDEN (GPS only mode) *@
                            <th class="px-4 py-3 fw-semibold text-muted text-end" style="width: 150px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    @if (!Model.Items.Any())
                    {
                        <tr>
                            <td colspan="8" class="text-center py-5 text-muted">
                                <i class="bi bi-calendar-x" style="font-size: 3rem;"></i>
                                <p class="mt-3 mb-0">No activities found</p>
                            </td>
                        </tr>
                    }
                    @foreach (var a in Model.Items)
                    {
                        var now = DateTime.Now;
                        var hasStarted = a.StartTime <= now;
                        var isCompleted = a.Status == "Completed";
                        var canEdit = !hasStarted && !isCompleted;
                        
                        <tr>
                            <td class="px-4 py-3">
                                <div class="d-flex align-items-center">
                                    <img src="@(a.ImageUrl ?? "https://via.placeholder.com/48")" 
                                         class="rounded me-3" 
                                         style="width:48px;height:48px;object-fit:cover;" 
                                         onerror="this.src='https://via.placeholder.com/48'" />
                                    <div>
                                        <div class="fw-semibold">@a.Title</div>
                                        <div class="text-muted small">@(a.Location ?? "No location")</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-3 py-3">
                                <span class="badge bg-info">@a.Type</span>
                            </td>
                            <td class="px-3 py-3">
                                <div class="small">@a.StartTime.ToString("dd-MM-yyyy")</div>
                                <div class="text-muted small">@a.StartTime.ToString("HH:mm")</div>
                            </td>
                            <td class="px-3 py-3">
                                <div class="small">@a.EndTime.ToString("dd-MM-yyyy")</div>
                                <div class="text-muted small">@a.EndTime.ToString("HH:mm")</div>
                            </td>
                            <td class="px-3 py-3">
                                @if (a.IsPublic)
                                {
                                    <span class="badge bg-success">Yes</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">No</span>
                                }
                            </td>
                            <td class="px-3 py-3">
                                <span class="fw-semibold">@a.CurrentParticipants</span>
                                @if (a.MaxParticipants.HasValue)
                                {
                                    <span class="text-muted">/ @a.MaxParticipants</span>
                                }
                            </td>
                            @* ATTENDANCE CODE COLUMN - TEMPORARILY HIDDEN (GPS only mode)
                            <td class="px-3 py-3">
                                @if (!string.IsNullOrWhiteSpace(a.AttendanceCode))
                                {
                                    <div class="d-flex align-items-center">
                                        <code class="bg-light px-2 py-1 rounded" style="font-size: 0.9rem; letter-spacing: 0.1em;">@a.AttendanceCode</code>
                                        <button class="btn btn-sm btn-link p-0 ms-2" 
                                                onclick="copyCode(event, '@Html.Raw(a.AttendanceCode)')" 
                                                title="Copy code">
                                            <i class="bi bi-clipboard"></i>
                                        </button>
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted small">N/A</span>
                                }
                            </td>
                            *@
                            <td class="px-4 py-3 text-end" style="white-space: nowrap;">
                                <a class="btn btn-sm btn-outline-info me-1" href="/Admin/Activities/Details/@a.Id" title="View Details" style="width: 38px; height: 38px; display: inline-flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-eye" style="font-size: 16px;"></i>
                                </a>
                                @if (canEdit)
                                {
                                    <a class="btn btn-sm btn-outline-primary me-1" href="/Admin/Activities/Edit/@a.Id" title="Edit" style="width: 38px; height: 38px; display: inline-flex; align-items: center; justify-content: center;">
                                        <i class="bi bi-pencil-square" style="font-size: 16px;"></i>
                                    </a>
                                }
                                else
                                {
                                    <button class="btn btn-sm btn-outline-secondary me-1" disabled title="@(hasStarted ? "Edit (Started)" : "Edit (Completed)")" style="width: 38px; height: 38px; display: inline-flex; align-items: center; justify-content: center;">
                                        <i class="bi bi-pencil-square" style="font-size: 16px;"></i>
                                    </button>
                                }
                                @if (canEdit)
                                {
                                    <button class="btn btn-sm btn-outline-danger" 
                                            onclick="confirmDelete(@a.Id, '@a.Title')" 
                                            title="Delete"
                                            style="width: 38px; height: 38px; display: inline-flex; align-items: center; justify-content: center;">
                                        <i class="bi bi-trash3" style="font-size: 16px;"></i>
                                    </button>
                                }
                                else
                                {
                                    <button class="btn btn-sm btn-outline-secondary" disabled title="@(hasStarted ? "Delete (Started)" : "Delete (Completed)")" style="width: 38px; height: 38px; display: inline-flex; align-items: center; justify-content: center;">
                                        <i class="bi bi-trash3" style="font-size: 16px;"></i>
                                    </button>
                                }
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        </div>
        
        @if (Model.TotalPages > 1)
        {
            <div class="card-footer bg-white border-top">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="text-muted small">
                        Showing @((Model.PageNumber - 1) * Model.PageSize + 1) to @(Math.Min(Model.PageNumber * Model.PageSize, Model.TotalItems)) of @Model.TotalItems activities
                    </div>
                    <nav aria-label="Page navigation">
                        <ul class="pagination pagination-sm mb-0">
                            @if (Model.PageNumber > 1)
                            {
                                <li class="page-item">
                                    <a class="page-link" href="?PageNumber=@(Model.PageNumber - 1)&SearchTerm=@Model.SearchTerm&Type=@Model.Type&Status=@Model.Status&IsPublic=@Model.IsPublic">
                                        <i class="bi bi-chevron-left"></i>
                                    </a>
                                </li>
                            }
                            else
                            {
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="bi bi-chevron-left"></i></span>
                                </li>
                            }
                            
                            @{
                                var startPage = Math.Max(1, Model.PageNumber - 2);
                                var endPage = Math.Min(Model.TotalPages, Model.PageNumber + 2);
                                
                                if (startPage > 1)
                                {
                                    <li class="page-item">
                                        <a class="page-link" href="?PageNumber=1&SearchTerm=@Model.SearchTerm&Type=@Model.Type&Status=@Model.Status&IsPublic=@Model.IsPublic">1</a>
                                    </li>
                                    if (startPage > 2)
                                    {
                                        <li class="page-item disabled"><span class="page-link">...</span></li>
                                    }
                                }
                                
                                for (var i = startPage; i <= endPage; i++)
                                {
                                    if (i == Model.PageNumber)
                                    {
                                        <li class="page-item active">
                                            <span class="page-link">@i</span>
                                        </li>
                                    }
                                    else
                                    {
                                        <li class="page-item">
                                            <a class="page-link" href="?PageNumber=@i&SearchTerm=@Model.SearchTerm&Type=@Model.Type&Status=@Model.Status&IsPublic=@Model.IsPublic">@i</a>
                                        </li>
                                    }
                                }
                                
                                if (endPage < Model.TotalPages)
                                {
                                    if (endPage < Model.TotalPages - 1)
                                    {
                                        <li class="page-item disabled"><span class="page-link">...</span></li>
                                    }
                                    <li class="page-item">
                                        <a class="page-link" href="?PageNumber=@Model.TotalPages&SearchTerm=@Model.SearchTerm&Type=@Model.Type&Status=@Model.Status&IsPublic=@Model.IsPublic">@Model.TotalPages</a>
                                    </li>
                                }
                            }
                            
                            @if (Model.PageNumber < Model.TotalPages)
                            {
                                <li class="page-item">
                                    <a class="page-link" href="?PageNumber=@(Model.PageNumber + 1)&SearchTerm=@Model.SearchTerm&Type=@Model.Type&Status=@Model.Status&IsPublic=@Model.IsPublic">
                                        <i class="bi bi-chevron-right"></i>
                                    </a>
                                </li>
                            }
                            else
                            {
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="bi bi-chevron-right"></i></span>
                                </li>
                            }
                        </ul>
                    </nav>
                </div>
            </div>
        }
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold" id="deleteModalLabel">
                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>Confirm Delete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2">Are you sure you want to delete this activity?</p>
                <p class="fw-semibold text-primary mb-0" id="activityTitle"></p>
                <p class="text-muted small mt-2">This action cannot be undone.</p>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="bi bi-trash me-2"></i>Delete
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let deleteId = null;
    
    function confirmDelete(id, title) {
        deleteId = id;
        document.getElementById('activityTitle').textContent = title;
        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        modal.show();
    }
    
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        if (deleteId) {
            window.location.href = '/Admin/Activities/Delete/' + deleteId;
        }
    });
    
    function copyCode(evt, code) {
        navigator.clipboard.writeText(code).then(function() {
            // Show success feedback
            const btn = evt.target.closest('button');
            const icon = btn.querySelector('i');
            icon.classList.remove('bi-clipboard');
            icon.classList.add('bi-check2');
            btn.classList.add('text-success');
            
            // Show success message
            showToast('Success', 'success');
            
            setTimeout(function() {
                icon.classList.remove('bi-check2');
                icon.classList.add('bi-clipboard');
                btn.classList.remove('text-success');
            }, 2000);
        }).catch(function(err) {
            showToast('Không thể copy mã', 'danger');
        });
    }
    
    function showToast(message, type) {
        // Validate parameters
        if (!message) message = 'Thao tác thành công';
        if (!type) type = 'success';
        
        // Create toast container if not exists
        let toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toastContainer';
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '9999';
            document.body.appendChild(toastContainer);
        }
        
        // Choose icon based on type
        const icon = type === 'success' ? 'bi-check-circle-fill' : 'bi-exclamation-circle-fill';
        
        // Create toast element
        const toastId = 'toast-' + Date.now();
        const toastDiv = document.createElement('div');
        toastDiv.id = toastId;
        toastDiv.className = `toast align-items-center text-white bg-${type} border-0`;
        toastDiv.setAttribute('role', 'alert');
        toastDiv.setAttribute('aria-live', 'assertive');
        toastDiv.setAttribute('aria-atomic', 'true');
        
        toastDiv.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi ${icon} me-2"></i>${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        toastContainer.appendChild(toastDiv);
        const toast = new bootstrap.Toast(toastDiv, { delay: 3000 });
        toast.show();
        
        // Remove toast element after it's hidden
        toastDiv.addEventListener('hidden.bs.toast', function() {
            toastDiv.remove();
        });
    }
</script>


