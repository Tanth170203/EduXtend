@page
@model WebFE.Pages.ClubManager.Activities.CollaborationInvitationsModel
@{
    ViewData["Title"] = "Collaboration Invitations";
    ViewData["Breadcrumb"] = "Collaboration Invitations";
    Layout = "~/Pages/Shared/_ClubManagerLayout.cshtml";
}

<div class="page-header">
    <div>
        <h1 class="page-title">Collaboration Invitations</h1>
        <p class="page-description">Manage collaboration requests from other clubs</p>
    </div>
    <a href="/ClubManager/Activities" class="btn btn-outline-secondary">
        <i data-lucide="arrow-left" style="width: 16px; height: 16px;"></i>
        Back to Activities
    </a>
</div>

<div id="loadingState" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="text-muted mt-2">Loading invitations...</p>
</div>

<div id="emptyState" class="text-center py-5" style="display: none;">
    <i data-lucide="inbox" style="width: 64px; height: 64px; color: #ccc;"></i>
    <h4 class="mt-3 text-muted">No Pending Invitations</h4>
    <p class="text-muted">You don't have any collaboration invitations at the moment.</p>
    <a href="/ClubManager/Activities" class="btn btn-primary mt-3">
        <i data-lucide="arrow-left" style="width: 16px; height: 16px;"></i>
        Back to Activities
    </a>
</div>

<div id="invitationsContainer" class="row g-4" style="display: none;">
    <!-- Invitations will be loaded here -->
</div>

<!-- Reject Modal -->
<div class="modal fade" id="rejectModal" tabindex="-1" aria-labelledby="rejectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rejectModalLabel">Reject Collaboration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Please provide a reason for rejecting this collaboration invitation:</p>
                <textarea class="form-control" id="rejectionReason" rows="4" 
                          placeholder="e.g., We have another event scheduled on the same day..." 
                          minlength="10" maxlength="500" required></textarea>
                <div class="form-text">Minimum 10 characters, maximum 500 characters</div>
                <div id="reasonError" class="text-danger small mt-2" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmRejectBtn">
                    <i data-lucide="x-circle" style="width: 16px; height: 16px;"></i>
                    Reject
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        lucide.createIcons();

        let currentActivityId = null;
        let clubId = null;

        // Get club ID
        async function getClubId() {
            try {
                const res = await fetch('@Model.ApiBaseUrl/api/club/my-managed-club', {
                    credentials: 'include'
                });
                if (res.ok) {
                    const club = await res.json();
                    return club.id;
                }
            } catch (err) {
                console.error('Failed to get club ID:', err);
            }
            return null;
        }

        // Load invitations
        async function loadInvitations() {
            clubId = await getClubId();
            if (!clubId) {
                document.getElementById('loadingState').style.display = 'none';
                showError('Failed to load club information');
                return;
            }

            try {
                const apiUrl = `@Model.ApiBaseUrl/api/activity/collaboration-invitations/list?clubId=${clubId}`;
                console.log('[Invitations] Loading from:', apiUrl);
                
                const response = await fetch(apiUrl, {
                    credentials: 'include'
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error:', errorText);
                    
                    // If 404, assume no invitations exist (empty list)
                    if (response.status === 404) {
                        console.log('No invitations found (404), showing empty state');
                        document.getElementById('loadingState').style.display = 'none';
                        document.getElementById('emptyState').style.display = 'block';
                        return;
                    }
                    
                    throw new Error(`Failed to load invitations: ${response.status} - ${errorText}`);
                }

                const invitations = await response.json();
                console.log('Loaded invitations:', invitations);
                
                document.getElementById('loadingState').style.display = 'none';
                
                if (!invitations || invitations.length === 0) {
                    document.getElementById('emptyState').style.display = 'block';
                } else {
                    document.getElementById('invitationsContainer').style.display = 'flex';
                    renderInvitations(invitations);
                }
            } catch (error) {
                console.error('Error loading invitations:', error);
                document.getElementById('loadingState').style.display = 'none';
                // Show empty state instead of error for better UX
                document.getElementById('emptyState').style.display = 'block';
            }
        }

        // Render invitations
        function renderInvitations(invitations) {
            const container = document.getElementById('invitationsContainer');
            container.innerHTML = invitations.map(inv => `
                <div class="col-12">
                    <div class="content-card">
                        <div class="content-card-body">
                            <div class="row align-items-center">
                                <div class="col-md-2">
                                    ${inv.imageUrl 
                                        ? `<img src="${inv.imageUrl}" class="img-fluid rounded" alt="${inv.title}">`
                                        : `<div class="bg-light rounded d-flex align-items-center justify-content-center" style="height: 120px;">
                                             <i data-lucide="image" style="width: 48px; height: 48px; color: #ccc;"></i>
                                           </div>`
                                    }
                                </div>
                                <div class="col-md-7">
                                    <h5 class="mb-2">${escapeHtml(inv.title)}</h5>
                                    <div class="mb-2">
                                        <span class="badge bg-primary me-2">
                                            <i data-lucide="users" style="width: 14px; height: 14px;"></i>
                                            ${escapeHtml(inv.organizingClubName)}
                                        </span>
                                        <span class="badge bg-success">
                                            <i data-lucide="award" style="width: 14px; height: 14px;"></i>
                                            ${inv.collaborationPoint || 0} points
                                        </span>
                                    </div>
                                    <p class="text-muted small mb-2">
                                        <i data-lucide="calendar" style="width: 14px; height: 14px;"></i>
                                        ${formatDate(inv.startTime)} - ${formatDate(inv.endTime)}
                                    </p>
                                    ${inv.location ? `
                                        <p class="text-muted small mb-0">
                                            <i data-lucide="map-pin" style="width: 14px; height: 14px;"></i>
                                            ${escapeHtml(inv.location)}
                                        </p>
                                    ` : ''}
                                    ${inv.description ? `
                                        <p class="text-muted small mt-2 mb-0">${escapeHtml(inv.description).substring(0, 150)}${inv.description.length > 150 ? '...' : ''}</p>
                                    ` : ''}
                                </div>
                                <div class="col-md-3 text-end">
                                    <button class="btn btn-success w-100 mb-2" onclick="acceptInvitation(${inv.activityId})">
                                        <i data-lucide="check-circle" style="width: 16px; height: 16px;"></i>
                                        Accept
                                    </button>
                                    <button class="btn btn-outline-danger w-100" onclick="showRejectModal(${inv.activityId})">
                                        <i data-lucide="x-circle" style="width: 16px; height: 16px;"></i>
                                        Reject
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons();
        }

        // Accept invitation
        async function acceptInvitation(activityId) {
            try {
                const response = await fetch(`@Model.ApiBaseUrl/api/activity/${activityId}/collaboration/accept?clubId=${clubId}`, {
                    method: 'POST',
                    credentials: 'include'
                });

                const data = await response.json();

                if (response.ok) {
                    console.log('[Accept] Success, hiding invitation and reloading...');
                    
                    // Hide the accepted invitation immediately
                    const invitationCards = document.querySelectorAll('#invitationsContainer .col-12');
                    invitationCards.forEach(card => {
                        const acceptBtn = card.querySelector('button[onclick*="acceptInvitation(' + activityId + ')"]');
                        if (acceptBtn) {
                            card.style.display = 'none';
                        }
                    });
                    
                    // Clean up any lingering backdrops
                    setTimeout(() => {
                        const backdrops = document.querySelectorAll('.modal-backdrop');
                        backdrops.forEach(backdrop => backdrop.remove());
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        document.body.style.paddingRight = '';
                    }, 100);
                    
                    // Reload invitations to get fresh data
                    setTimeout(() => {
                        console.log('[Accept] Reloading invitations...');
                        loadInvitations();
                    }, 800);
                } else {
                    console.error('[Accept] Failed:', data.message);
                    showError(data.message || 'Failed to accept collaboration');
                }
            } catch (error) {
                console.error('Error accepting invitation:', error);
                showError('An error occurred. Please try again.');
            }
        }

        // Show reject modal
        function showRejectModal(activityId) {
            currentActivityId = activityId;
            document.getElementById('rejectionReason').value = '';
            document.getElementById('reasonError').style.display = 'none';
            
            const modal = new bootstrap.Modal(document.getElementById('rejectModal'));
            modal.show();
        }

        // Confirm reject
        document.getElementById('confirmRejectBtn').addEventListener('click', async function() {
            const reason = document.getElementById('rejectionReason').value.trim();
            const errorEl = document.getElementById('reasonError');

            if (reason.length < 10) {
                errorEl.textContent = 'Please provide at least 10 characters';
                errorEl.style.display = 'block';
                return;
            }

            if (reason.length > 500) {
                errorEl.textContent = 'Reason cannot exceed 500 characters';
                errorEl.style.display = 'block';
                return;
            }

            try {
                const response = await fetch(`@Model.ApiBaseUrl/api/activity/${currentActivityId}/collaboration/reject?clubId=${clubId}`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason: reason })
                });

                const data = await response.json();

                if (response.ok) {
                    console.log('[Reject] Success, closing modal and reloading...');
                    
                    // Hide the rejected invitation immediately
                    const invitationCards = document.querySelectorAll('#invitationsContainer .col-12');
                    invitationCards.forEach(card => {
                        const acceptBtn = card.querySelector('button[onclick*="acceptInvitation(' + currentActivityId + ')"]');
                        if (acceptBtn) {
                            card.style.display = 'none';
                        }
                    });
                    
                    const modalEl = document.getElementById('rejectModal');
                    const modalInstance = bootstrap.Modal.getInstance(modalEl);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                    
                    // Remove backdrop
                    setTimeout(() => {
                        const backdrops = document.querySelectorAll('.modal-backdrop');
                        backdrops.forEach(backdrop => backdrop.remove());
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        document.body.style.paddingRight = '';
                        console.log('[Reject] Backdrop removed');
                    }, 300);
                    
                    // Reload invitations to get fresh data
                    setTimeout(() => {
                        console.log('[Reject] Reloading invitations...');
                        loadInvitations();
                    }, 1000);
                } else {
                    console.error('[Reject] Failed:', data.message);
                    showError(data.message || 'Failed to reject collaboration');
                }
            } catch (error) {
                console.error('Error rejecting invitation:', error);
                showError('An error occurred. Please try again.');
            }
        });

        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showSuccess(message) {
            // You can implement a toast notification here
            alert(message);
        }

        function showError(message) {
            alert(message);
        }

        // Load on page load
        loadInvitations();
    </script>
}
