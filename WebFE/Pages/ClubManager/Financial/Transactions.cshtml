@page
@model WebFE.Pages.ClubManager.Financial.TransactionsModel
@{
    ViewData["Title"] = "Transactions";
    ViewData["Breadcrumb"] = "Transactions";
    Layout = "~/Pages/Shared/_ClubManagerLayout.cshtml";
}

<link rel="stylesheet" href="~/css/financial-dashboard.css" asp-append-version="true" />

<style>
    .transaction-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
        box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
    }
    
    .transaction-header h1 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .transaction-header p {
        opacity: 0.9;
        margin-bottom: 0;
    }
    
    .action-buttons {
        display: flex;
        gap: 1rem;
    }
    
    .btn-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: 600;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .btn-gradient:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        color: white;
    }
    
    .btn-outline-gradient {
        background: white;
        border: 2px solid #667eea;
        color: #667eea;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: 600;
        transition: all 0.3s;
    }
    
    .btn-outline-gradient:hover {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: transparent;
        color: white;
        transform: translateY(-2px);
    }
    
    .filter-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
    }
    
    .filter-card .form-control,
    .filter-card .form-select {
        border-radius: 10px;
        border: 2px solid #e5e7eb;
        padding: 0.75rem 1rem;
        transition: all 0.3s;
    }
    
    .filter-card .form-control:focus,
    .filter-card .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .transaction-table-card {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    
    .transaction-table-card table {
        margin-bottom: 0;
    }
    
    .transaction-table-card thead {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
    
    .transaction-table-card thead th {
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        padding: 1rem;
    }
    
    .transaction-table-card tbody tr {
        transition: all 0.3s;
    }
    
    .transaction-table-card tbody tr:hover {
        background: #f8f9fa;
        transform: scale(1.01);
    }
    
    .badge-type-income {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 600;
    }
    
    .badge-type-expense {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 600;
    }
    
    .badge-status-completed {
        background: #d1fae5;
        color: #065f46;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 600;
    }
    
    .badge-status-pending {
        background: #fef3c7;
        color: #92400e;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 600;
    }
    
    .amount-positive {
        color: #10b981;
        font-weight: 700;
        font-size: 1.1rem;
    }
    
    .amount-negative {
        color: #ef4444;
        font-weight: 700;
        font-size: 1.1rem;
    }
    
    .action-btn {
        background: transparent;
        border: none;
        color: #6b7280;
        padding: 0.5rem;
        border-radius: 8px;
        transition: all 0.3s;
    }
    
    .action-btn:hover {
        background: #f3f4f6;
        color: #667eea;
    }
</style>

<div class="transaction-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1>üí∞ Transaction History</h1>
            <p>Track all your club's income and expenses</p>
        </div>
        <div class="action-buttons d-none d-md-flex">
            <button class="btn btn-gradient" data-bs-toggle="modal" data-bs-target="#addIncomeModal">
                <i data-lucide="plus-circle" style="width: 18px; height: 18px;"></i>
                Add Income
            </button>
            <button class="btn btn-outline-gradient" data-bs-toggle="modal" data-bs-target="#addExpenseModal">
                <i data-lucide="minus-circle" style="width: 18px; height: 18px;"></i>
                Add Expense
            </button>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="filter-card">
    <div class="row g-3 align-items-end">
        <div class="col-md-4">
            <label class="form-label fw-semibold mb-2">
                <i data-lucide="search" style="width: 16px; height: 16px;"></i>
                Search Transactions
            </label>
            <input type="text" class="form-control" id="searchTransactions" placeholder="Search by title, description, category...">
        </div>
        <div class="col-md-2">
            <label class="form-label fw-semibold mb-2">
                <i data-lucide="filter" style="width: 16px; height: 16px;"></i>
                Type
            </label>
            <select class="form-select" id="filterType">
                <option value="">All Types</option>
                <option value="Income">Income</option>
                <option value="Expense">Expense</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label fw-semibold mb-2">
                <i data-lucide="check-circle" style="width: 16px; height: 16px;"></i>
                Status
            </label>
            <select class="form-select" id="filterStatus">
                <option value="">All Status</option>
                <option value="completed">Completed</option>
                <option value="pending">Pending</option>
                <option value="cancelled">Cancelled</option>
            </select>
        </div>
        <div class="col-md-2">
            <button class="btn btn-primary w-100" onclick="applyFilters()">
                <i data-lucide="search" style="width: 16px; height: 16px;"></i>
                Search
            </button>
        </div>
        <div class="col-md-2">
            <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                <i data-lucide="x" style="width: 16px; height: 16px;"></i>
                Clear
            </button>
        </div>
    </div>
</div>

<!-- Transaction Table -->
<div class="transaction-table-card">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead>
                <tr>
                    <th class="px-4 py-3">
                        <i data-lucide="calendar" style="width: 16px; height: 16px;"></i>
                        Date
                    </th>
                    <th class="py-3">
                        <i data-lucide="tag" style="width: 16px; height: 16px;"></i>
                        Type
                    </th>
                    <th class="py-3">
                        <i data-lucide="file-text" style="width: 16px; height: 16px;"></i>
                        Source/Title
                    </th>
                    <th class="py-3">
                        <i data-lucide="folder" style="width: 16px; height: 16px;"></i>
                        Category
                    </th>
                    <th class="py-3">Description</th>
                    <th class="py-3 text-end">
                        <i data-lucide="dollar-sign" style="width: 16px; height: 16px;"></i>
                        Amount
                    </th>
                    <th class="py-3">
                        <i data-lucide="check-circle" style="width: 16px; height: 16px;"></i>
                        Status
                    </th>
                    <th class="py-3 text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="px-4">
                        <div class="fw-semibold">22/11/2025</div>
                        <small class="text-muted">10:30 AM</small>
                    </td>
                    <td>
                        <span class="badge-type-income">
                            <i data-lucide="trending-up" style="width: 14px; height: 14px;"></i>
                            Income
                        </span>
                    </td>
                    <td>
                        <div class="fw-semibold">Fund Collection: Testpaymen3</div>
                        <small class="text-muted">Auto-completed fund collection</small>
                    </td>
                    <td>
                        <span class="badge bg-info bg-opacity-10 text-info">
                            <i data-lucide="users" style="width: 12px; height: 12px;"></i>
                            member_fees
                        </span>
                    </td>
                    <td class="text-muted">Total collected from 4 members</td>
                    <td class="text-end amount-positive">+1.800.000 ‚Ç´</td>
                    <td>
                        <span class="badge-status-completed">
                            <i data-lucide="check" style="width: 14px; height: 14px;"></i>
                            Completed
                        </span>
                    </td>
                    <td class="text-center">
                        <button class="action-btn" title="View Details">
                            <i data-lucide="eye" style="width: 18px; height: 18px;"></i>
                        </button>
                        <button class="action-btn" title="Edit">
                            <i data-lucide="edit" style="width: 18px; height: 18px;"></i>
                        </button>
                    </td>
                </tr>
                <tr>
                    <td class="px-4">2024-01-18</td>
                    <td>
                        <span class="badge bg-danger">expense</span>
                    </td>
                    <td>Workshop Materials</td>
                    <td>
                        <span class="badge bg-secondary bg-opacity-10 text-secondary">event</span>
                    </td>
                    <td class="text-muted">Materials for React.js workshop</td>
                    <td class="text-end text-danger fw-bold">-1.200.000 ‚Ç´</td>
                    <td>
                        <span class="badge bg-success">completed</span>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-link text-secondary">
                            <i data-lucide="eye" style="width: 16px; height: 16px;"></i>
                        </button>
                        <button class="btn btn-sm btn-link text-secondary">
                            <i data-lucide="edit" style="width: 16px; height: 16px;"></i>
                        </button>
                    </td>
                </tr>
                <tr>
                    <td class="px-4">2024-01-20</td>
                    <td>
                        <span class="badge bg-primary">income</span>
                    </td>
                    <td>Member Contribution</td>
                    <td>
                        <span class="badge bg-secondary bg-opacity-10 text-secondary">member_fees</span>
                    </td>
                    <td class="text-muted">Q1 member fees collection (49 members)</td>
                    <td class="text-end text-success fw-bold">+2.450.000 ‚Ç´</td>
                    <td>
                        <span class="badge bg-success">completed</span>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-link text-secondary">
                            <i data-lucide="eye" style="width: 16px; height: 16px;"></i>
                        </button>
                    </td>
                </tr>
                <tr>
                    <td class="px-4">2024-01-22</td>
                    <td>
                        <span class="badge bg-danger">expense</span>
                    </td>
                    <td>Equipment Purchase</td>
                    <td>
                        <span class="badge bg-secondary bg-opacity-10 text-secondary">equipment</span>
                    </td>
                    <td class="text-muted">Laptop and projector for club activities</td>
                    <td class="text-end text-danger fw-bold">-3.500.000 ‚Ç´</td>
                    <td>
                        <span class="badge bg-success">completed</span>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-link text-secondary">
                            <i data-lucide="eye" style="width: 16px; height: 16px;"></i>
                        </button>
                        <button class="btn btn-sm btn-link text-secondary">
                            <i data-lucide="edit" style="width: 16px; height: 16px;"></i>
                        </button>
                    </td>
                </tr>
                <tr>
                    <td class="px-4">2024-01-25</td>
                    <td>
                        <span class="badge bg-primary">income</span>
                    </td>
                    <td>Event Ticket Sales</td>
                    <td>
                        <span class="badge bg-secondary bg-opacity-10 text-secondary">event_revenue</span>
                    </td>
                    <td class="text-muted">Hackathon 2024 ticket sales</td>
                    <td class="text-end text-success fw-bold">+1.800.000 ‚Ç´</td>
                    <td>
                        <span class="badge bg-success">completed</span>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-link text-secondary">
                            <i data-lucide="eye" style="width: 16px; height: 16px;"></i>
                        </button>
                    </td>
                </tr>
                <tr>
                    <td class="px-4">2024-01-28</td>
                    <td>
                        <span class="badge bg-danger">expense</span>
                    </td>
                    <td>Venue Rental</td>
                    <td>
                        <span class="badge bg-secondary bg-opacity-10 text-secondary">event</span>
                    </td>
                    <td class="text-muted">Conference hall rental for annual event</td>
                    <td class="text-end text-danger fw-bold">-2.000.000 ‚Ç´</td>
                    <td>
                        <span class="badge bg-warning">pending</span>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-link text-secondary">
                            <i data-lucide="eye" style="width: 16px; height: 16px;"></i>
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

@Html.Partial("_TransactionModals")

<!-- View Transaction Details Modal -->
<div class="modal fade" id="viewTransactionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Transaction Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label text-muted small">Title</label>
                        <div class="fw-bold" id="viewTitle">-</div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-muted small">Type</label>
                        <div id="viewType">-</div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label text-muted small">Status</label>
                        <div id="viewStatus">-</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted small">Category</label>
                        <div id="viewCategory">-</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted small">Amount</label>
                        <div class="fw-bold fs-5" id="viewAmount">-</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted small">Payment Method</label>
                        <div id="viewMethod">-</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted small">Transaction Date</label>
                        <div id="viewDate">-</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted small">Student</label>
                        <div id="viewStudent">-</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted small">Activity</label>
                        <div id="viewActivity">-</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted small">Semester</label>
                        <div id="viewSemester">-</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted small">Created By</label>
                        <div id="viewCreatedBy">-</div>
                    </div>
                    <div class="col-12">
                        <label class="form-label text-muted small">Description</label>
                        <div id="viewDescription">-</div>
                    </div>
                    <div class="col-12">
                        <label class="form-label text-muted small">Notes</label>
                        <div id="viewNotes">-</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Transaction Modal -->
<div class="modal fade" id="editTransactionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editTransactionForm">
                <input type="hidden" id="editTransactionId">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label for="editTitle" class="form-label">Title <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editTitle" required maxlength="200">
                        </div>
                        <div class="col-md-4">
                            <label for="editAmount" class="form-label">Amount (‚Ç´) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="editAmount" required min="0" step="1000">
                        </div>
                        <div class="col-md-6">
                            <label for="editType" class="form-label">Type <span class="text-danger">*</span></label>
                            <select class="form-select" id="editType" required disabled>
                                <option value="Income">Income</option>
                                <option value="Expense">Expense</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editCategory" class="form-label">Category</label>
                            <input type="text" class="form-control" id="editCategory" maxlength="100">
                        </div>
                        <div class="col-md-6">
                            <label for="editMethod" class="form-label">Payment Method <span class="text-danger">*</span></label>
                            <select class="form-select" id="editMethod" required>
                                <option value="Cash">Cash</option>
                                <option value="VNPAY">VNPAY</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editStatus" class="form-label">Status <span class="text-danger">*</span></label>
                            <select class="form-select" id="editStatus" required>
                                <option value="completed">Completed</option>
                                <option value="pending">Pending</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="editDate" class="form-label">Transaction Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="editDate" required>
                        </div>
                        <div class="col-md-6">
                            <label for="editReceiptUrl" class="form-label">Receipt URL</label>
                            <input type="url" class="form-control" id="editReceiptUrl" placeholder="https://...">
                        </div>
                        <div class="col-12">
                            <label for="editDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="editDescription" rows="2" maxlength="500"></textarea>
                        </div>
                        <div class="col-12">
                            <label for="editNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="editNotes" rows="2" maxlength="1000"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i data-lucide="save" style="width: 16px; height: 16px;"></i>
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const CLUB_ID = @Model.ClubId;
        const API_BASE = 'https://localhost:5001/api';

        let allTransactions = [];

        // Load transactions on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Set default dates to today
            document.getElementById('incomeDate').valueAsDate = new Date();
            document.getElementById('expenseDate').valueAsDate = new Date();
            
            // Load activities for both income and expense forms (once, no need to reload on date change)
            await loadActivitiesForForms();
            
            await loadTransactions();
            
            // Setup search and filter
            setupSearchAndFilter();
            
            lucide.createIcons();
        });

        // Setup search and filter event listeners
        function setupSearchAndFilter() {
            const searchInput = document.getElementById('searchTransactions');
            const typeFilter = document.getElementById('filterType');
            const statusFilter = document.getElementById('filterStatus');

            // Debounced search
            let searchTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    filterTransactions();
                }, 300);
            });

            typeFilter.addEventListener('change', filterTransactions);
            statusFilter.addEventListener('change', filterTransactions);
        }

        // Filter transactions based on search and filters
        function filterTransactions() {
            const searchTerm = document.getElementById('searchTransactions').value.toLowerCase();
            const typeFilter = document.getElementById('filterType').value;
            const statusFilter = document.getElementById('filterStatus').value;

            let filtered = [...allTransactions];

            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(t => 
                    t.title.toLowerCase().includes(searchTerm) ||
                    (t.description && t.description.toLowerCase().includes(searchTerm)) ||
                    (t.category && t.category.toLowerCase().includes(searchTerm))
                );
            }

            // Apply type filter
            if (typeFilter) {
                filtered = filtered.filter(t => t.type === typeFilter);
            }

            // Apply status filter
            if (statusFilter) {
                filtered = filtered.filter(t => t.status === statusFilter);
            }

            renderTransactions(filtered);
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('searchTransactions').value = '';
            document.getElementById('filterType').value = '';
            document.getElementById('filterStatus').value = '';
            renderTransactions(allTransactions);
        }

        // Upload receipt image to Cloudinary
        async function uploadReceiptImage(file) {
            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch(`${API_BASE}/PaymentTransaction/upload-receipt`, {
                method: 'POST',
                credentials: 'include',
                body: formData
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Upload failed');
            }

            const result = await response.json();
            return result.url;
        }

        // Load activities (Approved or PendingApproval)
        async function loadActivitiesForForms() {
            try {
                console.log('üîç Loading activities...');
                
                const response = await fetch(`${API_BASE}/PaymentTransaction/club/${CLUB_ID}/activities`, {
                    credentials: 'include'
                });
                
                console.log('üì° Response status:', response.status);
                
                if (response.ok) {
                    const activities = await response.json();
                    console.log('üì¶ Received activities:', activities);
                    
                    // Clear and populate both income and expense activity dropdowns
                    const incomeSelect = document.getElementById('incomeActivity');
                    const expenseSelect = document.getElementById('expenseActivity');
                    
                    console.log('üéØ Income select found:', !!incomeSelect);
                    console.log('üéØ Expense select found:', !!expenseSelect);
                    
                    // Clear existing options (except the first "None" option)
                    if (incomeSelect) {
                        while (incomeSelect.options.length > 1) {
                            incomeSelect.remove(1);
                        }
                    }
                    if (expenseSelect) {
                        while (expenseSelect.options.length > 1) {
                            expenseSelect.remove(1);
                        }
                    }
                    
                    // Add new options
                    activities.forEach(activity => {
                        const startDate = new Date(activity.startTime).toLocaleDateString('vi-VN');
                        const statusLabel = activity.status === 'PendingApproval' ? '[Pending]' : '[Approved]';
                        const optionText = `${activity.title} (${startDate}) ${statusLabel}`;
                        
                        // Add to income dropdown
                        if (incomeSelect) {
                            const option = document.createElement('option');
                            option.value = activity.id;
                            option.textContent = optionText;
                            incomeSelect.appendChild(option);
                        }
                        
                        // Add to expense dropdown
                        if (expenseSelect) {
                            const option = document.createElement('option');
                            option.value = activity.id;
                            option.textContent = optionText;
                            expenseSelect.appendChild(option);
                        }
                    });
                    
                    console.log(`‚úÖ Loaded ${activities.length} activities (Approved or PendingApproval)`);
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Failed to load activities:', response.status, errorText);
                }
            } catch (error) {
                console.error('‚ùå Error loading activities:', error);
            }
        }

        // Handle Add Income form
        document.getElementById('addIncomeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await submitTransaction('Income');
        });

        // Handle Add Expense form
        document.getElementById('addExpenseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await submitTransaction('Expense');
        });

        // Submit transaction
        async function submitTransaction(type) {
            const prefix = type.toLowerCase();
            
            // Upload receipt image if provided
            const receiptFileInput = document.getElementById(`${prefix}ReceiptFile`);
            let receiptUrl = null;
            
            if (receiptFileInput && receiptFileInput.files.length > 0) {
                try {
                    console.log('üìé Uploading receipt image:', receiptFileInput.files[0].name);
                    receiptUrl = await uploadReceiptImage(receiptFileInput.files[0]);
                    console.log('‚úÖ Receipt uploaded:', receiptUrl);
                } catch (error) {
                    console.error('‚ùå Failed to upload receipt:', error);
                    showToast('Failed to upload receipt image', 'danger');
                    return; // Stop transaction creation if upload fails
                }
            }
            
            const dto = {
                title: document.getElementById(`${prefix}Title`).value,
                type: type,
                category: document.getElementById(`${prefix}Category`).value || null,
                amount: parseFloat(document.getElementById(`${prefix}Amount`).value),
                method: document.getElementById(`${prefix}Method`).value,
                transactionDate: new Date(document.getElementById(`${prefix}Date`).value + 'T00:00:00').toISOString(),
                receiptUrl: receiptUrl,
                description: document.getElementById(`${prefix}Description`).value || null,
                notes: document.getElementById(`${prefix}Notes`).value || null,
                activityId: null
            };

            // Add ActivityId if selected (for both Income and Expense)
            const activitySelect = document.getElementById(`${prefix}Activity`);
            if (activitySelect && activitySelect.value) {
                dto.activityId = parseInt(activitySelect.value);
            }

            console.log('üì¶ Submitting transaction:', dto);

            try {
                const response = await fetch(`${API_BASE}/PaymentTransaction/club/${CLUB_ID}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(dto)
                });

                console.log('üì° Response status:', response.status);

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Success:', result);
                    
                    // Close modal
                    const modalId = type === 'Income' ? 'addIncomeModal' : 'addExpenseModal';
                    const modal = bootstrap.Modal.getInstance(document.getElementById(modalId));
                    modal.hide();
                    
                    // Reset form
                    const formId = type === 'Income' ? 'addIncomeForm' : 'addExpenseForm';
                    document.getElementById(formId).reset();
                    document.getElementById(`${prefix}Date`).valueAsDate = new Date();
                    
                    // Reset activity dropdown
                    const activitySelect = document.getElementById(`${prefix}Activity`);
                    if (activitySelect) activitySelect.value = '';
                    
                    // Show success message
                    showToast(`${type} added successfully!`, 'success');
                    
                    // Reload transactions
                    await loadTransactions();
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Error response:', errorText);
                    
                    let errorMessage = `Failed to add ${type.toLowerCase()}`;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.message || errorJson.title || errorMessage;
                    } catch (e) {
                        errorMessage = errorText || errorMessage;
                    }
                    
                    showToast(errorMessage, 'danger');
                }
            } catch (error) {
                console.error(`‚ùå Error adding ${type.toLowerCase()}:`, error);
                showToast(`An error occurred: ${error.message}`, 'danger');
            }
        }

        async function loadTransactions() {
            try {
                const response = await fetch(`${API_BASE}/PaymentTransaction/club/${CLUB_ID}`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    allTransactions = await response.json();
                    console.log('Transactions loaded:', allTransactions);
                    renderTransactions(allTransactions);
                } else {
                    console.error('Failed to load transactions:', response.status, response.statusText);
                    showError('Failed to load transactions');
                }
            } catch (error) {
                console.error('Error loading transactions:', error);
                showError('An error occurred while loading transactions');
            }
        }

        function renderTransactions(transactions) {
            const tbody = document.querySelector('tbody');
            
            if (!transactions || transactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-5 text-muted">
                            <i data-lucide="inbox" style="width: 48px; height: 48px;"></i>
                            <p class="mt-2">No transactions found</p>
                        </td>
                    </tr>
                `;
                lucide.createIcons();
                return;
            }

            tbody.innerHTML = transactions.map(t => {
                const isIncome = t.type === 'Income';
                const typeClass = isIncome ? 'primary' : 'danger';
                const amountClass = isIncome ? 'success' : 'danger';
                const amountSign = isIncome ? '+' : '-';
                const statusClass = t.status === 'completed' ? 'success' : t.status === 'pending' ? 'warning' : 'secondary';
                const date = new Date(t.transactionDate).toLocaleDateString('vi-VN');

                return `
                    <tr>
                        <td class="px-4">${date}</td>
                        <td>
                            <span class="badge bg-${typeClass}">${t.type.toLowerCase()}</span>
                        </td>
                        <td>${escapeHtml(t.title)}</td>
                        <td>
                            ${t.category ? `<span class="badge bg-secondary bg-opacity-10 text-secondary">${t.category}</span>` : '-'}
                        </td>
                        <td class="text-muted">${escapeHtml(t.description || '-')}</td>
                        <td class="text-end text-${amountClass} fw-bold">${amountSign}${formatCurrency(t.amount)}</td>
                        <td>
                            <span class="badge bg-${statusClass}">${t.status}</span>
                        </td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-link text-secondary" onclick="viewTransaction(${t.id})">
                                <i data-lucide="eye" style="width: 16px; height: 16px;"></i>
                            </button>
                            ${canEdit(t) ? `
                                <button class="btn btn-sm btn-link text-secondary" onclick="editTransaction(${t.id})">
                                    <i data-lucide="edit" style="width: 16px; height: 16px;"></i>
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            }).join('');

            lucide.createIcons();
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'decimal' }).format(Math.abs(amount)) + ' ‚Ç´';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function viewTransaction(id) {
            const transaction = allTransactions.find(t => t.id === id);
            if (!transaction) {
                alert('Transaction not found');
                return;
            }

            // Populate view modal
            document.getElementById('viewTitle').textContent = transaction.title;
            
            const isIncome = transaction.type === 'Income';
            const typeClass = isIncome ? 'primary' : 'danger';
            document.getElementById('viewType').innerHTML = `<span class="badge bg-${typeClass}">${transaction.type}</span>`;
            
            const statusClass = transaction.status === 'completed' ? 'success' : transaction.status === 'pending' ? 'warning' : 'secondary';
            document.getElementById('viewStatus').innerHTML = `<span class="badge bg-${statusClass}">${transaction.status}</span>`;
            
            document.getElementById('viewCategory').innerHTML = transaction.category 
                ? `<span class="badge bg-secondary bg-opacity-10 text-secondary">${transaction.category}</span>` 
                : '-';
            
            const amountClass = isIncome ? 'success' : 'danger';
            const amountSign = isIncome ? '+' : '-';
            document.getElementById('viewAmount').innerHTML = `<span class="text-${amountClass}">${amountSign}${formatCurrency(transaction.amount)}</span>`;
            
            document.getElementById('viewMethod').textContent = transaction.method || '-';
            document.getElementById('viewDate').textContent = new Date(transaction.transactionDate).toLocaleString('vi-VN');
            
            document.getElementById('viewStudent').textContent = transaction.studentName 
                ? `${transaction.studentName} (${transaction.studentCode})` 
                : '-';
            
            document.getElementById('viewActivity').textContent = transaction.activityTitle || '-';
            document.getElementById('viewSemester').textContent = transaction.semesterName || '-';
            document.getElementById('viewCreatedBy').textContent = transaction.createdByName || '-';
            document.getElementById('viewDescription').textContent = transaction.description || '-';
            document.getElementById('viewNotes').textContent = transaction.notes || '-';

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('viewTransactionModal'));
            modal.show();
            
            // Reinit Lucide icons
            setTimeout(() => lucide.createIcons(), 100);
        }

        // Check if transaction can be edited
        function canEdit(transaction) {
            // All Expenses can be edited
            if (transaction.type === 'Expense') {
                return true;
            }
            
            // Income can be edited if:
            // 1. Has StudentId (member contribution from manual entry)
            // 2. OR created by Club Manager (has CreatedById)
            // This allows Club Managers to edit sponsor/donation income they created
            if (transaction.type === 'Income') {
                // Allow edit if has StudentId OR has CreatedById
                return transaction.studentId != null || transaction.createdById != null;
            }
            
            return false;
        }

        function editTransaction(id) {
            const transaction = allTransactions.find(t => t.id === id);
            if (!transaction) {
                alert('Transaction not found');
                return;
            }

            // Check if can edit
            if (!canEdit(transaction)) {
                alert('Cannot edit this transaction. Admin/sponsor income cannot be modified.');
                return;
            }

            // Populate edit modal with current values
            document.getElementById('editTransactionId').value = transaction.id;
            document.getElementById('editTitle').value = transaction.title || '';
            document.getElementById('editType').value = transaction.type || 'Expense';
            document.getElementById('editCategory').value = transaction.category || '';
            document.getElementById('editAmount').value = transaction.amount || 0;
            document.getElementById('editStatus').value = transaction.status || 'completed';
            document.getElementById('editMethod').value = transaction.method || 'Cash';
            
            // Format date properly
            if (transaction.transactionDate) {
                const date = new Date(transaction.transactionDate);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                document.getElementById('editDate').value = `${year}-${month}-${day}`;
            } else {
                document.getElementById('editDate').value = '';
            }
            
            document.getElementById('editReceiptUrl').value = transaction.receiptUrl || '';
            document.getElementById('editDescription').value = transaction.description || '';
            document.getElementById('editNotes').value = transaction.notes || '';

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('editTransactionModal'));
            modal.show();
            
            // Reinit Lucide icons
            setTimeout(() => lucide.createIcons(), 100);
        }

        // Handle edit form submission
        document.getElementById('editTransactionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('editTransactionId').value;
            const dto = {
                title: document.getElementById('editTitle').value,
                type: document.getElementById('editType').value,
                category: document.getElementById('editCategory').value || null,
                amount: parseFloat(document.getElementById('editAmount').value),
                status: document.getElementById('editStatus').value,
                method: document.getElementById('editMethod').value,
                transactionDate: new Date(document.getElementById('editDate').value + 'T00:00:00').toISOString(),
                receiptUrl: document.getElementById('editReceiptUrl').value || null,
                description: document.getElementById('editDescription').value || null,
                notes: document.getElementById('editNotes').value || null
            };

            try {
                const response = await fetch(`${API_BASE}/PaymentTransaction/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(dto)
                });

                if (response.ok) {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editTransactionModal'));
                    modal.hide();
                    
                    // Show success message
                    showToast('Transaction updated successfully!', 'success');
                    
                    // Reload transactions
                    await loadTransactions();
                } else {
                    const error = await response.json();
                    showToast(error.message || 'Failed to update transaction', 'danger');
                }
            } catch (error) {
                console.error('Error updating transaction:', error);
                showToast('An error occurred while updating transaction', 'danger');
            }
        });

        function showError(message) {
            const tbody = document.querySelector('tbody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-5 text-danger">
                        <i data-lucide="alert-circle" style="width: 48px; height: 48px;"></i>
                        <p class="mt-2">${message}</p>
                    </td>
                </tr>
            `;
            lucide.createIcons();
        }

        function showToast(message, type = 'success') {
            // Create toast container if it doesn't exist
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '9999';
                document.body.appendChild(toastContainer);
            }

            // Create toast element
            const toastId = 'toast-' + Date.now();
            const bgClass = type === 'success' ? 'bg-success' : type === 'danger' ? 'bg-danger' : 'bg-warning';
            const iconName = type === 'success' ? 'check-circle' : type === 'danger' ? 'alert-circle' : 'info';
            
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i data-lucide="${iconName}" style="width: 16px; height: 16px;"></i>
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            // Initialize and show toast
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, {
                autohide: true,
                delay: 3000
            });
            toast.show();
            
            // Reinit Lucide icons
            lucide.createIcons();
            
            // Remove toast element after hidden
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        lucide.createIcons();
    </script>
}



