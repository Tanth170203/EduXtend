@page
@model WebFE.Pages.ClubManager.NewsModel
@{
    ViewData["Title"] = "Club News";
    ViewData["Breadcrumb"] = "Club News";
    Layout = "~/Pages/Shared/_ClubManagerLayout.cshtml";
}

<!-- Page Header -->
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title">Club News</h1>
            <p class="page-description">Manage your club's news</p>
        </div>
        <button class="btn btn-primary" onclick="showCreateModal()">
            <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
            Create News
        </button>
    </div>
</div>

<!-- Stats Cards -->
<div class="stats-grid mb-4">
    <div class="stat-card">
        <div class="stat-card-header">
            <div>
                <p class="stat-card-title">Pending Approval</p>
            </div>
            <div class="stat-card-icon orange">
                <i data-lucide="clock" style="width: 24px; height: 24px;"></i>
            </div>
        </div>
        <div class="stat-card-value" id="pendingCount">0</div>
        <div class="stat-card-change">
            <span>Awaiting review</span>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-card-header">
            <div>
                <p class="stat-card-title">Approved</p>
            </div>
            <div class="stat-card-icon green">
                <i data-lucide="check-circle" style="width: 24px; height: 24px;"></i>
            </div>
        </div>
        <div class="stat-card-value" id="approvedCount">0</div>
        <div class="stat-card-change positive">
            <span>Published</span>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-card-header">
            <div>
                <p class="stat-card-title">Total News</p>
            </div>
            <div class="stat-card-icon blue">
                <i data-lucide="newspaper" style="width: 24px; height: 24px;"></i>
            </div>
        </div>
        <div class="stat-card-value" id="totalCount">0</div>
        <div class="stat-card-change">
            <span>All time</span>
        </div>
    </div>
</div>

<!-- Filter -->
<div class="content-card mb-3">
    <div class="content-card-body">
        <div class="d-flex justify-content-between align-items-center">
            <h2 class="content-card-title mb-0">My Club News</h2>
            <select class="form-select form-select-sm" id="statusFilter" onchange="filterNews()" style="width: auto;">
                <option value="all">All Status</option>
                <option value="approved">Approved</option>
                <option value="pending">Pending Approval</option>
            </select>
        </div>
    </div>
</div>

<!-- News Table -->
<div class="content-card">
    <div class="content-card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th style="width: 60px;">ID</th>
                        <th>Title</th>
                        <th style="width: 150px;">Status</th>
                        <th style="width: 180px;">Published</th>
                        <th style="width: 150px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="newsTableBody">
                    <tr>
                        <td colspan="5" class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <nav aria-label="News pagination" class="mt-3">
            <ul class="pagination justify-content-center mb-0" id="pagination"></ul>
        </nav>
    </div>
</div>

<!-- Create/Edit Modal -->
<div class="modal fade" id="newsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newsModalTitle">Create News</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newsForm">
                    <input type="hidden" id="newsId" />
                    
                    <div class="mb-3">
                        <label for="newsTitle" class="form-label">Title <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="newsTitle" maxlength="200" required />
                        <div class="form-text">Maximum 200 characters</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="newsContent" class="form-label">Content</label>
                        <textarea class="form-control" id="newsContent" rows="6" maxlength="1000"></textarea>
                        <div class="form-text">Maximum 1000 characters</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="newsImage" class="form-label">Image</label>
                        <div class="input-group mb-2">
                            <input type="text" class="form-control" id="newsImageUrl" placeholder="Image URL" />
                            <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('newsImageFile').click()">
                                <i data-lucide="upload" style="width: 16px; height: 16px;"></i>
                                Upload
                            </button>
                        </div>
                        <input type="file" id="newsImageFile" accept="image/*" style="display: none;" onchange="uploadImage(this)" />
                        <div class="form-text" id="fileNameDisplay">No file chosen</div>
                        <div id="imagePreview" class="mt-2" style="display: none;">
                            <img id="previewImg" src="" alt="Preview" class="img-thumbnail" style="max-height: 200px;" />
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="newsFacebookUrl" class="form-label">Facebook URL</label>
                        <input type="url" class="form-control" id="newsFacebookUrl" placeholder="https://facebook.com/..." />
                    </div>
                    
                    <div class="alert alert-info">
                        <i data-lucide="info" style="width: 16px; height: 16px;"></i>
                        News will require Admin approval before being published publicly.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveNews()">
                    <span id="saveButtonText">Create News</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- View Details Modal -->
<div class="modal fade" id="viewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewModalTitle">News Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="viewModalBody">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let newsModal, viewModal;
        let currentClubId = null;

        document.addEventListener('DOMContentLoaded', async function() {
            newsModal = new bootstrap.Modal(document.getElementById('newsModal'));
            viewModal = new bootstrap.Modal(document.getElementById('viewModal'));
            
            // Get club info
            await loadClubInfo();
            
            // Load news
            await loadNews();
            
            // Initialize Lucide icons
            lucide.createIcons();
        });

        async function loadClubInfo() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/club/my-managed-club`, {
                    credentials: 'include'
                });
                
                if (res.ok) {
                    const club = await res.json();
                    currentClubId = club.id;
                } else if (res.status === 404) {
                    error('Error', 'You are not managing any club. Please contact admin.');
                    // Disable create button
                    const createBtn = document.querySelector('button[onclick="showCreateModal()"]');
                    if (createBtn) {
                        createBtn.disabled = true;
                        createBtn.textContent = 'No Club Assigned';
                    }
                } else {
                    const errorText = await res.text();
                    console.error('API Error:', errorText);
                    error('Error', 'Cannot load club information');
                }
            } catch (e) {
                console.error('Error loading club info:', e);
                error('Error', 'Cannot load club information: ' + e.message);
            }
        }

        async function loadNews() {
            const statusFilter = document.getElementById('statusFilter').value;
            const list = document.getElementById('newsList');
            
            // Check if club is loaded
            if (!currentClubId) {
                list.innerHTML = `
                    <div class="col-12 text-center py-5 text-muted">
                        <i data-lucide="alert-circle" style="width: 48px; height: 48px; margin-bottom: 1rem;"></i>
                        <p>No club assigned. Please contact admin.</p>
                    </div>`;
                lucide.createIcons();
                return;
            }
            
            try {
                list.innerHTML = '<div class="col-12 text-center py-5"><div class="spinner-border text-primary" role="status"></div></div>';
                
                let url = `${API_BASE_URL}/api/club-news?clubId=${currentClubId}&approvedOnly=false`;
                
                const res = await fetch(url, { credentials: 'include' });
                
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('API Error:', errorText);
                    throw new Error(`API returned ${res.status}`);
                }
                
                let items = await res.json();
                
                // Filter by status
                if (statusFilter === 'approved') {
                    items = items.filter(n => n.isApproved);
                } else if (statusFilter === 'pending') {
                    items = items.filter(n => !n.isApproved);
                }
                
                if (items.length === 0) {
                    list.innerHTML = `
                        <div class="col-12 text-center py-5 text-muted">
                            <i data-lucide="inbox" style="width: 48px; height: 48px; margin-bottom: 1rem;"></i>
                            <p>No news yet. Create your first news!</p>
                        </div>`;
                    lucide.createIcons();
                    return;
                }
                
                list.innerHTML = '';
                items.forEach(n => {
                    const col = document.createElement('div');
                    col.className = 'col-md-6 col-lg-4';
                    
                    const statusBadge = n.isApproved 
                        ? '<span class="badge bg-success">Approved</span>'
                        : '<span class="badge bg-warning text-dark">Pending Approval</span>';
                    
                    col.innerHTML = `
                        <div class="card h-100 shadow-sm border-0">
                            ${n.imageUrl ? `
                                <div style="width:100%;overflow:hidden;background:#f8f9fa;aspect-ratio:16/9;display:flex;align-items:center;justify-content:center;">
                                    <img src="${n.imageUrl}" class="card-img-top" alt="${n.title}" 
                                         style="width:100%;height:100%;object-fit:cover;" 
                                         onerror="this.style.display='none';">
                                </div>` : ''}
                            <div class="card-body d-flex flex-column">
                                <div class="mb-2">${statusBadge}</div>
                                <h5 class="card-title">${n.title}</h5>
                                <p class="text-muted small mb-3">
                                    <i data-lucide="calendar" style="width: 14px; height: 14px;"></i>
                                    ${formatDate(n.publishedAt)}
                                </p>
                                <div class="mt-auto d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewNews(${n.id})">
                                        <i data-lucide="eye" style="width: 14px; height: 14px;"></i>
                                        View
                                    </button>
                                    ${!n.isApproved ? `
                                        <button class="btn btn-sm btn-outline-secondary" onclick="editNews(${n.id})">
                                            <i data-lucide="edit" style="width: 14px; height: 14px;"></i>
                                            Edit
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteNews(${n.id})">
                                            <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>`;
                    list.appendChild(col);
                });
                
                lucide.createIcons();
            } catch (e) {
                console.error('Error loading news:', e);
                list.innerHTML = '<div class="col-12"><div class="alert alert-danger">Error loading news</div></div>';
            }
        }

        function showCreateModal() {
            document.getElementById('newsModalTitle').textContent = 'Create News';
            document.getElementById('saveButtonText').textContent = 'Create News';
            document.getElementById('newsForm').reset();
            document.getElementById('newsId').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('fileNameDisplay').textContent = 'No file chosen';
            newsModal.show();
        }

        async function editNews(id) {
            try {
                const res = await fetch(`${API_BASE_URL}/api/club-news/${id}`, {
                    credentials: 'include'
                });
                
                if (!res.ok) {
                    error('Error', 'Cannot load news details');
                    return;
                }
                
                const news = await res.json();
                
                // Check if already approved
                if (news.isApproved) {
                    error('Error', 'Cannot edit approved news');
                    return;
                }
                
                document.getElementById('newsModalTitle').textContent = 'Edit News';
                document.getElementById('saveButtonText').textContent = 'Update News';
                document.getElementById('newsId').value = news.id;
                document.getElementById('newsTitle').value = news.title;
                document.getElementById('newsContent').value = news.content || '';
                document.getElementById('newsImageUrl').value = news.imageUrl || '';
                document.getElementById('newsFacebookUrl').value = news.facebookUrl || '';
                
                if (news.imageUrl) {
                    document.getElementById('previewImg').src = news.imageUrl;
                    document.getElementById('imagePreview').style.display = 'block';
                }
                
                newsModal.show();
            } catch (e) {
                console.error('Error loading news:', e);
                error('Error', 'Cannot load news details');
            }
        }

        async function viewNews(id) {
            try {
                const res = await fetch(`${API_BASE_URL}/api/club-news/${id}`, {
                    credentials: 'include'
                });
                
                if (!res.ok) {
                    error('Error', 'Cannot load news details');
                    return;
                }
                
                const news = await res.json();
                
                const statusBadge = news.isApproved 
                    ? '<span class="badge bg-success">Approved</span>'
                    : '<span class="badge bg-warning text-dark">Pending Approval</span>';
                
                document.getElementById('viewModalTitle').textContent = news.title;
                document.getElementById('viewModalBody').innerHTML = `
                    <div class="mb-3">${statusBadge}</div>
                    ${news.imageUrl ? `
                        <div class="mb-3">
                            <img src="${news.imageUrl}" class="img-fluid rounded" alt="${news.title}" />
                        </div>` : ''}
                    <div class="mb-3">
                        <strong>Published:</strong> ${formatDate(news.publishedAt)}
                    </div>
                    <div class="mb-3">
                        <strong>Content:</strong>
                        <p style="white-space: pre-line;">${news.content || 'No content'}</p>
                    </div>
                    ${news.facebookUrl ? `
                        <div class="mb-3">
                            <strong>Facebook:</strong> 
                            <a href="${news.facebookUrl}" target="_blank">${news.facebookUrl}</a>
                        </div>` : ''}
                `;
                
                viewModal.show();
            } catch (e) {
                console.error('Error loading news:', e);
                error('Error', 'Cannot load news details');
            }
        }

        async function saveNews() {
            const id = document.getElementById('newsId').value;
            const title = document.getElementById('newsTitle').value.trim();
            const content = document.getElementById('newsContent').value.trim();
            const imageUrl = document.getElementById('newsImageUrl').value.trim();
            const facebookUrl = document.getElementById('newsFacebookUrl').value.trim();
            
            if (!title) {
                error('Validation Error', 'Title is required');
                return;
            }
            
            const data = {
                title,
                content: content || null,
                imageUrl: imageUrl || null,
                facebookUrl: facebookUrl || null
            };
            
            try {
                const url = id 
                    ? `${API_BASE_URL}/api/club-news/${id}`
                    : `${API_BASE_URL}/api/club-news`;
                
                const method = id ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    success('Success', id ? 'News updated successfully' : 'News created successfully. Waiting for admin approval.');
                    newsModal.hide();
                    await loadNews();
                } else {
                    const err = await res.text();
                    error('Error', err || 'Failed to save news');
                }
            } catch (e) {
                console.error('Error saving news:', e);
                error('Error', 'Failed to save news');
            }
        }

        async function deleteNews(id) {
            if (!confirm('Are you sure you want to delete this news?')) return;
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/club-news/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (res.ok) {
                    success('Success', 'News deleted successfully');
                    await loadNews();
                } else {
                    error('Error', 'Failed to delete news');
                }
            } catch (e) {
                console.error('Error deleting news:', e);
                error('Error', 'Failed to delete news');
            }
        }

        async function uploadImage(input) {
            if (!input.files || !input.files[0]) {
                document.getElementById('fileNameDisplay').textContent = 'No file chosen';
                return;
            }
            
            const file = input.files[0];
            
            // Display file name
            document.getElementById('fileNameDisplay').textContent = file.name;
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/club-news/upload-image`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('newsImageUrl').value = data.url;
                    document.getElementById('previewImg').src = data.url;
                    document.getElementById('imagePreview').style.display = 'block';
                    success('Success', 'Image uploaded successfully');
                } else {
                    error('Error', 'Failed to upload image');
                    document.getElementById('fileNameDisplay').textContent = 'Upload failed';
                }
            } catch (e) {
                console.error('Error uploading image:', e);
                error('Error', 'Failed to upload image');
                document.getElementById('fileNameDisplay').textContent = 'Upload failed';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
}
