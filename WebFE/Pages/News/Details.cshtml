@page
@{
    ViewData["Title"] = "News Details";
    Layout = "~/Pages/Shared/_Layout.cshtml";
}

<div class="container py-4">
    <div id="newsContainer"></div>
</div>

@section Scripts {
    <script>
        function q(key) {
            const u = new URL(window.location.href);
            return u.searchParams.get(key);
        }
        function formatLocalDateTime(dateString) {
            if (!dateString) return '';
            try {
                let dateStr = String(dateString).trim();
                
                // Debug: Log original date string
                console.log('Original date string from server:', dateStr);
                
                // If the date string doesn't have timezone indicator, assume it's UTC
                // ASP.NET Core typically serializes DateTime as ISO 8601, but may not include timezone
                if (dateStr.includes('T') && !dateStr.endsWith('Z') && !dateStr.match(/[+-]\d{2}:\d{2}$/)) {
                    // Remove fractional seconds if present and append 'Z' to indicate UTC
                    dateStr = dateStr.replace(/\.\d{1,7}(?=[Z+-]|$)/, '') + 'Z';
                    console.log('Normalized to UTC:', dateStr);
                }
                
                // Parse as Date object (JavaScript will automatically convert UTC to local time)
                const date = new Date(dateStr);
                
                if (isNaN(date.getTime())) {
                    console.warn('Invalid date after parsing:', dateStr);
                    return '';
                }
                
                // Debug: Log UTC and local time
                console.log('UTC time:', date.toISOString());
                console.log('Local time:', date.toString());
                console.log('Local hours:', date.getHours(), 'UTC hours:', date.getUTCHours());
                
                // Format as local time: dd/MM/yyyy HH:mm
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${day}/${month}/${year} ${hours}:${minutes}`;
            } catch (e) {
                console.error('Error formatting date:', e, dateString);
                return '';
            }
        }
        async function loadDetails() {
            const id = q('id');
            if (!id) return;
            try {
                const res = await fetch(`${API_BASE_URL}/api/news/${id}`, { credentials: 'include' });
                if (!res.ok) {
                    document.getElementById('newsContainer').innerHTML = '<div class="alert alert-warning">Article not found or unpublished.</div>';
                    return;
                }
                const n = await res.json();
                const el = document.getElementById('newsContainer');
                el.innerHTML = `
                    <div class="card shadow-sm border-0">
                        ${n.imageUrl ? `<div class="card-img-wrapper" style="width:100%;max-width:100%;background:#f8f9fa;padding:0;margin:0;">
                            <img src="${n.imageUrl}" class="card-img-top" alt="${n.title}" 
                                 style="width:100%;height:auto;max-height:600px;object-fit:contain;object-position:center;display:block;" 
                                 onerror="this.onerror=null; this.style.display='none'; this.parentElement.style.display='none';">
                        </div>` : ''}
                        <div class="card-body">
                            <h3 class="card-title mb-3">${n.title}</h3>
                            <div class="text-muted mb-3">${formatLocalDateTime(n.publishedAt)}</div>
                            <div class="news-content" style="line-height:1.8;white-space:pre-line;">${(n.content || '').replace(/\n/g, '<br/>')}</div>
                            ${n.facebookUrl ? `<div class="mt-3"><a class="btn btn-outline-primary" href="${n.facebookUrl}" target="_blank">Facebook</a></div>` : ''}
                        </div>
                    </div>`;
            } catch (e) {
                console.error(e);
            }
        }
        document.addEventListener('DOMContentLoaded', loadDetails);
    </script>
}


