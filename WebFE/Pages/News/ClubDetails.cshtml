@page
@{
    ViewData["Title"] = "Club News Details";
    Layout = "~/Pages/Shared/_Layout.cshtml";
}

<div class="container py-4">
    <div id="newsContainer"></div>
</div>

@section Scripts {
    <script>
        function q(key) {
            const u = new URL(window.location.href);
            return u.searchParams.get(key);
        }
        
        function formatLocalDateTime(dateString) {
            if (!dateString) return '';
            try {
                let dateStr = String(dateString).trim();
                
                if (dateStr.includes('T') && !dateStr.endsWith('Z') && !dateStr.match(/[+-]\d{2}:\d{2}$/)) {
                    dateStr = dateStr.replace(/\.\d{1,7}(?=[Z+-]|$)/, '') + 'Z';
                }
                
                const date = new Date(dateStr);
                
                if (isNaN(date.getTime())) {
                    return '';
                }
                
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${day}/${month}/${year} ${hours}:${minutes}`;
            } catch (e) {
                console.error('Error formatting date:', e, dateString);
                return '';
            }
        }
        
        async function loadDetails() {
            const id = q('id');
            if (!id) {
                document.getElementById('newsContainer').innerHTML = '<div class="alert alert-warning">News ID not provided.</div>';
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE_URL}/api/club-news/${id}`, { credentials: 'include' });
                if (!res.ok) {
                    document.getElementById('newsContainer').innerHTML = '<div class="alert alert-warning">News not found or not approved yet.</div>';
                    return;
                }
                
                const n = await res.json();
                
                // Check if approved
                if (!n.isApproved) {
                    document.getElementById('newsContainer').innerHTML = '<div class="alert alert-warning">This news is pending approval.</div>';
                    return;
                }
                
                const el = document.getElementById('newsContainer');
                el.innerHTML = `
                    <div class="card shadow-sm border-0">
                        ${n.imageUrl ? `<div class="card-img-wrapper" style="width:100%;max-width:100%;background:#f8f9fa;padding:0;margin:0;">
                            <img src="${n.imageUrl}" class="card-img-top" alt="${n.title}" 
                                 style="width:100%;height:auto;max-height:600px;object-fit:contain;object-position:center;display:block;" 
                                 onerror="this.onerror=null; this.style.display='none'; this.parentElement.style.display='none';">
                        </div>` : ''}
                        <div class="card-body">
                            <div class="mb-3">
                                <span class="badge bg-primary">${n.clubName}</span>
                                <span class="badge bg-success ms-2">Approved</span>
                            </div>
                            <h3 class="card-title mb-3">${n.title}</h3>
                            <div class="text-muted mb-3">
                                <i class="bi bi-calendar"></i>
                                ${formatLocalDateTime(n.publishedAt)}
                            </div>
                            <div class="text-muted mb-3">
                                <i class="bi bi-person"></i>
                                Posted by: ${n.createdByName || 'Unknown'}
                            </div>
                            <div class="news-content" style="line-height:1.8;white-space:pre-line;">${(n.content || '').replace(/\n/g, '<br/>')}</div>
                            ${n.facebookUrl ? `<div class="mt-3">
                                <a class="btn btn-outline-primary" href="${n.facebookUrl}" target="_blank">
                                    <i class="bi bi-facebook"></i>
                                    View on Facebook
                                </a>
                            </div>` : ''}
                            <div class="mt-4">
                                <a href="/News" class="btn btn-secondary">
                                    <i class="bi bi-arrow-left"></i>
                                    Back to News
                                </a>
                            </div>
                        </div>
                    </div>`;
            } catch (e) {
                console.error('Error loading news:', e);
                document.getElementById('newsContainer').innerHTML = '<div class="alert alert-danger">Error loading news details.</div>';
            }
        }
        
        document.addEventListener('DOMContentLoaded', loadDetails);
    </script>
}
