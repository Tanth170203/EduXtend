@page
@model WebFE.Pages.Student.ProfileModel
@{
    ViewData["Title"] = "Profile";
    Layout = "~/Pages/Shared/_Layout.cshtml";
}

<div class="container py-4">
    <h2 class="mb-4">Personal Profile</h2>

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger">@Model.ErrorMessage</div>
    }
    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
    {
        <div class="alert alert-success">@Model.SuccessMessage</div>
    }
    <div id="clientSuccess" class="alert alert-success d-none">Changes saved successfully.</div>

    <div class="row g-4">
        <div class="col-lg-4">
			<div class="card shadow-sm h-100" style="overflow: visible;">
				<div class="card-body text-center p-4" style="overflow: visible;">
					<div class="mb-3 position-relative d-inline-block">
						<img id="profileAvatar" src="@(!string.IsNullOrWhiteSpace(Model.Form.AvatarUrl) ? Model.Form.AvatarUrl : "/images/default-avatar.png")" alt="Avatar" class="rounded-circle" style="width: 110px; height: 110px; object-fit: cover;" />
					</div>
					<div class="d-inline-flex flex-column align-items-center" style="gap: 2px; line-height: 1.1;">
						<h5 class="mb-0" style="line-height: 1.1;">
							<span id="profileNameView">@Model.Form.FullName</span>
						</h5>
						<div class="text-muted">@Model.Profile?.Email</div>
					</div>
                    <hr />
                    <div class="text-start small">
                        <div class="mb-1"><strong>Student ID:</strong> @Model.StudentId</div>
                        <div class="mb-1"><strong>Major:</strong> @Model.MajorName</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="card shadow-sm h-100">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">General Information</h5>
                        <button type="button" class="btn btn-primary btn-sm" onclick="openEditProfileModal()">
                            <i data-lucide="pencil" style="width: 16px; height: 16px;"></i>
                            Edit Profile
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped align-middle">
                            <tbody>
                                <tr>
                                    <td class="text-muted" style="width: 220px;">Student ID</td><td style="width: 20px;">:</td>
                                    <td>@Model.StudentId</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Major</td><td>:</td>
                                    <td>@Model.MajorName</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Date of Birth</td><td>:</td>
                                    <td>@(Model.DateOfBirth?.ToString("dd/MM/yyyy") ?? "-")</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Gender</td><td>:</td>
                                    <td>@(Model.Gender ?? "-")</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Cohort</td><td>:</td>
                                    <td>@(Model.Cohort ?? "-")</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Email</td><td>:</td>
                                    <td>@Model.Profile?.Email</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Phone number</td><td>:</td>
                                    <td><span id="profilePhoneView">@(Model.Form.PhoneNumber ?? "-")</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h5 class="mt-4">Other Information</h5>
                    <div class="mb-3">
                        <div class="text-muted mb-2">Roles:</div>
                        @if (Model.Roles?.Any() == true)
                        {
                            foreach (var r in Model.Roles)
                            {
                                <span class="badge bg-primary me-1">@r</span>
                            }
                        }
                        else
                        {
                            <span class="text-muted">-</span>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal" tabindex="-1" id="editProfileModal" style="display:none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Profile</h5>
                <button type="button" class="btn-close" onclick="closeEditProfileModal()"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editProfileAvatarInput" value="@Model.Form.AvatarUrl" />
                <div class="mb-3">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-control" id="editProfileName" value="@Model.Form.FullName" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Avatar</label>
                    <input type="file" class="form-control" id="editProfileAvatarFile" accept="image/*" />
                    <div id="editAvatarUploadStatus" class="small text-muted mt-1"></div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Phone Number</label>
                    <input type="text" class="form-control" id="editProfilePhone" value="@Model.Form.PhoneNumber" placeholder="0982486268" />
                    <div class="form-text">Phone number must be exactly 10 numbers.</div>
                    <div id="editPhoneError" class="text-danger small d-none">Phone number must be exactly 10 numbers.</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditProfileModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveProfile()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Small style for icon-only buttons -->
<style>
    .icon-btn { background: transparent; border: none; padding: 0; line-height: 1; color: inherit; }
    .icon-btn:focus { outline: none; box-shadow: none; }
    .icon-btn:hover { opacity: 0.8; }
</style>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // ===== Avatar file upload to Cloudinary (in modal) =====
        const editProfileAvatarFileInput = document.getElementById('editProfileAvatarFile');
        const editAvatarUploadStatus = document.getElementById('editAvatarUploadStatus');

        editProfileAvatarFileInput?.addEventListener('change', async (e) => {
            const file = e.target.files && e.target.files[0];
            if (!file) return;
            
            editAvatarUploadStatus.textContent = 'Uploading...';
            editAvatarUploadStatus.classList.remove('text-danger', 'text-success');
            editAvatarUploadStatus.classList.add('text-primary');

            try {
                const form = new FormData();
                form.append('file', file);
                
                console.log('Uploading avatar:', file.name);
                
                const res = await fetch(`${API_BASE_URL}/api/profile/upload-avatar`, {
                    method: 'POST',
                    body: form,
                    credentials: 'include'
                });
                
                console.log('Upload response status:', res.status);
                
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({ message: 'Upload failed' }));
                    console.error('Upload error:', errorData);
                    throw new Error(errorData.message || `Upload failed: ${res.status}`);
                }
                
                const data = await res.json();
                console.log('Upload response data:', data);
                
                if (!data.url) {
                    throw new Error('No URL returned from server');
                }

                // Set hidden field
                document.getElementById('editProfileAvatarInput').value = data.url;
                editAvatarUploadStatus.textContent = '✓ Uploaded successfully';
                editAvatarUploadStatus.classList.remove('text-primary', 'text-danger');
                editAvatarUploadStatus.classList.add('text-success');
            } catch (err) {
                console.error('Upload error:', err);
                editAvatarUploadStatus.textContent = '✗ ' + (err.message || 'Upload failed');
                editAvatarUploadStatus.classList.remove('text-primary', 'text-success');
                editAvatarUploadStatus.classList.add('text-danger');
                editProfileAvatarFileInput.value = '';
            }
        });

        function openEditProfileModal() {
            const modal = document.getElementById('editProfileModal');
            // Create backdrop
            const backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop fade show';
            backdrop.id = 'editProfileModalBackdrop';
            backdrop.onclick = closeEditProfileModal;
            document.body.appendChild(backdrop);
            
            modal.style.display = 'block';
            modal.classList.add('show');
            document.body.classList.add('modal-open');
            // Set current values
            document.getElementById('editProfileName').value = document.getElementById('profileNameView').textContent;
            const phoneText = document.getElementById('profilePhoneView').textContent;
            document.getElementById('editProfilePhone').value = phoneText === '-' ? '' : phoneText;
            document.getElementById('editProfileAvatarInput').value = document.getElementById('profileAvatar')?.src || '';
            document.getElementById('editAvatarUploadStatus').textContent = '';
            document.getElementById('editPhoneError').classList.add('d-none');
            if (window.lucide && typeof lucide.createIcons === 'function') {
                try { lucide.createIcons(); } catch {}
            }
        }

        function closeEditProfileModal() {
            const modal = document.getElementById('editProfileModal');
            const backdrop = document.getElementById('editProfileModalBackdrop');
            modal.classList.remove('show');
            if (backdrop) {
                backdrop.classList.remove('show');
                setTimeout(() => backdrop.remove(), 150);
            }
            setTimeout(() => {
                modal.style.display = 'none';
                document.body.classList.remove('modal-open');
            }, 150);
        }

        async function saveProfile() {
            try {
                const nameVal = document.getElementById('editProfileName').value?.trim() || '';
                const phoneVal = document.getElementById('editProfilePhone').value?.trim() || '';
                const avatarVal = document.getElementById('editProfileAvatarInput').value?.trim() || '';

                // Validate phone
                if (phoneVal && !/^\d{10}$/.test(phoneVal)) {
                    document.getElementById('editPhoneError').classList.remove('d-none');
                    return;
                }
                document.getElementById('editPhoneError').classList.add('d-none');

                const body = {
                    fullName: nameVal,
                    phoneNumber: phoneVal || null,
                    avatarUrl: avatarVal || null
                };

                const res = await fetch(`${API_BASE_URL}/api/profile`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!res.ok) {
                    let serverMsg = 'Failed to update profile';
                    try {
                        const errBody = await res.json();
                        if (errBody?.message) serverMsg = errBody.message;
                    } catch {}
                    throw new Error(serverMsg);
                }

                let updated = body;
                try {
                    const contentType = res.headers.get('content-type') || '';
                    if (res.status !== 204 && contentType.includes('application/json')) {
                        updated = await res.json();
                    }
                } catch {}

                // Update UI
                document.getElementById('profileNameView').textContent = updated.fullName || '';
                document.getElementById('profilePhoneView').textContent = updated.phoneNumber || '-';
                if (updated.avatarUrl) {
                    document.getElementById('profileAvatar').src = updated.avatarUrl;
                }

                if (typeof updateAuthUI === 'function') updateAuthUI();

                closeEditProfileModal();
                if (typeof success === 'function') {
                    success('Success', 'Profile updated successfully.', 3000);
                }
            } catch (e) {
                console.error(e);
                if (typeof error === 'function') {
                    error('Update failed', 'Failed to update profile. Please try again.', 5000);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // ensure header avatar/name sync on page load
            if (typeof updateAuthUI === 'function') {
                updateAuthUI();
            }
        });

        function showSuccess(message) {
            const el = document.getElementById('clientSuccess');
            if (!el) return;
            el.textContent = message || 'Changes saved successfully.';
            el.classList.remove('d-none');
            clearTimeout(window._clientSuccessTimer);
            window._clientSuccessTimer = setTimeout(() => el.classList.add('d-none'), 3000);
        }

        function setVisibility(idsToShow = [], idsToHide = []) {
            idsToShow.forEach(id => document.getElementById(id)?.classList.remove('d-none'));
            idsToHide.forEach(id => document.getElementById(id)?.classList.add('d-none'));
            if (window.lucide && typeof lucide.createIcons === 'function') {
                try {
                    const options = lucide.icons ? { icons: lucide.icons } : undefined;
                    lucide.createIcons(options);
                } catch (e) {
                    // no-op if lucide fails; icons are decorative only
                }
            }
        }

    </script>
}


