@page
@model WebFE.Pages.Student.MyEvidences.SubmitModel
@{
    ViewData["Title"] = "Submit Evidence";
    Layout = "~/Pages/Shared/_Layout.cshtml";
}

<section class="container my-5">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <div>
            <h1 class="fw-bold mb-1">Submit Evidence</h1>
            <p class="text-muted mb-0">Send evidence for the activity/criterion you participated in</p>
        </div>
        <a asp-page="/Student/MyEvidences/Index" class="btn btn-outline-secondary rounded-pill">
            <i class="bi bi-arrow-left"></i> Back to list
        </a>
    </div>

    <!-- Alerts -->
    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert">
            <i class="bi bi-exclamation-circle me-2"></i>@Model.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
    {
        <div class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
            <i class="bi bi-check-circle me-2"></i>@Model.SuccessMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Form -->
    <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-0 pt-4">
            <h5 class="mb-0 fw-semibold"><i class="bi bi-upload me-1"></i> Evidence information</h5>
            <small class="text-muted">Fill in the details and upload the evidence file.</small>
        </div>

        <div class="card-body pt-0">
            <form method="post" enctype="multipart/form-data" id="evidenceForm">
                <!-- Title -->
                <div class="mb-3">
                    <label asp-for="Input.Title" class="form-label fw-semibold">Title <span class="text-danger">*</span></label>
                    <input asp-for="Input.Title" class="form-control" placeholder="E.g.: Participated in Open Day 2025" required />
                    <span asp-validation-for="Input.Title" class="text-danger"></span>
                </div>

                <!-- Description -->
                <div class="mb-3">
                    <label asp-for="Input.Description" class="form-label fw-semibold">Detailed description</label>
                    <textarea asp-for="Input.Description" class="form-control" rows="4" placeholder="Describe the activity, your role, results..."></textarea>
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">Optional but helps faster approval</small>
                        <small class="text-muted"><span id="descCount">0</span>/1000 characters</small>
                    </div>
                </div>

                <!-- Criterion -->
                <div class="mb-3">
                    <label asp-for="Input.CriterionId" class="form-label fw-semibold">Activity criterion</label>
                    <select asp-for="Input.CriterionId" class="form-select">
                        <option value="">-- Select a matching criterion (optional) --</option>
                        @foreach (var c in Model.Criteria)
                        {
                            <option value="@c.Id">@c.Title (0-@c.MaxScore points)</option>
                        }
                    </select>
                    <span asp-validation-for="Input.CriterionId" class="text-danger"></span>
                    <div class="form-text">
                        <i class="bi bi-info-circle"></i>
                        Choose the criterion that best matches your evidence to make it easier for admins to review and award points.
                    </div>
                </div>

                <!-- File upload -->
                <div class="mb-3">
                    <label asp-for="Input.File" class="form-label fw-semibold">Evidence file</label>
                    <div id="dropzone" class="border rounded-3 p-4 text-center bg-light-subtle">
                        <i class="bi bi-cloud-upload" style="font-size:2rem;"></i>
                        <p class="mb-1">Drag & drop files here or click to choose</p>
                        <small class="text-muted">Formats: JPG, PNG, PDF, DOC, DOCX (Max 10MB)</small>
                        <input asp-for="Input.File" type="file" class="form-control d-none"
                               accept=".jpg,.jpeg,.png,.pdf,.doc,.docx" id="fileInput" />
                    </div>

                    <!-- Preview -->
                    <div id="filePreview" class="mt-3" style="display:none;">
                        <div class="alert alert-success d-flex align-items-center mb-0" role="alert">
                            <i class="bi bi-file-earmark-text me-2"></i>
                            <div>
                                <div class="fw-semibold">Selected file: <span id="fileName"></span></div>
                                <small class="text-muted">Size: <span id="fileSize"></span></small>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary ms-auto" type="button" id="changeFileBtn">
                                <i class="bi bi-arrow-repeat"></i> Change file
                            </button>
                        </div>
                    </div>
                    <span asp-validation-for="Input.File" class="text-danger"></span>
                </div>

                <!-- Note -->
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-1"></i>
                    <strong>Note:</strong> After submission, the evidence will be reviewed by the Student Affairs Office. Track the status in <em>“My Evidences”</em>.
                </div>

                <!-- Actions -->
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary rounded-pill" id="submitBtn">
                        <i class="bi bi-check2-circle"></i> <span id="submitText">Submit Evidence</span>
                        <span class="spinner-border spinner-border-sm ms-2" role="status" id="loadingSpinner" style="display:none;">
                            <span class="visually-hidden">Loading...</span>
                        </span>
                    </button>
                    <a asp-page="/Student/MyEvidences/Index" class="btn btn-outline-secondary rounded-pill">
                        <i class="bi bi-x-circle"></i> Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</section>

<style>
    #dropzone {
        cursor: pointer;
        border: 2px dashed var(--bs-border-color);
        transition: border-color .15s ease, background-color .15s ease;
    }

        #dropzone.dragover {
            background-color: rgba(13,110,253,.05);
            border-color: var(--bs-primary);
        }
</style>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Description count
        const desc=document.getElementById('Input_Description');
        const descCount=document.getElementById('descCount');
        if(desc&&descCount){ const up=()=>descCount.textContent=(desc.value||'').length; desc.addEventListener('input',up); up(); }

        // Dropzone
        const dz=document.getElementById('dropzone'), fi=document.getElementById('fileInput');
        const pv=document.getElementById('filePreview'), fn=document.getElementById('fileName'), fs=document.getElementById('fileSize');
        const changeBtn=document.getElementById('changeFileBtn');
        const maxSize=10*1024*1024, allowed=['.jpg','.jpeg','.png','.pdf','.doc','.docx'];
        const fmt=n=>{if(n===0)return'0 B';const k=1024,u=['B','KB','MB','GB'];const i=Math.floor(Math.log(n)/Math.log(k));return (n/Math.pow(k,i)).toFixed(2)+' '+u[i];};
        const valid=(f)=>{const ext=(f.name.match(/\.[^.]+$/)?.[0]||'').toLowerCase(); if(!allowed.includes(ext)){alert('Invalid file format.'); return false;}
                           if(f.size>maxSize){alert('File size exceeds 10MB.'); return false;} return true;};
        const show=(f)=>{fn.textContent=f.name; fs.textContent=fmt(f.size); pv.style.display='block';};

        dz.addEventListener('click',()=>fi.click());
        dz.addEventListener('dragover',e=>{e.preventDefault(); dz.classList.add('dragover');});
        dz.addEventListener('dragleave',()=>dz.classList.remove('dragover'));
        dz.addEventListener('drop',e=>{e.preventDefault(); dz.classList.remove('dragover'); const f=e.dataTransfer.files?.[0]; if(f&&valid(f)){ fi.files=e.dataTransfer.files; show(f); }});
        fi.addEventListener('change',e=>{const f=e.target.files?.[0]; if(f&&valid(f)) show(f);});
        changeBtn?.addEventListener('click',()=>fi.click());

        // Submit spinner
        const form=document.getElementById('evidenceForm');
        const btn=document.getElementById('submitBtn'), text=document.getElementById('submitText'), sp=document.getElementById('loadingSpinner');
        form.addEventListener('submit',()=>{ btn.disabled=true; text.textContent='Uploading...'; sp.style.display='inline-block'; });
    </script>
}
